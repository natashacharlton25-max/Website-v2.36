---
import BaseLayout from '../Layouts/BaseLayout.astro';
import FooterWithMask from '../components/Footer/FooterWithMask.astro';
import IsotopeFilterSwitcher from '../components/Switcher/IsotopeFilterSwitcher.astro';
import HeroSection from '../components/Sections/HeroSection.astro';
import InsightCard from '../components/Cards/InsightCard.astro';
import { getCollection } from 'astro:content';

// Import data
import heroDataRaw from '../data/insights/hero.json';
import filterCategoriesBase from '../data/insights/filters.json';

// Type assertions for JSON imports
const heroData = heroDataRaw as {
  title: string;
  subtitle: string;
  description: string;
  extraText: string;
  variant: 'simple' | 'image' | 'gradient';
};

// Helper to get folder slug from entry.id (handles index.md suffix and path separators)
const getSlug = (id: string) => {
  const normalized = id.replace(/[\\/]index\.md$/, '');
  return normalized.split(/[\\/]/).pop() || id;
};

// Get all published insights posts
const allInsights = await getCollection('insights');

// Get presentations that should show in insights listing
const allPresentations = await getCollection('presentations');
const insightPresentations = allPresentations.filter(
  entry => entry.data.showIn?.includes('insights')
);

// Map insights to article format
const insightArticles = allInsights.map((entry) => {
  // Calculate approximate read time based on content length
  const wordsPerMinute = 200;
  const wordCount = entry.body.split(/\s+/).length;
  const readTime = Math.ceil(wordCount / wordsPerMinute);

  return {
    slug: getSlug(entry.id),
    title: entry.data.title,
    excerpt: entry.data.description,
    cardImage: entry.data.cardImage,
    category: entry.data.category,
    readTime: `${readTime} min read`,
    publishDate: entry.data.publishDate,
    type: 'insight' as const,
  };
});

// Map presentations to article format
const presentationArticles = insightPresentations.map((entry) => {
  // Presentations don't have traditional read time, show section count instead
  const sectionCount = entry.data.sections?.length || 0;

  return {
    slug: getSlug(entry.id),
    title: entry.data.title,
    excerpt: entry.data.description,
    cardImage: entry.data.cardImage,
    category: entry.data.category,
    readTime: `${sectionCount} sections`,
    publishDate: entry.data.publishDate || '',
    type: 'presentation' as const,
  };
});

// Merge and sort by publish date (newest first)
const articles = [...insightArticles, ...presentationArticles]
  .sort((a, b) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());

// Get unique categories from articles and merge with base filters
const categories = [...new Set(articles.map(a => a.category))];
const dynamicFilters = categories.map(cat => ({
  id: cat.toLowerCase().replace(/\s+/g, '-'),
  label: cat,
}));
const filterCategories = [...filterCategoriesBase, ...dynamicFilters];
---

<BaseLayout
  title="Insights | Walking With A Smile"
  description="Honest perspectives on self-direction, boundaries, and wellbeing. Practical insights for building a life that feels like yours."
  hideFooter={true}
>
  <!-- Hero Section -->
  <HeroSection
    title={heroData.title}
    subtitle={heroData.subtitle}
    description={heroData.description}
    extraText={heroData.extraText}
    variant={heroData.variant}
  />

  <!-- Filter Tags -->
  <section class="filter-section">
    <IsotopeFilterSwitcher
      tabs={filterCategories}
      defaultActive="all"
      gridSelector="#insights-grid"
      itemSelector=".insight-card"
    />
  </section>

  <!-- Insights Grid Section -->
  <section class="insights-section section">
    <div class="container container-7xl">
      <div class="insights-grid" id="insights-grid">
        <!-- Grid sizer for Isotope column width calculation -->
        <div class="grid__sizer"></div>

        {articles.map((article) => (
          <InsightCard
            slug={article.slug}
            title={article.title}
            excerpt={article.excerpt}
            cardImage={article.cardImage}
            category={article.category}
            readTime={article.readTime}
            type={article.type}
          />
        ))}
      </div>
    </div>
  </section>

  <!-- Footer with Interactive Mask -->
  <FooterWithMask
    backgroundImage="/Footer/Footer-Reveal.png"
  />
</BaseLayout>
