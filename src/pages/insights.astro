---
import BaseLayout from '../layouts/BaseLayout.astro';
import FooterWithMask from '../components/sections/FooterWithMask.astro';
import IsotopeFilterSwitcher from '../components/ui/IsotopeFilterSwitcher.astro';
import { getCollection } from 'astro:content';

// Helper to get folder slug from entry.id (handles index.md suffix and path separators)
const getSlug = (id: string) => {
  const normalized = id.replace(/[\\/]index\.md$/, '');
  return normalized.split(/[\\/]/).pop() || id;
};

// Get all published insights posts
const allInsights = await getCollection('insights');

// Get presentations that should show in insights listing
const allPresentations = await getCollection('presentations');
const insightPresentations = allPresentations.filter(
  entry => entry.data.showIn?.includes('insights')
);

// Map insights to article format
const insightArticles = allInsights.map((entry) => {
  // Calculate approximate read time based on content length
  const wordsPerMinute = 200;
  const wordCount = entry.body.split(/\s+/).length;
  const readTime = Math.ceil(wordCount / wordsPerMinute);

  return {
    slug: getSlug(entry.id),
    title: entry.data.title,
    excerpt: entry.data.description,
    cardImage: entry.data.cardImage,
    category: entry.data.category,
    readTime: `${readTime} min read`,
    publishDate: entry.data.publishDate,
    type: 'insight' as const,
  };
});

// Map presentations to article format
const presentationArticles = insightPresentations.map((entry) => {
  // Presentations don't have traditional read time, show section count instead
  const sectionCount = entry.data.sections?.length || 0;

  return {
    slug: getSlug(entry.id),
    title: entry.data.title,
    excerpt: entry.data.description,
    cardImage: entry.data.cardImage,
    category: entry.data.category,
    readTime: `${sectionCount} sections`,
    publishDate: entry.data.publishDate || '',
    type: 'presentation' as const,
  };
});

// Merge and sort by publish date (newest first)
const articles = [...insightArticles, ...presentationArticles]
  .sort((a, b) => new Date(b.publishDate).getTime() - new Date(a.publishDate).getTime());

// Get unique categories for filter
const categories = ['all', ...new Set(articles.map(a => a.category))];
const filterCategories = categories.map(cat => ({
  id: cat === 'all' ? 'all' : cat.toLowerCase().replace(/\s+/g, '-'),
  label: cat === 'all' ? 'All' : cat,
}));
---

<BaseLayout
  title="Insights | Walking With A Smile"
  description="Honest perspectives on self-direction, boundaries, and wellbeing. Practical insights for building a life that feels like yours."
  hideFooter={true}
>
  <!-- Hero Section -->
  <section class="insights-hero bg-alt">
    <div class="container container-6xl">
      <div class="hero-content">
        <h1 class="hero-title">Insights</h1>
        <p class="hero-subtitle">Honest perspectives on building a life that feels like yours.</p>
        <div class="hero-text">
          <p>
            No fluff. No empty positivity. Just practical insights and honest perspectives on building a life that actually feels like yours.
          </p>
          <p>
            These articles explore boundaries, self-direction, emotional wellbeing, and what it really takes to show up for yourself. Take what resonates. Leave what doesn't.
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Filter Tags -->
  <section class="filter-section bg-alt">
    <IsotopeFilterSwitcher
      tabs={filterCategories}
      defaultActive="all"
      gridSelector="#articles-grid"
      itemSelector=".article-card"
    />
  </section>

  <!-- Articles Grid Section -->
  <section class="articles-section section bg-alt">
    <div class="container container-7xl">
      <div class="articles-grid" id="articles-grid">
        <!-- Grid sizer for Isotope column width calculation -->
        <div class="grid__sizer"></div>

        {articles.map((article) => (
          <a
            href={article.type === 'presentation' ? `/presentations/${article.slug}` : `/insights/${article.slug}`}
            class={`article-card ${article.category.toLowerCase().replace(/\s+/g, '-')}`}
            data-category={article.category.toLowerCase().replace(/\s+/g, '-')}
          >
            <div class="article-image">
              <img src={article.cardImage.src} alt={article.title} loading="lazy" />
              <div class="article-category-badge">{article.category}</div>
            </div>
            <div class="article-content">
              <div class="article-meta">
                <span class="read-time">{article.readTime}</span>
              </div>
              <h2 class="article-title">{article.title}</h2>
              <p class="article-excerpt">{article.excerpt}</p>
              <span class="read-more">
                {article.type === 'presentation' ? 'View Presentation' : 'Read Article'}
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="5" y1="12" x2="19" y2="12"></line>
                  <polyline points="12 5 19 12 12 19"></polyline>
                </svg>
              </span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Footer with Interactive Mask -->
  <FooterWithMask
    backgroundImage="/Footer/Footer-Reveal.png"
  />
</BaseLayout>

<style>
  /* Common styles */
  .section {
    padding: var(--space-5xl) 0;
  }

  /* Hero Section - uses bg-alt class for background */
  .insights-hero {
    position: relative;
    width: 100%;
    padding-top: calc(100px + var(--space-3xl));
    padding-bottom: var(--space-4xl);
  }

  .hero-content {
    text-align: left;
    max-width: 800px;
  }

  .hero-title {
    font-size: clamp(3rem, 8vw, 8rem);
    font-weight: var(--font-extrabold);
    margin-bottom: var(--space-lg);
    font-family: var(--font-heading);
    line-height: 0.95;
    letter-spacing: -0.02em;
  }

  .hero-subtitle {
    font-size: var(--text-2xl);
    color: var(--color-Text-600);
    font-style: italic;
    font-family: var(--font-heading);
    font-weight: var(--font-medium);
    margin-bottom: var(--space-xl);
  }

  .hero-text {
    max-width: 700px;
  }

  .hero-text p {
    font-size: var(--text-base);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-md);
  }

  /* Filter Section - uses bg-alt class for background */
  .filter-section {
    padding: var(--space-4xl) 0 var(--space-2xl);
    display: flex;
    justify-content: center;
  }

  /* Articles Section */
  .articles-section {
    padding: var(--space-2xl) 0 var(--space-5xl);
    width: 100%;
    overflow-x: hidden; /* Prevent horizontal scrollbar during Isotope animations */
  }

  /* Articles Grid - Isotope masonry layout */
  .articles-grid {
    margin-bottom: 0;
    position: relative;
    width: 100%;
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
    overflow-x: hidden; /* Prevent horizontal scrollbar during filtering */
  }

  /* Loading state - hide grid while images load */
  .articles-grid.grid--loading {
    opacity: 0;
  }

  /* Clear floats after grid */
  .articles-grid::after {
    content: '';
    display: block;
    clear: both;
  }

  /* Grid sizer for Isotope column width calculation */
  .grid__sizer {
    width: 33.333%;
    height: 0;
    visibility: hidden;
  }

  /* Article Card - float-based layout for Isotope masonry */
  .article-card {
    float: left;
    width: calc(33.333% - 1.5em - 4px); /* Subtract 4px for 2px border on each side */
    margin: 0.75em;
    padding: var(--space-md);
    padding-bottom: 0; /* Content section has its own padding */
    box-sizing: border-box;
    overflow: hidden;
    text-decoration: none;
    display: flex;
    flex-direction: column;
    color: inherit;
    background: var(--color-Secondary-100);
    border-radius: var(--border-radius-lg);
    border: 2px solid transparent; /* Transparent border so all cards have same dimensions */
    transition: box-shadow var(--transition-base);
  }

  .article-card:hover {
    box-shadow: inset 0 0 20px 8px rgba(0, 0, 0, 0.06);
  }

  .article-image {
    position: relative;
    width: 100%;
    aspect-ratio: 16 / 10;
    overflow: hidden;
    background: var(--color-Neutral-100);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-sm);
  }

  .article-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }


  .article-category-badge {
    position: absolute;
    top: var(--space-md);
    left: var(--space-md);
    padding: var(--space-xs) var(--space-md);
    background: var(--color-Primary-600);
    color: white;
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    border-radius: var(--border-radius-full);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .article-content {
    padding: var(--space-xl);
    display: flex;
    flex-direction: column;
    flex: 1;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-sm);
  }

  .read-time {
    font-size: var(--text-sm);
    color: var(--color-Text-500);
  }

  .article-title {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    margin-bottom: var(--space-md);
    font-family: var(--font-heading);
    line-height: 1.3;
  }

  .article-excerpt {
    font-size: var(--text-base);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-lg);
    flex: 1;
  }

  .read-more {
    display: inline-flex;
    align-items: center;
    gap: var(--space-sm);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--color-Primary-600);
    transition: color var(--transition-fast);
  }

  .read-more svg {
    transition: transform var(--transition-fast);
  }

  .article-card:hover .article-image {
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .article-card:hover .read-more {
    color: var(--color-Primary-700);
  }

  .article-card:hover .read-more svg {
    transform: translateX(4px);
  }

  /* Responsive: 2 columns on tablet */
  @media (max-width: 1200px) {
    .grid__sizer {
      width: 50%;
    }
    .article-card {
      width: calc(50% - 1.5em - 4px); /* Account for borders */
    }
  }

  @media (max-width: 767px) {
    .section {
      padding: var(--space-3xl) 0;
    }

    .filter-section {
      padding: var(--space-3xl) 0 var(--space-xl);
    }

    .insights-hero {
      padding-top: calc(80px + var(--space-2xl));
      padding-bottom: var(--space-3xl);
    }

    .hero-title {
      font-size: clamp(2.5rem, 10vw, 4rem);
      line-height: 1;
    }

    .hero-subtitle {
      font-size: var(--text-lg);
    }

    .hero-text p {
      font-size: var(--text-sm);
    }

    .grid__sizer {
      width: 100%;
    }
    .article-card {
      width: calc(100% - 1.5em - 4px); /* Account for borders */
    }

    .article-content {
      padding: var(--space-lg);
    }
  }

  @media (max-width: 640px) {
    .filter-section {
      padding: var(--space-2xl) 0 var(--space-lg);
    }

    .insights-hero {
      padding-top: calc(80px + var(--space-xl));
      padding-bottom: var(--space-2xl);
    }

    .hero-title {
      font-size: clamp(2rem, 12vw, 2.5rem);
    }

    .hero-subtitle {
      font-size: var(--text-base);
    }

    .hero-text p {
      font-size: var(--text-sm);
    }
  }

  @media (max-width: 480px) {
    .filter-section {
      padding: var(--space-xl) 0 var(--space-md);
    }

    .article-content {
      padding: var(--space-md);
    }
  }

  @media (max-width: 250px) {
    .insights-hero {
      padding-top: calc(70px + var(--space-lg));
      padding-bottom: var(--space-xl);
    }

    .hero-title {
      font-size: var(--text-2xl);
    }

    .hero-subtitle {
      font-size: var(--text-sm);
    }

    .hero-text p {
      font-size: var(--text-xs);
    }

    .article-content {
      padding: var(--space-sm);
    }

    .article-title {
      font-size: var(--text-lg);
    }

    .article-excerpt {
      font-size: var(--text-sm);
    }
  }

  /* =========================================================
     ACCESSIBILITY THEME OVERRIDES
     ========================================================= */

  /* Dark mode: Transparent card with white text and accent border */
  body.a11y-theme-dark .article-card {
    background: transparent !important;
    border: 2px solid var(--a11y-dark-accent) !important;
  }

  body.a11y-theme-dark .article-card .article-title,
  body.a11y-theme-dark .article-card .article-excerpt,
  body.a11y-theme-dark .article-card .read-time {
    color: var(--a11y-dark-text) !important;
  }

  body.a11y-theme-dark .article-card .read-more {
    color: var(--a11y-dark-accent) !important;
  }

  body.a11y-theme-dark .article-category-badge {
    background: var(--a11y-dark-accent) !important;
    color: var(--a11y-dark-bg) !important;
  }

  body.a11y-theme-dark .article-image img {
    filter: brightness(var(--media-brightness, 0.86))
            saturate(var(--media-saturation, 0.90))
            contrast(var(--media-contrast, 0.98));
  }

  /* High Contrast: Pure white card for maximum contrast with black text */
  body.a11y-theme-high-contrast .article-card {
    background: #ffffff !important;
    border: 2px solid var(--a11y-hc-accent) !important;
  }

  body.a11y-theme-high-contrast .article-card .article-title,
  body.a11y-theme-high-contrast .article-card .article-excerpt,
  body.a11y-theme-high-contrast .article-card .read-time {
    color: #000000 !important;
  }

  body.a11y-theme-high-contrast .article-card .read-more {
    color: var(--a11y-hc-accent) !important;
  }

  body.a11y-theme-high-contrast .article-category-badge {
    background: var(--a11y-hc-accent) !important;
    color: #ffffff !important;
  }

  body.a11y-theme-high-contrast .article-image img {
    filter: brightness(var(--media-brightness, 0.86))
            saturate(var(--media-saturation, 0.90))
            contrast(var(--media-contrast, 0.98));
  }

  /* Cream theme: Cream background with accent border */
  body.a11y-theme-cream .article-card {
    background: var(--a11y-cream-bg) !important;
    border: 2px solid var(--a11y-cream-accent) !important;
  }

  body.a11y-theme-cream .article-card .article-title,
  body.a11y-theme-cream .article-card .article-excerpt {
    color: var(--a11y-cream-text) !important;
  }

  body.a11y-theme-cream .article-card .read-time {
    color: var(--a11y-cream-accent) !important;
  }

  body.a11y-theme-cream .article-card .read-more {
    color: var(--a11y-cream-accent) !important;
  }

  body.a11y-theme-cream .article-category-badge {
    background: var(--a11y-cream-accent) !important;
    color: #ffffff !important;
  }

  /* Monochrome theme: Monochrome background with dark border and text */
  body.a11y-theme-monochrome .article-card,
  body.a11y-cvd-monochrome .article-card {
    background: var(--a11y-mono-bg-100) !important;
    border: 2px solid #333333 !important;
  }

  body.a11y-theme-monochrome .article-card .article-title,
  body.a11y-theme-monochrome .article-card .article-excerpt,
  body.a11y-theme-monochrome .article-card .read-time,
  body.a11y-cvd-monochrome .article-card .article-title,
  body.a11y-cvd-monochrome .article-card .article-excerpt,
  body.a11y-cvd-monochrome .article-card .read-time {
    color: #333333 !important;
  }

  body.a11y-theme-monochrome .article-card .read-more,
  body.a11y-cvd-monochrome .article-card .read-more {
    color: #333333 !important;
  }

  body.a11y-theme-monochrome .article-category-badge,
  body.a11y-cvd-monochrome .article-category-badge {
    background: #333333 !important;
    color: #ffffff !important;
  }

  /* CVD Color Blind modes: Transparent cards with primary border */
  body.a11y-theme-protanopia .article-card,
  body.a11y-theme-deuteranopia .article-card,
  body.a11y-theme-tritanopia .article-card,
  body.a11y-cvd-protanopia .article-card,
  body.a11y-cvd-deuteranopia .article-card,
  body.a11y-cvd-tritanopia .article-card {
    background: transparent !important;
    border: 2px solid var(--color-Primary-600) !important;
  }

  body.a11y-theme-protanopia .article-card .article-title,
  body.a11y-theme-protanopia .article-card .article-excerpt,
  body.a11y-theme-deuteranopia .article-card .article-title,
  body.a11y-theme-deuteranopia .article-card .article-excerpt,
  body.a11y-theme-tritanopia .article-card .article-title,
  body.a11y-theme-tritanopia .article-card .article-excerpt,
  body.a11y-cvd-protanopia .article-card .article-title,
  body.a11y-cvd-protanopia .article-card .article-excerpt,
  body.a11y-cvd-deuteranopia .article-card .article-title,
  body.a11y-cvd-deuteranopia .article-card .article-excerpt,
  body.a11y-cvd-tritanopia .article-card .article-title,
  body.a11y-cvd-tritanopia .article-card .article-excerpt {
    color: #000000 !important;
  }

  body.a11y-theme-protanopia .article-card .read-time,
  body.a11y-theme-protanopia .article-card .read-more,
  body.a11y-theme-deuteranopia .article-card .read-time,
  body.a11y-theme-deuteranopia .article-card .read-more,
  body.a11y-theme-tritanopia .article-card .read-time,
  body.a11y-theme-tritanopia .article-card .read-more,
  body.a11y-cvd-protanopia .article-card .read-time,
  body.a11y-cvd-protanopia .article-card .read-more,
  body.a11y-cvd-deuteranopia .article-card .read-time,
  body.a11y-cvd-deuteranopia .article-card .read-more,
  body.a11y-cvd-tritanopia .article-card .read-time,
  body.a11y-cvd-tritanopia .article-card .read-more {
    color: var(--color-Primary-600) !important;
  }

  body.a11y-theme-protanopia .article-category-badge,
  body.a11y-theme-deuteranopia .article-category-badge,
  body.a11y-theme-tritanopia .article-category-badge,
  body.a11y-cvd-protanopia .article-category-badge,
  body.a11y-cvd-deuteranopia .article-category-badge,
  body.a11y-cvd-tritanopia .article-category-badge {
    background: var(--color-Primary-600) !important;
    color: #ffffff !important;
  }
</style>
