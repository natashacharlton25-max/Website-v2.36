---
import BaseLayout from '../../Layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import Reader from '../../components/Presentation/Reader.astro';
import ReaderNav from '../../components/Presentation/ReaderNav.astro';
import PresentationEndSection from '../../components/Presentation/PresentationEndSection.astro';
import FooterWithMask from '../../components/Footer/FooterWithMask.astro';

// Helper to get folder slug from entry.id
const getSlug = (id: string) => {
  const normalized = id.replace(/[\\/]index\.md$/, '');
  return normalized.split(/[\\/]/).pop() || id;
};

export async function getStaticPaths() {
  const presentations = await getCollection('presentations');
  return presentations.map((entry) => ({
    params: { slug: getSlug(entry.id) },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const presentation = entry.data;
const currentSlug = getSlug(entry.id);

// Get author data if specified
let author = null;
if (presentation.author) {
  const allAuthors = await getCollection('authors');
  const authorEntry = allAuthors.find(a => getSlug(a.id) === presentation.author);
  if (authorEntry) {
    author = {
      name: authorEntry.data.name,
      photo: authorEntry.data.photo,
      role: authorEntry.data.role,
      bio: authorEntry.data.bio,
    };
  }
}

// Get recommended presentations (same category, excluding current)
const allPresentations = await getCollection('presentations');
const recommendedPresentations = allPresentations
  .filter(p => getSlug(p.id) !== currentSlug && p.data.category === presentation.category)
  .slice(0, 3)
  .map(p => ({
    slug: getSlug(p.id),
    title: p.data.title,
    category: p.data.category,
    image: p.data.cardImage,
  }));

// Build hero section for Reader
const heroSection = {
  title: presentation.hero?.title || presentation.title,
  description: presentation.hero?.description || presentation.description,
  image: (presentation.hero?.image?.src || presentation.cardImage.src) as string,
  category: presentation.hero?.showCategory !== false ? presentation.category : undefined,
  date: presentation.hero?.showDate !== false ? presentation.publishDate : undefined,
};

// Transform sections to extract .src from processed image objects
const transformedSections = presentation.sections.map(section => ({
  id: section.id,
  title: section.title,
  body: section.body,
  alignment: section.alignment,
  layout: section.layout,
  image: section.image?.src as string | undefined,
  imagePosition: section.imagePosition,
}));

// Determine what to show in end section
const showAuthor = presentation.endSection?.showAuthor !== false && author;
const showRecommended = presentation.endSection?.showRecommended !== false && recommendedPresentations.length > 0;
const hasEndContent = showAuthor || showRecommended || presentation.linkedAssets?.length || presentation.endSection?.customHtml;

// Build nav sections for ReaderNav
const navSections = [
  { id: 'hero', title: heroSection.title },
  ...presentation.sections.map(s => ({ id: s.id, title: s.title })),
];

if (hasEndContent) {
  navSections.push({ id: 'end', title: 'Continue' });
}
---

<BaseLayout
  title={presentation.seoTitle || presentation.title}
  description={presentation.seoDescription || presentation.description}
  image={presentation.cardImage.src}
  hideFooter={true}
>
  <Reader
    sections={transformedSections}
    heroSection={heroSection}
  />

  {hasEndContent && (
    <PresentationEndSection
      author={showAuthor ? author : undefined}
      linkedAssets={presentation.linkedAssets}
      recommendedItems={showRecommended ? recommendedPresentations : undefined}
      customHtml={presentation.endSection?.customHtml}
    />
  )}

  <ReaderNav
    sections={navSections}
    position="bottom-right"
    variant="detailed"
    background="glass"
    foreground="light"
  />

  <FooterWithMask />
</BaseLayout>
