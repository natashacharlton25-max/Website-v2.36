---
/**
 * Insight/Blog Post Page
 * Dynamic page for individual insight articles
 */
import BaseLayout from '../../Layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import InsightHeader from '../../components/Insights/InsightHeader.astro';
import InsightContent from '../../components/Insights/InsightContent.astro';
import TagList from '../../components/Insights/TagList.astro';
import InsightAuthorSection from '../../components/Insights/InsightAuthorSection.astro';
import RelatedGrid from '../../components/Grids/RelatedGrid.astro';
import FooterWithMask from '../../components/Footer/FooterWithMask.astro';
import {
  getSuggestedContent,
  formatForRelatedGrid,
  getSlugFromId
} from '../../lib/utils/related-content';

export async function getStaticPaths() {
  const insights = await getCollection('insights');
  return insights.map((entry) => ({
    params: { slug: getSlugFromId(entry.id) },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { linkedAssets } = entry.data;

// Get author data from authors collection
const authorSlug = entry.data.author;
const allAuthors = await getCollection('authors');
const authorEntry = allAuthors.find(a => getSlugFromId(a.id) === authorSlug);
const author = authorEntry?.data;

// Get suggested posts using smart content matching
// Priority: tag similarity > same category > latest posts (fallback)
const allInsights = await getCollection('insights');
const suggestedEntries = getSuggestedContent(entry, allInsights, {
  maxItems: 3,
  getSlug: (item) => getSlugFromId(item.id)
});
const suggestedPosts = formatForRelatedGrid(suggestedEntries, (item) => getSlugFromId(item.id));

// Format linked assets for RelatedGrid
const formattedResources = linkedAssets?.map((asset: { title: string; description?: string; url: string; type?: string }) => ({
  title: asset.title,
  description: asset.description,
  url: asset.url,
  type: asset.type || 'Resource'
})) || [];
---

<BaseLayout
  title={entry.data.seoTitle || entry.data.title}
  description={entry.data.seoDescription || entry.data.description}
  image={entry.data.cardImage.src}
  hideFooter={true}
>
  <article class="insight-article">
    <InsightHeader
      title={entry.data.title}
      description={entry.data.description}
      category={entry.data.category}
      publishDate={entry.data.publishDate}
      authorName={author?.name || entry.data.author}
      heroImage={entry.data.cardImage}
    />

    <InsightContent>
      <Content />
    </InsightContent>

    {entry.data.tags && entry.data.tags.length > 0 && (
      <TagList tags={entry.data.tags} />
    )}
  </article>

  {author && (
    <InsightAuthorSection
      name={author.name}
      photo={author.photo}
      role={author.role}
      bio={author.bio}
    />
  )}

  {formattedResources.length > 0 && (
    <RelatedGrid
      items={formattedResources}
      contentType="resources"
      title="Recommended Resources"
      cardStyle="minimal"
      background="light"
      containerSize="6xl"
    />
  )}

  {suggestedPosts.length > 0 && (
    <RelatedGrid
      items={suggestedPosts}
      contentType="posts"
      title="You Might Also Like"
      basePath="/insights"
      cardStyle="vertical"
      background="default"
    />
  )}

  <FooterWithMask />
</BaseLayout>

<style>
  /* Visual */
  .insight-article {
    background: var(--color-Background-100);
  }
</style>
