---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import Reader from '../../components/reader/Reader.astro';
import ReaderNav from '../../components/reader/ReaderNav.astro';
import FooterWithMask from '../../components/sections/FooterWithMask.astro';

export async function getStaticPaths() {
  const insights = await getCollection('insights');
  return insights.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const { enableReader, readerSections, linkedAssets } = entry.data;

// Get suggested posts (same category, excluding current)
const allInsights = await getCollection('insights');
const suggestedPosts = allInsights
  .filter(post => post.slug !== entry.slug && post.data.category === entry.data.category)
  .slice(0, 3);
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  image={entry.data.image}
  hideFooter={true}
>
  {
    enableReader && readerSections ? (
      <>
        {/* Blog Hero - NOT part of Reader tracking */}
        <section class="blog-hero">
          <div class="hero-image-container">
            <img src={entry.data.image} alt={entry.data.title} />
          </div>
          <div class="hero-overlay">
            <div class="container container-6xl">
              <div class="hero-meta">
                <span class="hero-category">{entry.data.category}</span>
                <span class="hero-date">{entry.data.publishDate}</span>
              </div>
              <h1 class="hero-title">{entry.data.title}</h1>
              <p class="hero-description">{entry.data.description}</p>
            </div>
          </div>
        </section>

        {/* Reader Mode: Scroll-driven storytelling */}
        <Reader sections={readerSections} />
        <ReaderNav
          sections={readerSections.map((s) => ({ id: s.id, title: s.title }))}
          position="top-left"
          variant="detailed"
          background="glass"
          foreground="dark"
        />

        {/* About the Author - NOT part of Reader tracking */}
        <section class="about-author">
          <div class="container container-6xl">
            <div class="author-card">
              <div class="author-image">
                <img src="/me.png" alt="Natasha Charlton" />
              </div>
              <div class="author-content">
                <div class="author-header">
                  <div>
                    <h2 class="author-heading">About the Author</h2>
                    <h3 class="author-name">Natasha Charlton</h3>
                  </div>
                </div>
                <div class="author-bio-wrapper">
                  <p class="author-bio">
                    Natasha Charlton has over two decades of experience supporting
                    people with mental health challenges and CPTSD recovery. She
                    has particular experience in supporting autistic people, low
                    mood and emotional wellbeing, and addiction. Alongside her professional background, Natasha also brings
                    lived experience of therapy and healing. She shares gentle,
                    relatable guidance that is practical, human, and judgement
                    free, with the intention of helping you feel supported,
                    understood, and a little less alone.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        {/* Linked Assets Section */}
        {linkedAssets && linkedAssets.length > 0 && (
          <section class="linked-assets">
            <div class="container container-6xl">
              <h2 class="section-heading">Recommended for you</h2>
              <div class="assets-grid">
                {linkedAssets.map(asset => (
                  <a href={asset.url} class="asset-card">
                    <div class="asset-card-content">
                      {asset.type && (
                        <div class={`asset-badge badge-${asset.type}`}>
                          {asset.type.charAt(0).toUpperCase() + asset.type.slice(1)}
                        </div>
                      )}
                      <h3 class="asset-title">{asset.title}</h3>
                      {asset.description && (
                        <p class="asset-description">{asset.description}</p>
                      )}
                      <span class="asset-link-text">View Resource â†’</span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          </section>
        )}

        {/* Suggested Posts Section */}
        {suggestedPosts.length > 0 && (
          <section class="suggested-posts">
            <div class="container container-6xl">
              <h2 class="section-heading">More in {entry.data.category}</h2>
              <div class="posts-grid">
                {suggestedPosts.map(post => (
                  <a href={`/insights/${post.slug}`} class="post-card">
                    {post.data.image && (
                      <div class="post-card-image">
                        <img src={post.data.image} alt={post.data.title} />
                      </div>
                    )}
                    <div class="post-card-content">
                      <span class="post-card-category">{post.data.category}</span>
                      <h3 class="post-card-title">{post.data.title}</h3>
                      <p class="post-card-description">{post.data.description}</p>
                      <span class="post-card-date">{post.data.publishDate}</span>
                    </div>
                  </a>
                ))}
              </div>
            </div>
          </section>
        )}

        {/* Footer section - NOT part of Reader tracking */}
        <FooterWithMask backgroundImage="/Footer/Footer-Reveal.png" height="400px" />
      </>
    ) : (
      <>
        {/* Traditional Blog Layout */}
        <article class="traditional-post">
          <header class="post-header">
            <div class="container container-6xl">
              <div class="post-meta">
                <span class="post-category">{entry.data.category}</span>
                <span class="post-date">{entry.data.publishDate}</span>
                <span class="post-author">By {entry.data.author}</span>
              </div>
              <h1 class="post-title">{entry.data.title}</h1>
              <p class="post-description">{entry.data.description}</p>
            </div>
          </header>

          {entry.data.image && (
            <div class="post-hero-image">
              <img src={entry.data.image} alt={entry.data.title} />
            </div>
          )}

          <div class="post-content">
            <div class="container container-4xl">
              <Content />
            </div>
          </div>

          {entry.data.tags && entry.data.tags.length > 0 && (
            <footer class="post-footer">
              <div class="container container-4xl">
                <div class="post-tags">
                  {entry.data.tags.map((tag) => (
                    <span class="tag">{tag}</span>
                  ))}
                </div>
              </div>
            </footer>
          )}
        </article>
      </>
    )
  }
</BaseLayout>

<style>
  /* ===== BLOG HERO (Reader Mode) ===== */
  .blog-hero {
    position: relative;
    width: 100%;
    height: 100vh;
    overflow: hidden;
    background-color: var(--color-Neutral-500);
  }

  .hero-image-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1;
  }

  .hero-image-container img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
  }

  .hero-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 2;
    background: linear-gradient(
      to bottom,
      transparent 0%,
      color-mix(in srgb, var(--color-Neutral-500) 60%, transparent) 40%,
      var(--color-Neutral-500) 100%
    );
    display: flex;
    align-items: center;
    padding: var(--space-5xl) 0;
  }

  .hero-meta {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
  }

  .hero-category {
    padding: var(--space-xs) var(--space-md);
    background: var(--color-Primary-600);
    color: white;
    border-radius: var(--border-radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  .hero-date {
    color: var(--color-Text-600);
    font-size: var(--text-sm);
  }

  .hero-title {
    font-family: var(--font-heading);
    font-size: var(--text-5xl);
    font-weight: var(--font-extrabold);
    color: var(--color-Text-900);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-md);
    max-width: 1000px;
  }

  .hero-description {
    font-size: var(--text-xl);
    color: var(--color-Text-700);
    line-height: var(--leading-relaxed);
    max-width: 800px;
    font-style: italic;
  }

  /* ===== ABOUT AUTHOR (Reader Mode) ===== */
  .about-author {
    padding: var(--space-4xl) 0;
    background-color: var(--color-Neutral-500);
  }

  .author-card {
    display: flex;
    align-items: center;
    gap: var(--space-2xl);
    padding: var(--space-2xl) var(--space-3xl);
    background: var(--color-Secondary-100);
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-lg);
  }

  .author-image {
    flex-shrink: 0;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    overflow: hidden;
    box-shadow: var(--shadow-md);
  }

  .author-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .author-content {
    flex: 1;
  }

  .author-header {
    margin-bottom: var(--space-md);
  }

  .author-heading {
    font-family: var(--font-heading);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--color-Primary-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-xs);
  }

  .author-name {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    margin: 0;
  }

  .author-bio-wrapper {
    display: block;
  }

  .author-bio {
    font-size: var(--text-base);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin: 0;
  }

  /* ===== LINKED ASSETS SECTION ===== */
  .linked-assets {
    padding: var(--space-4xl) 0;
    background-color: var(--color-Neutral-500);
  }

  .section-heading {
    font-family: var(--font-heading);
    font-size: var(--text-4xl);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    text-align: left;
    margin-bottom: var(--space-3xl);
  }

  .assets-grid {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xl);
  }

  .asset-card {
    overflow: hidden;
    transition: transform var(--transition-base), box-shadow var(--transition-base);
    text-decoration: none;
    display: inline-flex;
    flex-direction: column;
    color: inherit;
    background: var(--color-Secondary-100);
    border-radius: var(--border-radius-lg);
    width: calc(33.333% - var(--space-xl) * 2 / 3);
    flex: 0 0 auto;
    position: relative;
  }

  .asset-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  .asset-card:hover .asset-title {
    color: var(--color-Primary-600);
  }

  .asset-card-content {
    padding: var(--space-lg);
    position: relative;
  }

  .asset-badge {
    display: inline-block;
    padding: var(--space-xs) var(--space-sm);
    background: var(--color-Primary-600);
    color: white;
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    border-radius: var(--border-radius-sm);
    text-transform: uppercase;
    margin-bottom: var(--space-sm);
  }

  .asset-badge.badge-worksheet {
    background: var(--color-Primary-600);
  }

  .asset-badge.badge-workbook {
    background: var(--color-Secondary-600);
  }

  .asset-badge.badge-guide {
    background: var(--color-AccentOne-600);
  }

  .asset-badge.badge-toolkit {
    background: var(--color-AccentTwo-600);
  }

  .asset-title {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    margin-bottom: var(--space-sm);
    transition: color var(--transition-base);
  }

  .asset-description {
    font-size: var(--text-sm);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-md);
  }

  .asset-link-text {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    color: var(--color-Primary-600);
    margin-top: auto;
    display: inline-block;
  }

  /* Responsive asset cards */
  @media (max-width: 1023px) {
    .asset-card {
      width: calc(50% - var(--space-xl) / 2);
    }
  }

  @media (max-width: 767px) {
    .asset-card {
      width: 100%;
    }

    .asset-card-content {
      padding: var(--space-md);
    }
  }

  @media (max-width: 480px) {
    .asset-card-content {
      padding: var(--space-sm);
    }
  }

  /* ===== SUGGESTED POSTS SECTION ===== */
  .suggested-posts {
    padding: var(--space-4xl) 0;
    background-color: var(--color-Neutral-500);
  }

  .posts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-2xl);
  }

  .post-card {
    display: flex;
    flex-direction: column;
    background: var(--color-Background-50);
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    box-shadow: var(--shadow-md);
    transition: all var(--transition-base);
    text-decoration: none;
    border: 1px solid var(--color-Neutral-200);
  }

  .post-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-2xl);
  }

  .post-card-image {
    width: 100%;
    height: 200px;
    overflow: hidden;
  }

  .post-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .post-card:hover .post-card-image img {
    transform: scale(1.05);
  }

  .post-card-content {
    padding: var(--space-xl);
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .post-card-category {
    display: inline-block;
    padding: var(--space-xs) var(--space-md);
    background: var(--color-Primary-100);
    color: var(--color-Primary-700);
    border-radius: var(--border-radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-md);
    align-self: flex-start;
  }

  .post-card-title {
    font-family: var(--font-heading);
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-md);
  }

  .post-card-description {
    font-size: var(--text-sm);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-md);
    flex: 1;
  }

  .post-card-date {
    font-size: var(--text-xs);
    color: var(--color-Text-500);
    margin-top: auto;
  }

  /* ===== TRADITIONAL BLOG LAYOUT ===== */
  .traditional-post {
    padding: var(--space-5xl) 0;
    background-color: var(--color-Neutral-500);
  }

  .post-header {
    padding: var(--space-4xl) 0;
    text-align: center;
  }

  .post-meta {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    margin-bottom: var(--space-xl);
    font-size: var(--text-sm);
    color: var(--color-Text-500);
  }

  .post-category {
    padding: var(--space-xs) var(--space-md);
    background: var(--color-Primary-100);
    color: var(--color-Primary-700);
    border-radius: var(--border-radius-full);
    font-weight: var(--font-semibold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    font-size: var(--text-xs);
  }

  .post-date,
  .post-author {
    font-family: var(--font-body);
  }

  .post-title {
    font-family: var(--font-heading);
    font-size: var(--text-5xl);
    font-weight: var(--font-extrabold);
    color: var(--color-Text-700);
    line-height: var(--leading-tight);
    margin-bottom: var(--space-lg);
    max-width: 900px;
    margin-left: auto;
    margin-right: auto;
  }

  .post-description {
    font-size: var(--text-xl);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    max-width: 700px;
    margin: 0 auto;
    font-style: italic;
  }

  .post-hero-image {
    max-width: 1200px;
    margin: 0 auto var(--space-4xl);
    overflow: hidden;
    border-radius: var(--border-radius-xl);
    box-shadow: var(--shadow-2xl);
  }

  .post-hero-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .post-content {
    padding: var(--space-4xl) 0;
  }

  .post-content :global(h2) {
    font-family: var(--font-heading);
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
    line-height: var(--leading-tight);
    margin-top: var(--space-3xl);
    margin-bottom: var(--space-xl);
  }

  .post-content :global(h3) {
    font-family: var(--font-heading);
    font-size: var(--text-2xl);
    font-weight: var(--font-semibold);
    color: var(--color-Text-700);
    line-height: var(--leading-snug);
    margin-top: var(--space-2xl);
    margin-bottom: var(--space-lg);
  }

  .post-content :global(p) {
    font-size: var(--text-lg);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-lg);
  }

  .post-content :global(ul),
  .post-content :global(ol) {
    margin-bottom: var(--space-lg);
    padding-left: var(--space-xl);
  }

  .post-content :global(li) {
    font-size: var(--text-lg);
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: var(--space-sm);
  }

  .post-content :global(blockquote) {
    border-left: 4px solid var(--color-Primary-500);
    padding-left: var(--space-xl);
    margin: var(--space-2xl) 0;
    font-style: italic;
    color: var(--color-Text-600);
  }

  .post-content :global(strong) {
    font-weight: var(--font-bold);
    color: var(--color-Text-700);
  }

  .post-content :global(em) {
    font-style: italic;
  }

  .post-content :global(a) {
    color: var(--color-Primary-600);
    text-decoration: underline;
    transition: color 0.2s ease;
  }

  .post-content :global(a:hover) {
    color: var(--color-Primary-700);
  }

  .post-footer {
    padding: var(--space-3xl) 0;
    border-top: 1px solid var(--color-Neutral-200);
  }

  .post-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
  }

  .tag {
    padding: var(--space-xs) var(--space-md);
    background: var(--color-Neutral-100);
    color: var(--color-Text-600);
    border-radius: var(--border-radius-full);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
  }

  /* ===== RESPONSIVE ===== */
  @media (max-width: 768px) {
    /* Blog Hero Mobile */
    .blog-hero {
      height: 500px;
    }

    .hero-title {
      font-size: var(--text-3xl);
    }

    .hero-description {
      font-size: var(--text-lg);
    }

    /* Author Card Mobile */
    .author-card {
      flex-direction: column;
      text-align: center;
      padding: var(--space-2xl);
    }

    .author-image {
      width: 100px;
      height: 100px;
    }

    /* Suggested Posts Mobile */
    .posts-grid {
      grid-template-columns: 1fr;
    }

    /* Assets Grid Mobile */
    .assets-grid {
      grid-template-columns: 1fr;
    }

    /* Traditional Post Mobile */
    .post-header {
      padding: var(--space-3xl) 0;
    }

    .post-meta {
      flex-direction: column;
      gap: var(--space-sm);
    }

    .post-title {
      font-size: var(--text-3xl);
    }

    .post-description {
      font-size: var(--text-lg);
    }

    .post-content :global(h2) {
      font-size: var(--text-2xl);
    }

    .post-content :global(h3) {
      font-size: var(--text-xl);
    }

    .post-content :global(p),
    .post-content :global(li) {
      font-size: var(--text-base);
    }
  }

  @media (max-width: 640px) {
    /* Blog Hero Small Mobile */
    .blog-hero {
      height: 450px;
    }

    .hero-title {
      font-size: var(--text-2xl);
    }

    .hero-description {
      font-size: var(--text-base);
    }

    .author-card {
      padding: var(--space-xl);
    }

    .author-image {
      width: 80px;
      height: 80px;
    }

    .author-name {
      font-size: var(--text-lg);
    }

    /* Traditional Post Small Mobile */
    .traditional-post {
      padding: var(--space-3xl) 0;
    }

    .post-header {
      padding: var(--space-2xl) 0;
    }

    .post-title {
      font-size: var(--text-2xl);
    }

    .post-description {
      font-size: var(--text-base);
    }

    .post-content {
      padding: var(--space-2xl) 0;
    }
  }
</style>
