---
import BaseLayout from '../../Layouts/BaseLayout.astro';
import ContentSwitcher from '../../components/Switcher/ContentSwitcher.astro';
import Breadcrumbs from '../../components/Navigation/Breadcrumbs.astro';
import IsotopeImageGallery from '../../components/Product/IsotopeImageGallery.astro';
import ProductInfo from '../../components/Product/ProductInfo.astro';
import SpecGrid from '../../components/Product/SpecGrid.astro';
import RelatedGrid from '../../components/Grids/RelatedGrid.astro';
import { getCollection } from 'astro:content';
import { calculateGridLayout, estimateCardDimensions } from '../../lib/utils/grid-layout';
import { getSuggestedContent, getSlugFromId } from '../../lib/utils/related-content';

// Generate static paths from content collection
export async function getStaticPaths() {
  const assetEntries = await getCollection('assets');

  return assetEntries.map(entry => ({
    params: { slug: getSlugFromId(entry.id) },
    props: { entry }
  }));
}

// Helper for local slug extraction
const getSlug = getSlugFromId;

const { entry } = Astro.props;
const asset = entry.data;
const slug = getSlug(entry.id);

// Fallback if asset not found
if (!asset) {
  return Astro.redirect('/assets');
}

// Map asset data to product structure
const product = {
  id: slug,
  name: asset.name,
  slug: slug,
  category: asset.category,
  type: asset.type,
  sku: asset.sku,
  description: asset.description,
  longDescription: asset.longDescription || `<p>${asset.description}</p>`,
  features: asset.features || [],
  fileSize: asset.fileSize,
  pageCount: asset.pageCount,
  downloadPath: asset.downloadUrl,
  professionalGuidePath: asset.professionalGuideUrl,
  cardImage: asset.cardImage,
  galleryImages: asset.galleryImages || [],
  forIndividuals: asset.forIndividuals,
  forProfessionals: asset.forProfessionals,
  specifications: asset.specifications,
};

// Get related products using smart content matching
// Priority: tag similarity > same type > latest (fallback)
const allAssets = await getCollection('assets');
const relatedEntries = getSuggestedContent(entry, allAssets, {
  maxItems: 4,
  getSlug: (item) => getSlugFromId(item.id)
});

// Format for RelatedGrid
const relatedProducts = relatedEntries.map(a => ({
  slug: getSlug(a.id),
  title: a.data.name,
  name: a.data.name,
  description: a.data.description,
  category: a.data.category,
  cardImage: a.data.cardImage,
}));

// Build breadcrumbs
const breadcrumbs = [
  { label: 'Home', href: '/' },
  { label: 'Tools', href: '/assets' },
  { label: product.name }
];

// Build product info items (icon names for Icon component)
const productInfoItems = [
  { icon: 'file-pdf-fill', label: 'PDF' },
  { icon: 'database-fill', label: product.fileSize || '36 MB' },
  { icon: 'file-text-fill', label: `${product.pageCount || 28} pages` }
];

// Build specifications - always show defaults PLUS any custom specs from markdown
const variantCycle = ['primary', 'secondary', 'accent'] as const;

// Default specs that always show (reduced set)
const defaultSpecs = [
  { iconName: 'file-pdf-fill', label: 'Format', value: 'PDF', variant: 'accent' as const },
  { iconName: 'book-fill', label: 'Type', value: product.category, variant: 'primary' as const },
  ...(product.pageCount ? [{ iconName: 'file-text-fill', label: 'Pages', value: product.pageCount.toString(), variant: 'secondary' as const }] : []),
  ...(product.fileSize ? [{ iconName: 'database-fill', label: 'File Size', value: product.fileSize, variant: 'accent' as const }] : []),
  ...(product.professionalGuidePath ? [{ iconName: 'certificate-fill', label: 'Additional Guide', value: 'Notes Available', variant: 'primary' as const }] : []),
  { iconName: 'file-lock-fill', label: 'License', value: 'Personal Use Only', variant: 'secondary' as const },
  { iconName: 'devices-fill', label: 'Device', value: 'Any Device', variant: 'accent' as const },
  { iconName: 'translate-fill', label: 'Language', value: 'UK English', variant: 'primary' as const },
  { iconName: 'seal-check-fill', label: 'Quality', value: 'High Resolution', variant: 'secondary' as const },
  { iconName: 'shield-check-fill', label: 'Secure', value: 'Safe Download', variant: 'primary' as const },
  { iconName: 'wifi-slash-fill', label: 'Offline', value: 'Works Offline', variant: 'secondary' as const },
  { iconName: 'heart-fill', label: 'Approach', value: 'Evidence-Based', variant: 'accent' as const }
];

// Custom specs from markdown (if any)
const customSpecs = product.specifications && product.specifications.length > 0
  ? product.specifications.map((spec: any, index: number) => ({
      iconName: spec.icon, // Icon component will convert ph:xxx-duotone to xxx-fill
      label: spec.label,
      value: spec.value,
      variant: variantCycle[index % 3]
    }))
  : [];

// Feature specs from markdown (if any)
const featureSpecs = product.features && product.features.length > 0
  ? product.features.map((feature: string, index: number) => ({
      iconName: 'check-circle-fill',
      label: 'Feature',
      value: feature,
      variant: variantCycle[index % 3]
    }))
  : [];

// Combine: custom specs first, then features, then defaults
const specs = [...customSpecs, ...featureSpecs, ...defaultSpecs];

// Calculate grid positions for specs
const specsWithLayout = calculateGridLayout(
  specs,
  (spec) => estimateCardDimensions(spec.label, spec.value),
  5, // grid columns
  200 // min card width
);
---

<BaseLayout
  title={`${product.name} | Walking With A Smile`}
  description={product.description}
>
  <Breadcrumbs items={breadcrumbs} />

  <!-- Product Details -->
  <section class="product-detail-section section">
    <div class="container container-7xl">
      <div class="product-layout">
        <!-- Left Column: Image Gallery -->
        <IsotopeImageGallery
          mainImage={product.cardImage}
          galleryImages={product.galleryImages}
          productName={product.name}
          badge={product.category}
          badgeType={product.type}
        />

        <!-- Right Column: Product Info -->
        <ProductInfo
          category={product.category}
          name={product.name}
          sku={product.sku}
          description={product.description}
          infoItems={productInfoItems}
          productId={product.id}
          productImage={product.cardImage.src}
          hasProfessionalGuide={!!product.professionalGuidePath}
        />
      </div>
    </div>
  </section>

  <!-- Product Content - Tabbed -->
  <section class="product-content-section section-sm">
    <div class="container container-7xl">
      <div class="content-wrapper">
        <ContentSwitcher
          tabs={[
            { id: 'description', label: 'Description' },
            { id: 'specification', label: 'Specification' },
            { id: 'individuals', label: 'For Individuals' },
            { id: 'professionals', label: 'For Professionals' }
          ]}
          defaultActive="description"
        />

        <!-- Tab Content -->
        <div class="tabs-content">
          <!-- Description Tab -->
          <div class="tab-panel active" data-panel="description">
            <h2>About This {product.category}</h2>
            <div set:html={product.longDescription} />
          </div>

          <!-- Specification Tab -->
          <div class="tab-panel" data-panel="specification">
            <SpecGrid specs={specsWithLayout} />
          </div>

          <!-- For Individuals Tab -->
          <div class="tab-panel" data-panel="individuals">
            <h2>For Individuals</h2>
            {product.forIndividuals ? (
              <>
                {product.forIndividuals.overview && (
                  <>
                    <h3>Overview</h3>
                    <div set:html={product.forIndividuals.overview} />
                  </>
                )}

                {product.forIndividuals.howToUse && (
                  <>
                    <h3>How to Use</h3>
                    <div set:html={product.forIndividuals.howToUse} />
                  </>
                )}

                {product.forIndividuals.whenToUse && product.forIndividuals.whenToUse.length > 0 && (
                  <>
                    <h3>When to Use</h3>
                    <ul class="simple-list">
                      {product.forIndividuals.whenToUse.map(situation => (
                        <li>{situation}</li>
                      ))}
                    </ul>
                  </>
                )}

                {product.forIndividuals.tips && product.forIndividuals.tips.length > 0 && (
                  <>
                    <h3>Tips</h3>
                    <ul class="simple-list">
                      {product.forIndividuals.tips.map(tip => (
                        <li>{tip}</li>
                      ))}
                    </ul>
                  </>
                )}
              </>
            ) : (
              <p>This resource is designed to support your personal wellbeing journey. Take what resonates and leave what doesn't.</p>
            )}
          </div>

          <!-- For Professionals Tab -->
          <div class="tab-panel" data-panel="professionals">
            <h2>For Professionals</h2>
            {product.forProfessionals ? (
              <>
                {product.forProfessionals.clinicalContext && (
                  <>
                    <h3>Clinical Context</h3>
                    <div set:html={product.forProfessionals.clinicalContext} />
                  </>
                )}

                {product.forProfessionals.intendedUse && (
                  <>
                    <h3>Intended Use</h3>
                    <div set:html={product.forProfessionals.intendedUse} />
                  </>
                )}

                {product.forProfessionals.therapeuticApproach && (
                  <>
                    <h3>Therapeutic Approach</h3>
                    <div set:html={product.forProfessionals.therapeuticApproach} />
                  </>
                )}

                {product.forProfessionals.evidenceBase && product.forProfessionals.evidenceBase.length > 0 && (
                  <>
                    <h3>Evidence Base</h3>
                    <ul class="simple-list">
                      {product.forProfessionals.evidenceBase.map(evidence => (
                        <li>{evidence}</li>
                      ))}
                    </ul>
                  </>
                )}

                {product.forProfessionals.adaptations && product.forProfessionals.adaptations.length > 0 && (
                  <>
                    <h3>Adaptations</h3>
                    <ul class="simple-list">
                      {product.forProfessionals.adaptations.map(adaptation => (
                        <li>{adaptation}</li>
                      ))}
                    </ul>
                  </>
                )}

                {product.forProfessionals.sessionIntegration && (
                  <>
                    <h3>Session Integration</h3>
                    <div set:html={product.forProfessionals.sessionIntegration} />
                  </>
                )}
              </>
            ) : (
              <p>Professional guidance notes are available for this resource. Contact us for more information about using this in therapeutic or clinical settings.</p>
            )}

            {product.professionalGuidePath && (
              <p class="conclusion-text">A companion Professional Guide is available (via the "Add Professional Guide" button above) providing detailed implementation strategies, evidence-based context, and therapeutic applications.</p>
            )}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Related Products -->
  {relatedProducts.length > 0 && (
    <RelatedGrid
      items={relatedProducts}
      contentType="products"
      title="You Might Also Like"
      basePath="/assets"
      cardStyle="horizontal"
      columns="2"
      background="light"
      containerSize="7xl"
    />
  )}
</BaseLayout>

<script>
  import '../../lib/cart/product-detail';
</script>
