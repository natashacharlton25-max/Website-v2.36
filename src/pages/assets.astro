---
import BaseLayout from '../Layouts/BaseLayout.astro';
import IsotopeFilterSwitcher from '../components/Switcher/IsotopeFilterSwitcher.astro';
import HeroSection from '../components/Sections/HeroSection.astro';
import ProductCard from '../components/Cards/ProductCard.astro';
import { getCollection } from 'astro:content';

// Import data
import heroDataRaw from '../data/assets/hero.json';
import filterCategoriesBase from '../data/assets/filters.json';

// Type assertions for JSON imports
const heroData = heroDataRaw as {
  title: string;
  subtitle: string;
  extraText: string;
  variant: 'simple' | 'image' | 'gradient';
};

// Helper to get folder slug from entry.id (handles index.md suffix and path separators)
const getSlug = (id: string) => {
  const normalized = id.replace(/[\\/]index\.md$/, '');
  return normalized.split(/[\\/]/).pop() || id;
};

// Get all assets from content collection
const assetsEntries = await getCollection('assets');
const assets = assetsEntries.map(entry => ({
  ...entry.data,
  slug: getSlug(entry.id),
}));

// Get unique types from assets and merge with base filters
const types = [...new Set(assets.map(a => a.type))];
const dynamicFilters = types.map(type => ({
  id: type.toLowerCase().replace(/\s+/g, '-'),
  label: type.charAt(0).toUpperCase() + type.slice(1),
}));
const filterCategories = [...filterCategoriesBase, ...dynamicFilters];
---

<BaseLayout
  title="Digital Assets | Your Brand Name"
  description="Browse our collection of premium digital products designed to help you succeed"
>
  <!-- Hero Section -->
  <HeroSection
    title={heroData.title}
    subtitle={heroData.subtitle}
    extraText={heroData.extraText}
    variant={heroData.variant}
  />

  <!-- Products Section -->
  <section class="assets-content section">
    <div class="container container-7xl">
      <div class="products-section">

        <!-- Filter -->
        <div class="filter-section-assets">
          <IsotopeFilterSwitcher
            tabs={filterCategories}
            defaultActive="all"
            gridSelector="#products-grid"
            itemSelector=".product-card"
          />
        </div>

        <!-- Products Grid - Dynamic from assets data -->
        <div class="products-grid" id="products-grid">
          <!-- Grid sizer for Isotope column width calculation -->
          <div class="grid__sizer"></div>

          {assets.map((asset) => (
            <ProductCard
              slug={asset.slug}
              name={asset.name}
              category={asset.category}
              description={asset.description}
              cardImage={asset.cardImage}
              type={asset.type}
            />
          ))}
        </div>
      </div>
    </div>
  </section>

</BaseLayout>

<script>
  import '../lib/cart/add-to-cart-handler';
</script>
