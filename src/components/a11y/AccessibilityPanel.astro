---
/**
 * AccessibilityPanel - Complete Accessibility Solution (All-in-One)
 */

interface Props {
  /**
   * Display mode: 'modal' (overlay) or 'page' (standalone page)
   */
  mode?: 'modal' | 'page';
}

const { mode = 'modal' } = Astro.props;

// Import components
import ButtonDropdown from '../Button/ButtonDropdown.astro';
import Icon from '../Icons/Icon.astro';

// Font options for dropdown
const fontOptions = [
  { label: 'Default Font', value: 'default' },
  { label: 'OpenDyslexic (Dyslexia)', value: 'opendyslexic', fontFamily: "'OpenDyslexic', sans-serif" },
  { label: 'Atkinson Hyperlegible (Low Vision)', value: 'atkinson', fontFamily: "'Atkinson Hyperlegible', sans-serif" },
  { label: 'Comic Sans MS (Easy Read)', value: 'comic-sans', fontFamily: "'Comic Sans MS', 'Comic Sans', cursive" },
  { label: 'Verdana (Screen Optimized)', value: 'verdana', fontFamily: "Verdana, Geneva, sans-serif" },
  { label: 'Arial (Clean & Simple)', value: 'arial', fontFamily: "Arial, Helvetica, sans-serif" },
  { label: 'Tahoma (High Legibility)', value: 'tahoma', fontFamily: "Tahoma, Geneva, sans-serif" }
];
---

<!-- Live Region for Announcements -->
<div
  id="a11y-announcer"
  class="sr-only"
  aria-live="polite"
  aria-atomic="true"
></div>

<!-- Alert Region for Urgent Announcements -->
<div
  id="a11y-alert"
  class="sr-only"
  role="alert"
  aria-live="assertive"
  aria-atomic="true"
></div>

<!-- Accessibility Panel -->
<div
  class={mode === 'page' ? 'a11y-panel a11y-panel--page' : 'a11y-panel'}
  id="a11y-panel"
  role={mode === 'modal' ? 'dialog' : undefined}
  aria-label="Accessibility settings"
  aria-modal={mode === 'modal' ? 'true' : undefined}
  hidden={mode === 'modal' ? true : undefined}
>
  <div class="a11y-panel__header" data-mode={mode}>
    <h2 class="a11y-panel__title">
      Accessibility
    </h2>
    <div class="a11y-panel__header-actions">
      <button class="btn btn-sm btn-ghost" id="a11y-reset" aria-label="Reset all settings">
        <Icon name="a11y-panel/arrow-counter-clockwise-fill" size={18} />
        Reset All
      </button>
      {mode === 'modal' && (
        <button class="a11y-panel__close" type="button" aria-label="Close accessibility panel">
          <Icon name="x-square-fill" size={24} />
        </button>
      )}
    </div>
  </div>

  <div class="a11y-panel__body">
    <!-- Left Sidebar: Theme Cards -->
    <aside class="a11y-panel__sidebar">
      <h3 class="a11y-sidebar__title">Color Theme</h3>
      <!-- Theme cards are dynamically generated by ThemePreviewTokens.js -->
      <div class="a11y-theme-list"></div>
    </aside>

    <!-- Main Content Area -->
    <div class="a11y-panel__content">
    <!-- Section: Visual -->
    <div class="a11y-section">
      <h3 class="a11y-section__title">Visual</h3>

      <!-- Text Only Mode -->
      <div class="a11y-setting">
        <div class="a11y-setting__header">
          <label for="a11y-text-only" class="a11y-setting__label">Text Only Mode</label>
          <span class="a11y-setting__desc">Hide images and decorations</span>
        </div>
        <label class="a11y-toggle">
          <input type="checkbox" id="a11y-text-only" data-setting="textOnly">
          <span class="a11y-toggle__slider"></span>
        </label>
      </div>

      <!-- Highlight Links -->
      <div class="a11y-setting">
        <div class="a11y-setting__header">
          <label for="a11y-highlight-links" class="a11y-setting__label">Highlight Links</label>
          <span class="a11y-setting__desc">Underline all links</span>
        </div>
        <label class="a11y-toggle">
          <input type="checkbox" id="a11y-highlight-links" data-setting="highlightLinks">
          <span class="a11y-toggle__slider"></span>
        </label>
      </div>

    </div>

    <!-- Section: Typography -->
    <div class="a11y-section">
      <h3 class="a11y-section__title">Typography</h3>

      <!-- Accessible Font Selector -->
      <div class="a11y-setting a11y-setting--font">
        <div class="a11y-setting__header">
          <label id="a11y-font-label-text" class="a11y-setting__label">Accessible Font</label>
          <span class="a11y-setting__desc">Choose an easy-to-read font</span>
        </div>
        <div class="a11y-font-dropdown" data-setting="fontFamily">
          <button
            type="button"
            class="btn btn-sm a11y-font-trigger"
            id="a11y-font-trigger"
            aria-haspopup="listbox"
            aria-expanded="false"
            aria-labelledby="a11y-font-label-text a11y-font-current"
          >
            <span id="a11y-font-current">Default Font</span>
            <Icon name="a11y-panel/arrow-left-fill" size={16} class="a11y-font-chevron" />
          </button>
          <ButtonDropdown
            mode="selection"
            id="a11y-font-dropdown"
            name="fontFamily"
            selectedValue="default"
            dropdownItems={fontOptions}
            colorTheme="primary"
          />
        </div>
      </div>

      <!-- Font Size -->
      <div class="a11y-setting a11y-setting--slider">
        <div class="a11y-setting__header">
          <label for="a11y-font-size" class="a11y-setting__label">Font Size</label>
          <span class="a11y-setting__value" id="font-size-value">100%</span>
        </div>
        <input
          type="range"
          id="a11y-font-size"
          min="50"
          max="200"
          step="10"
          value="100"
          data-setting="fontSize"
          class="a11y-slider"
        >
        <div class="a11y-slider__labels">
          <span>A</span>
          <span style="font-size: 1.5em;">A</span>
        </div>
      </div>

      <!-- Letter Spacing -->
      <div class="a11y-setting a11y-setting--slider">
        <div class="a11y-setting__header">
          <label for="a11y-letter-spacing" class="a11y-setting__label">Letter Spacing</label>
          <span class="a11y-setting__value" id="letter-spacing-value">Normal</span>
        </div>
        <input
          type="range"
          id="a11y-letter-spacing"
          min="0"
          max="10"
          step="1"
          value="0"
          data-setting="letterSpacing"
          class="a11y-slider"
        >
      </div>

      <!-- Word Spacing -->
      <div class="a11y-setting a11y-setting--slider">
        <div class="a11y-setting__header">
          <label for="a11y-word-spacing" class="a11y-setting__label">Word Spacing</label>
          <span class="a11y-setting__value" id="word-spacing-value">Normal</span>
        </div>
        <input
          type="range"
          id="a11y-word-spacing"
          min="0"
          max="20"
          step="2"
          value="0"
          data-setting="wordSpacing"
          class="a11y-slider"
        >
      </div>

      <!-- Line Height -->
      <div class="a11y-setting a11y-setting--slider">
        <div class="a11y-setting__header">
          <label for="a11y-line-height" class="a11y-setting__label">Line Height</label>
          <span class="a11y-setting__value" id="line-height-value">Normal</span>
        </div>
        <input
          type="range"
          id="a11y-line-height"
          min="100"
          max="200"
          step="10"
          value="100"
          data-setting="lineHeight"
          class="a11y-slider"
        >
      </div>
    </div>

    <!-- Section: Navigation & Motion -->
    <div class="a11y-section">
      <h3 class="a11y-section__title">Navigation & Motion</h3>

      <!-- Reduced Motion -->
      <div class="a11y-setting">
        <div class="a11y-setting__header">
          <label for="a11y-reduce-motion" class="a11y-setting__label">Reduce Motion</label>
          <span class="a11y-setting__desc">Disable animations</span>
        </div>
        <label class="a11y-toggle">
          <input type="checkbox" id="a11y-reduce-motion" data-setting="reduceMotion">
          <span class="a11y-toggle__slider"></span>
        </label>
      </div>

      <!-- Enhanced Focus -->
      <div class="a11y-setting">
        <div class="a11y-setting__header">
          <label for="a11y-enhanced-focus" class="a11y-setting__label">Enhanced Focus</label>
          <span class="a11y-setting__desc">Larger focus indicators</span>
        </div>
        <label class="a11y-toggle">
          <input type="checkbox" id="a11y-enhanced-focus" data-setting="enhancedFocus">
          <span class="a11y-toggle__slider"></span>
        </label>
      </div>

      <!-- Screen Reader Mode -->
      <div class="a11y-setting">
        <div class="a11y-setting__header">
          <label for="a11y-screen-reader" class="a11y-setting__label">Screen Reader Mode</label>
          <span class="a11y-setting__desc">Announce interactions</span>
        </div>
        <label class="a11y-toggle">
          <input type="checkbox" id="a11y-screen-reader" data-setting="screenReaderMode">
          <span class="a11y-toggle__slider"></span>
        </label>
      </div>

      <!-- PDF Download -->
      <div class="a11y-setting a11y-setting--pdf">
        <button class="btn btn-sm btn-primary" id="a11y-download-pdf" aria-label="Download page as PDF">
          <Icon name="a11y-panel/download-fill" size={18} />
          <span>Download PDF</span>
        </button>
      </div>
    </div>
    </div> <!-- close .a11y-panel__content -->

    <!-- Right Sidebar: Quick Presets -->
    <aside class="a11y-panel__sidebar-right">
      <h3 class="a11y-sidebar__title">Quick Presets</h3>
      <div class="a11y-preset-list">
        <button class="a11y-preset-btn" data-preset="dyslexia" aria-label="Dyslexia optimized settings">
          <Icon name="a11y-panel/text-aa-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Dyslexia</span>
            <span class="a11y-preset-btn__subtitle">Font + spacing</span>
          </div>
        </button>

        <button class="a11y-preset-btn" data-preset="low-vision" aria-label="Low vision optimized settings">
          <Icon name="a11y-panel/eye-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Low Vision</span>
            <span class="a11y-preset-btn__subtitle">Large text</span>
          </div>
        </button>

        <button class="a11y-preset-btn" data-preset="color-blind" aria-label="Color blind optimized settings">
          <Icon name="a11y-panel/palette-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Color Blind</span>
            <span class="a11y-preset-btn__subtitle">Adapted colors</span>
          </div>
        </button>

        <button class="a11y-preset-btn" data-preset="motor" aria-label="Motor impairment optimized settings">
          <Icon name="a11y-panel/hand-palm-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Motor</span>
            <span class="a11y-preset-btn__subtitle">Enhanced focus</span>
          </div>
        </button>

        <button class="a11y-preset-btn" data-preset="cognitive" aria-label="Cognitive optimized settings">
          <Icon name="a11y-panel/brain-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Cognitive</span>
            <span class="a11y-preset-btn__subtitle">Reduced motion</span>
          </div>
        </button>

        <button class="a11y-preset-btn" data-preset="easyread" aria-label="Easy read preset">
          <Icon name="a11y-panel/book-open-fill" size={40} class="a11y-preset-btn__icon" />
          <div class="a11y-preset-btn__text">
            <span class="a11y-preset-btn__title">Easy Read</span>
            <span class="a11y-preset-btn__subtitle">Simple layout</span>
          </div>
        </button>
      </div>
    </aside>
  </div> <!-- close .a11y-panel__body -->
</div>

{mode === 'modal' && (
  <!-- Backdrop -->
  <div class="a11y-panel__backdrop" hidden></div>
)}

<!-- Styles: src/Styles/a11y/components/accessibility-panel.css -->

<script>
  // ===================================
  // SETTINGS INTERFACE
  // ===================================
  interface A11ySettings {
    textOnly: boolean;
    highlightLinks: boolean;
    dyslexiaFont: boolean;
    fontFamily?: string;
    fontSize: number;
    letterSpacing: number;
    wordSpacing: number;
    lineHeight: number;
    theme: string;
    reduceMotion: boolean;
    enhancedFocus: boolean;
    screenReaderMode: boolean;
  }

  const STORAGE_KEY = 'a11y-settings';

  const defaultSettings: A11ySettings = {
    textOnly: false,
    highlightLinks: false,
    dyslexiaFont: false,
    fontFamily: 'default',
    fontSize: 100,
    letterSpacing: 0,
    wordSpacing: 0,
    lineHeight: 100,
    theme: 'default',
    reduceMotion: false,
    enhancedFocus: false,
    screenReaderMode: false
  };

  // ===================================
  // STORAGE FUNCTIONS
  // ===================================
  function getSettings(): A11ySettings {
    try {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored ? { ...defaultSettings, ...JSON.parse(stored) } : defaultSettings;
    } catch {
      return defaultSettings;
    }
  }

  function saveSettings(settings: A11ySettings) {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    } catch {
      // localStorage not available
    }
  }

  // ===================================
  // SCREEN READER ANNOUNCER
  // ===================================
  function announce(message: string, priority: 'polite' | 'assertive' = 'polite') {
    const announcer = priority === 'assertive'
      ? document.getElementById('a11y-alert')
      : document.getElementById('a11y-announcer');

    if (announcer) {
      announcer.textContent = '';
      setTimeout(() => {
        announcer.textContent = message;
      }, 100);
    }
  }

  // ===================================
  // FOCUS TRAP CLASS
  // ===================================
  class FocusTrap {
    private container: HTMLElement;
    private firstFocusable: HTMLElement | null = null;
    private lastFocusable: HTMLElement | null = null;
    private previouslyFocused: HTMLElement | null = null;

    constructor(container: HTMLElement) {
      this.container = container;
      this.updateFocusableElements();
    }

    private updateFocusableElements() {
      const focusableSelectors = [
        'a[href]',
        'button:not([disabled])',
        'input:not([disabled])',
        'select:not([disabled])',
        'textarea:not([disabled])',
        '[tabindex]:not([tabindex="-1"])'
      ].join(', ');

      const focusables = this.container.querySelectorAll<HTMLElement>(focusableSelectors);
      this.firstFocusable = focusables[0] || null;
      this.lastFocusable = focusables[focusables.length - 1] || null;
    }

    activate() {
      this.previouslyFocused = document.activeElement as HTMLElement;
      document.body.classList.add('focus-trap-active');
      this.container.setAttribute('data-focus-trap', 'active');

      if (this.firstFocusable) {
        this.firstFocusable.focus();
      }

      this.container.addEventListener('keydown', this.handleKeydown);
    }

    deactivate() {
      document.body.classList.remove('focus-trap-active');
      this.container.removeAttribute('data-focus-trap');
      this.container.removeEventListener('keydown', this.handleKeydown);

      if (this.previouslyFocused) {
        this.previouslyFocused.focus();
      }
    }

    private handleKeydown = (e: KeyboardEvent) => {
      if (e.key !== 'Tab') return;

      this.updateFocusableElements();

      if (e.shiftKey) {
        if (document.activeElement === this.firstFocusable) {
          e.preventDefault();
          this.lastFocusable?.focus();
        }
      } else {
        if (document.activeElement === this.lastFocusable) {
          e.preventDefault();
          this.firstFocusable?.focus();
        }
      }
    };
  }

  // ===================================
  // UTILITY FUNCTIONS
  // ===================================
  function prefersReducedMotion(): boolean {
    return window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  }

  function prefersHighContrast(): boolean {
    return window.matchMedia('(prefers-contrast: high)').matches;
  }

  // ===================================
  // APPLY SETTINGS
  // ===================================
  function applySettings(settings: A11ySettings) {
    const body = document.body;

    // Toggle classes
    body.classList.toggle('a11y-text-only', settings.textOnly);
    body.classList.toggle('a11y-highlight-links', settings.highlightLinks);
    body.classList.toggle('a11y-dyslexia-font', settings.dyslexiaFont);
    body.classList.toggle('a11y-reduce-motion', settings.reduceMotion);
    body.classList.toggle('a11y-enhanced-focus', settings.enhancedFocus);
    body.classList.toggle('a11y-screen-reader-mode', settings.screenReaderMode);

    // Font Family
    body.classList.remove(
      'a11y-font-opendyslexic',
      'a11y-font-atkinson',
      'a11y-font-comic-sans',
      'a11y-font-verdana',
      'a11y-font-arial',
      'a11y-font-tahoma'
    );
    if (settings.fontFamily && settings.fontFamily !== 'default') {
      body.classList.add(`a11y-font-${settings.fontFamily}`);
    }

    // Font Size
    document.documentElement.style.fontSize = `${settings.fontSize}%`;

    // Letter Spacing
    body.style.letterSpacing = settings.letterSpacing > 0 ? `${settings.letterSpacing * 0.05}em` : '';

    // Word Spacing
    body.style.wordSpacing = settings.wordSpacing > 0 ? `${settings.wordSpacing * 0.05}em` : '';

    // Line Height
    body.style.lineHeight = settings.lineHeight > 100 ? `${settings.lineHeight}%` : '';

    // Theme - Use ThemeSwitcher for dynamic CSS loading
    // Map a11y panel theme names to ThemeSwitcher theme names
    const themeMap: Record<string, string> = {
      'default': 'default',
      'dark': 'a11y-dark',
      'cream': 'a11y-cream',
      'high-contrast': 'a11y-high-contrast',
      'protanopia': 'a11y-protanopia',
      'deuteranopia': 'a11y-deuteranopia',
      'tritanopia': 'a11y-tritanopia',
      'monochrome': 'a11y-monochrome'
    };

    const switcherTheme = themeMap[settings.theme] || 'default';
    if ((window as any).themeSwitcher) {
      (window as any).themeSwitcher.switchTheme(switcherTheme);
    } else {
      // Theme switcher not ready yet, retry after a short delay
      console.warn('ThemeSwitcher not ready, retrying...');
      setTimeout(() => {
        if ((window as any).themeSwitcher) {
          (window as any).themeSwitcher.switchTheme(switcherTheme);
        } else {
          console.error('ThemeSwitcher failed to initialize');
        }
      }, 100);
    }

    // Also keep body class for a11y.css component-specific styles
    body.classList.remove(
      'a11y-theme-dark',
      'a11y-theme-cream',
      'a11y-theme-high-contrast',
      'a11y-theme-protanopia',
      'a11y-theme-deuteranopia',
      'a11y-theme-tritanopia',
      'a11y-theme-monochrome'
    );
    if (settings.theme !== 'default') {
      body.classList.add(`a11y-theme-${settings.theme}`);
    }

    // Announce changes if screen reader mode is on
    if (settings.screenReaderMode) {
      announce('Accessibility settings updated');
    }
  }

  // ===================================
  // INITIALIZE PANEL
  // ===================================
  function initPanel() {
    const panel = document.getElementById('a11y-panel');
    if (!panel) return;

    const header = panel.querySelector('.a11y-panel__header');
    const mode = header?.getAttribute('data-mode') || 'modal';
    const isPageMode = mode === 'page';

    // Get elements - some are only needed in modal mode
    const trigger = document.querySelector('.a11y-panel-trigger');
    const backdrop = document.querySelector('.a11y-panel__backdrop');
    const closeBtn = panel.querySelector('.a11y-panel__close');
    const themeList = panel.querySelector('.a11y-theme-list');

    // In modal mode, require backdrop (trigger is optional when using external trigger like SideTabs)
    if (!isPageMode && !backdrop) return;

    let settings = getSettings();

    // Apply saved settings on load
    applySettings(settings);
    updateUI(settings);

    // Modal-specific: Panel open/close functions and event listeners
    if (!isPageMode && backdrop) {
      function openPanel() {
        panel.classList.add('is-open');
        backdrop!.classList.add('is-visible');
        trigger?.setAttribute('aria-expanded', 'true');
        panel.removeAttribute('hidden');
        backdrop!.removeAttribute('hidden');

        const firstInput = panel.querySelector('input, button:not(.a11y-panel__close)') as HTMLElement;
        firstInput?.focus();

        if (settings.screenReaderMode) {
          announce('Accessibility panel opened');
        }
      }

      function closePanel() {
        panel.classList.remove('is-open');
        backdrop!.classList.remove('is-visible');
        trigger?.setAttribute('aria-expanded', 'false');

        setTimeout(() => {
          panel.setAttribute('hidden', '');
          backdrop!.setAttribute('hidden', '');
        }, 300);

        // Only focus trigger if it exists, otherwise focus the external trigger
        if (trigger) {
          (trigger as HTMLElement).focus();
        } else {
          // Try to focus the SideTabs accessibility button as fallback
          const externalTrigger = document.querySelector('[data-action="accessibility"]') as HTMLElement;
          externalTrigger?.focus();
        }

        if (settings.screenReaderMode) {
          announce('Accessibility panel closed');
        }
      }

      // Event listeners for built-in trigger (only if it exists)
      if (trigger) {
        trigger.addEventListener('click', () => {
          const isOpen = trigger.getAttribute('aria-expanded') === 'true';
          if (isOpen) {
            closePanel();
          } else {
            openPanel();
          }
        });
      }

      closeBtn?.addEventListener('click', closePanel);
      backdrop.addEventListener('click', closePanel);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel.classList.contains('is-open')) {
          closePanel();
        }
      });
    }

    // Toggle settings (both modes)
    const toggles = panel.querySelectorAll('input[type="checkbox"]');
    toggles.forEach(toggle => {
      const setting = (toggle as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        toggle.addEventListener('change', () => {
          (settings as any)[setting] = (toggle as HTMLInputElement).checked;
          saveSettings(settings);
          applySettings(settings);

          if (settings.screenReaderMode) {
            const label = toggle.closest('.a11y-setting')?.querySelector('.a11y-setting__label')?.textContent;
            announce(`${label} ${(toggle as HTMLInputElement).checked ? 'enabled' : 'disabled'}`);
          }
        });
      }
    });

    // Slider settings
    const sliders = panel.querySelectorAll('input[type="range"]');
    sliders.forEach(slider => {
      const setting = (slider as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        slider.addEventListener('input', () => {
          const value = parseInt((slider as HTMLInputElement).value, 10);
          (settings as any)[setting] = value;
          saveSettings(settings);
          applySettings(settings);
          updateSliderValue(setting, value);
        });
      }
    });

    // Font Family Dropdown
    const fontTrigger = document.getElementById('a11y-font-trigger');
    const fontDropdown = document.getElementById('a11y-font-dropdown');
    const fontCurrentLabel = document.getElementById('a11y-font-current');

    // Toggle dropdown
    fontTrigger?.addEventListener('click', () => {
      const isOpen = fontDropdown?.classList.contains('show');
      fontDropdown?.classList.toggle('show');
      fontTrigger.setAttribute('aria-expanded', (!isOpen).toString());
    });

    // Handle font selection
    fontDropdown?.addEventListener('click', (e) => {
      const item = (e.target as HTMLElement).closest('.dropdown-item') as HTMLButtonElement;
      if (!item) return;

      const value = item.dataset.value || 'default';
      const label = item.textContent || 'Default Font';

      // Update selection state
      fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
        btn.classList.remove('is-selected');
        btn.setAttribute('aria-selected', 'false');
      });
      item.classList.add('is-selected');
      item.setAttribute('aria-selected', 'true');

      // Update trigger label
      if (fontCurrentLabel) fontCurrentLabel.textContent = label;

      // Close dropdown
      fontDropdown.classList.remove('show');
      fontTrigger?.setAttribute('aria-expanded', 'false');

      // Save and apply
      settings.fontFamily = value;
      saveSettings(settings);
      applySettings(settings);

      if (settings.screenReaderMode) {
        announce(`Font changed to ${label}`);
      }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!fontTrigger?.contains(e.target as Node) && !fontDropdown?.contains(e.target as Node)) {
        fontDropdown?.classList.remove('show');
        fontTrigger?.setAttribute('aria-expanded', 'false');
      }
    });

    // Theme buttons - use event delegation for dynamically generated cards
    themeList?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.a11y-theme-card') as HTMLButtonElement;
      if (!btn) return;

      const theme = btn.dataset.theme || 'default';
      settings.theme = theme;
      saveSettings(settings);
      applySettings(settings);

      // Update all theme cards' aria-pressed state
      themeList.querySelectorAll('.a11y-theme-card').forEach(b => b.setAttribute('aria-pressed', 'false'));
      btn.setAttribute('aria-pressed', 'true');

      if (settings.screenReaderMode) {
        announce(`Color theme changed to ${theme}`);
      }
    });

    // Reset Button
    const resetBtn = document.getElementById('a11y-reset');
    resetBtn?.addEventListener('click', () => {
      settings = { ...defaultSettings };
      saveSettings(settings);
      applySettings(settings);
      updateUI(settings);

      // Remove active state from all presets
      document.querySelectorAll('.a11y-preset-btn').forEach(btn => btn.classList.remove('active'));

      // Also clear plain mode (Easy Read)
      document.body.classList.remove('plain');
      localStorage.removeItem('a11y-plain-mode');

      if (settings.screenReaderMode) {
        announce('All accessibility settings reset to defaults');
      }

      // Refresh page to reinitialize Isotope grid layouts
      setTimeout(() => location.reload(), 100);
    });

    // Preset Buttons
    const presetButtons = document.querySelectorAll('.a11y-preset-btn');

    const presets = {
      dyslexia: {
        fontFamily: 'opendyslexic',
        fontSize: 110,
        letterSpacing: 3,
        wordSpacing: 4,
        lineHeight: 150
      },
      'low-vision': {
        fontSize: 150,
        theme: 'high-contrast',
        enhancedFocus: true
      },
      'color-blind': {
        theme: 'deuteranopia'
      },
      motor: {
        enhancedFocus: true,
        fontSize: 120,
        reduceMotion: true
      },
      cognitive: {
        reduceMotion: true,
        fontSize: 110,
        lineHeight: 160
      },
      clear: { ...defaultSettings }
    };

    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.getAttribute('data-preset') as string;

        if (preset === 'clear') {
          settings = { ...defaultSettings };
        } else if (preset === 'easyread') {
          // Toggle plain mode class on body
          const isActive = document.body.classList.toggle('plain');
          // Save plain mode state to localStorage
          localStorage.setItem('a11y-plain-mode', isActive ? 'true' : 'false');
          // Update button active state based on toggle
          if (isActive) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
          // Dispatch event for Isotope grids to re-layout
          window.dispatchEvent(new CustomEvent('plainModeToggled', {
            detail: { enabled: isActive }
          }));
          if (settings.screenReaderMode) {
            announce(isActive ? 'Easy read mode enabled' : 'Easy read mode disabled');
          }
          // Refresh page to reinitialize Isotope grid layouts
          setTimeout(() => location.reload(), 100);
          return; // Exit early - don't process as regular preset
        } else if (presets[preset as keyof typeof presets]) {
          settings = {
            ...settings,
            ...presets[preset as keyof typeof presets]
          };
        }

        // Update active state
        presetButtons.forEach(b => b.classList.remove('active'));
        if (preset !== 'clear') {
          btn.classList.add('active');
        }

        saveSettings(settings);
        applySettings(settings);
        updateUI(settings);

        if (settings.screenReaderMode) {
          announce(`${btn.querySelector('.a11y-preset-btn__title')?.textContent} preset applied`);
        }
      });
    });

    // Restore plain mode state on page load
    const savedPlainMode = localStorage.getItem('a11y-plain-mode');
    if (savedPlainMode === 'true') {
      document.body.classList.add('plain');
      const easyReadBtn = document.querySelector('.a11y-preset-btn[data-preset="easyread"]');
      easyReadBtn?.classList.add('active');
    }

    // PDF Download
    const downloadBtn = document.getElementById('a11y-download-pdf');
    downloadBtn?.addEventListener('click', () => {
      // In modal mode, close panel before printing
      if (!isPageMode) {
        const closePanel = () => {
          panel.classList.remove('is-open');
          if (backdrop) {
            backdrop.classList.remove('is-visible');
          }
          if (trigger) {
            trigger.setAttribute('aria-expanded', 'false');
          }
          setTimeout(() => {
            panel.setAttribute('hidden', '');
            if (backdrop) {
              backdrop.setAttribute('hidden', '');
            }
          }, 300);
        };
        closePanel();
        setTimeout(() => {
          window.print();
        }, 350);
      } else {
        // In page mode, print directly
        window.print();
      }
    });

    // Update UI from settings
    function updateUI(s: A11ySettings) {
      // Toggles
      const toggleMap: Record<string, string> = {
        textOnly: 'a11y-text-only',
        highlightLinks: 'a11y-highlight-links',
        dyslexiaFont: 'a11y-dyslexia-font',
        reduceMotion: 'a11y-reduce-motion',
        enhancedFocus: 'a11y-enhanced-focus',
        screenReaderMode: 'a11y-screen-reader'
      };

      Object.entries(toggleMap).forEach(([key, id]) => {
        const toggle = document.getElementById(id) as HTMLInputElement;
        if (toggle) toggle.checked = (s as any)[key];
      });

      // Font Family Dropdown - restore selection state
      const fontDropdown = document.getElementById('a11y-font-dropdown');
      const fontCurrentLabel = document.getElementById('a11y-font-current');
      if (fontDropdown && s.fontFamily) {
        // Update dropdown items
        fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
          const isSelected = btn.getAttribute('data-value') === s.fontFamily;
          btn.classList.toggle('is-selected', isSelected);
          btn.setAttribute('aria-selected', isSelected.toString());
          if (isSelected && fontCurrentLabel) {
            fontCurrentLabel.textContent = btn.textContent || 'Default Font';
          }
        });
      }

      // Sliders
      const sliderMap: Record<string, string> = {
        fontSize: 'a11y-font-size',
        letterSpacing: 'a11y-letter-spacing',
        wordSpacing: 'a11y-word-spacing',
        lineHeight: 'a11y-line-height'
      };

      Object.entries(sliderMap).forEach(([key, id]) => {
        const slider = document.getElementById(id) as HTMLInputElement;
        if (slider) slider.value = (s as any)[key].toString();
        updateSliderValue(key, (s as any)[key]);
      });

      // Theme buttons - query them directly since they're dynamically generated
      const themeCards = panel.querySelectorAll('.a11y-theme-card');
      themeCards?.forEach(btn => {
        const theme = (btn as HTMLButtonElement).dataset.theme;
        btn.setAttribute('aria-pressed', theme === s.theme ? 'true' : 'false');
      });
    }

    function updateSliderValue(setting: string, value: number) {
      const valueEl = document.getElementById(`${setting.replace(/([A-Z])/g, '-$1').toLowerCase()}-value`);
      if (!valueEl) return;

      switch (setting) {
        case 'fontSize':
          valueEl.textContent = `${value}%`;
          break;
        case 'letterSpacing':
        case 'wordSpacing':
          valueEl.textContent = value === 0 ? 'Normal' : `+${value}`;
          break;
        case 'lineHeight':
          valueEl.textContent = value === 100 ? 'Normal' : `${value}%`;
          break;
      }
    }
  }

  // ===================================
  // KEYBOARD DETECTION
  // ===================================
  function initKeyboardDetection() {
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Tab') {
        document.body.classList.add('using-keyboard');
      }
    });

    document.addEventListener('mousedown', () => {
      document.body.classList.remove('using-keyboard');
    });
  }

  // ===================================
  // EXPOSE GLOBAL API
  // ===================================
  (window as any).a11y = {
    announce,
    FocusTrap,
    prefersReducedMotion,
    prefersHighContrast,
    getSettings,
    applySettings
  };

  // ===================================
  // INITIALIZE
  // ===================================
  function init() {
    initPanel();
    initKeyboardDetection();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Astro page transitions
  document.addEventListener('astro:page-load', init);
</script>
