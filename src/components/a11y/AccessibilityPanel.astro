---
/**
 * AccessibilityPanel - Complete Accessibility Solution (All-in-One)
 *
 * A comprehensive accessibility panel with theme switching, typography controls,
 * and various accessibility presets.
 *
 * Sub-components in "A11y Panel" folder:
 * - Announcer: Screen reader live regions
 * - Toggle: Toggle switch component
 * - Slider: Range slider component
 * - PresetButton: Preset button component
 * - ThemeSidebar: Theme cards sidebar
 * - PresetsSidebar: Quick presets sidebar
 * - VisualSection: Visual settings section
 * - TypographySection: Typography settings section
 * - NavigationSection: Navigation & Motion section
 */

interface Props {
  /**
   * Display mode: 'modal' (overlay) or 'page' (standalone page)
   */
  mode?: 'modal' | 'page';
}

const { mode = 'modal' } = Astro.props;

// Import sub-components
import Announcer from '../A11y Panel/Announcer.astro';
import ThemeSidebar from '../A11y Panel/ThemeSidebar.astro';
import PresetsSidebar from '../A11y Panel/PresetsSidebar.astro';
import VisualSection from '../A11y Panel/VisualSection.astro';
import TypographySection from '../A11y Panel/TypographySection.astro';
import NavigationSection from '../A11y Panel/NavigationSection.astro';
import Icon from '../Icons/Icon.astro';
---

<!-- Screen Reader Announcer -->
<Announcer />

<!-- Accessibility Panel -->
<div
  class={mode === 'page' ? 'a11y-panel a11y-panel--page' : 'a11y-panel'}
  id="a11y-panel"
  role={mode === 'modal' ? 'dialog' : undefined}
  aria-label="Accessibility settings"
  aria-modal={mode === 'modal' ? 'true' : undefined}
  hidden={mode === 'modal' ? true : undefined}
>
  <div class="a11y-panel__header" data-mode={mode}>
    <h2 class="a11y-panel__title">
      Accessibility
    </h2>
    <div class="a11y-panel__header-actions">
      <button class="btn btn-sm btn-ghost" id="a11y-reset" aria-label="Reset all settings">
        <Icon name="a11y-panel/arrow-counter-clockwise-fill" size={18} />
        Reset All
      </button>
      {mode === 'modal' && (
        <button class="a11y-panel__close" type="button" aria-label="Close accessibility panel">
          <Icon name="x-square-fill" size={24} />
        </button>
      )}
    </div>
  </div>

  <div class="a11y-panel__body">
    <!-- Left Sidebar: Theme Cards -->
    <ThemeSidebar />

    <!-- Main Content Area -->
    <div class="a11y-panel__content">
      <VisualSection />
      <TypographySection />
      <NavigationSection />
    </div>

    <!-- Right Sidebar: Quick Presets -->
    <PresetsSidebar />
  </div>
</div>

{mode === 'modal' && (
  <!-- Backdrop -->
  <div class="a11y-panel__backdrop" hidden></div>
)}

<style is:global>
  /* Panel Container - Modal Mode */
  .a11y-panel {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.95);
    width: 95vw;
    max-width: 1400px;
    height: 90vh;
    max-height: 900px;
    background: var(--color-Background-50);
    color: var(--color-Text-900);
    z-index: 10001;
    border-radius: var(--radius-lg);
    box-shadow: 0 20px 60px var(--color-Black-30);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    font-family: var(--font-body);
  }

  .a11y-panel[hidden] {
    display: flex;
  }

  .a11y-panel.is-open {
    opacity: 1;
    visibility: visible;
    transform: translate(-50%, -50%) scale(1);
  }

  /* Panel Container - Page Mode */
  .a11y-panel--page {
    position: relative;
    top: auto;
    left: auto;
    transform: none;
    width: 100%;
    max-width: 1400px;
    height: auto;
    max-height: none;
    margin: 0 auto;
    opacity: 1;
    visibility: visible;
    box-shadow: none;
    border-radius: 0;
    z-index: auto;
  }

  .a11y-panel--page[hidden] {
    display: flex !important;
  }

  /* Header */
  .a11y-panel__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-sm) var(--space-lg);
    border-bottom: var(--border-width-md) solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
    background: var(--color-Background-50);
  }

  .a11y-panel__title {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-bold);
    margin: 0;
    color: var(--color-Text-900);
  }

  .a11y-panel__header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }

  .a11y-panel__close {
    display: block;
    width: 44px;
    height: 44px;
    padding: 0;
    background: none;
    border: none;
    color: var(--color-Primary-500);
    cursor: pointer;
    transition: color var(--transition-fast);
  }

  .a11y-panel__close svg {
    width: 100%;
    height: 100%;
  }

  .a11y-panel__close:hover {
    color: var(--color-Primary-700);
  }

  /* Body Layout */
  .a11y-panel__body {
    display: flex;
    flex: 1;
    overflow: hidden;
  }

  /* Main Content Area - 3 Column Grid */
  .a11y-panel__content {
    flex: 1;
    overflow-y: auto;
    padding: 24px 32px 32px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    align-content: start;
  }

  /* Left Sidebar - Theme Cards */
  .a11y-panel__sidebar {
    width: 240px;
    min-width: 240px;
    background: var(--color-Background-50);
    border-right: 1px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
    padding: 20px 14px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  /* Right Sidebar - Presets */
  .a11y-panel__sidebar-right {
    width: 280px;
    min-width: 280px;
    background: var(--color-Background-50);
    border-left: 1px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
    padding: 20px 16px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
  }

  .a11y-sidebar__title {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--color-Text-900) !important;
    margin: 0 0 12px 0;
    padding: 0 0 12px 0;
    border-bottom: 2px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
  }

  .a11y-theme-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .a11y-preset-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  /* Sections - Dashboard Cards */
  .a11y-section {
    padding: 16px 0;
  }

  .a11y-section--full {
    grid-column: 1 / -1;
  }

  .a11y-section__title {
    font-size: 16px;
    font-weight: 700;
    letter-spacing: 0.5px;
    color: var(--color-Text-900) !important;
    margin: 0 0 12px 0;
    padding: 0 0 12px 0;
    border-bottom: 2px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
  }

  /* Settings */
  .a11y-setting {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px;
    background: var(--color-Background-50);
    border-radius: 6px;
    margin-bottom: 10px;
  }

  .a11y-setting:last-child {
    margin-bottom: 0;
  }

  .a11y-setting--slider,
  .a11y-setting--font {
    flex-direction: column;
    align-items: stretch;
  }

  .a11y-setting__header {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .a11y-setting--slider .a11y-setting__header {
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    margin-bottom: 10px;
  }

  .a11y-setting--font .a11y-setting__header {
    flex-direction: column;
    align-items: flex-start;
    width: 100%;
    margin-bottom: 10px;
    gap: 4px;
  }

  .a11y-setting__label {
    font-weight: 700;
    font-size: 15px;
    color: var(--color-Text-900) !important;
  }

  .a11y-setting__desc {
    font-size: 13px;
    color: var(--color-Text-600) !important;
  }

  .a11y-setting__value {
    font-size: 14px;
    color: var(--color-Primary-500);
    font-weight: 600;
  }

  /* Toggle Switch */
  .a11y-toggle {
    position: relative;
    display: inline-block;
    width: 44px;
    height: 24px;
    flex-shrink: 0;
  }

  .a11y-toggle input {
    opacity: 0;
    width: 0;
    height: 0;
  }

  .a11y-toggle__slider {
    position: absolute;
    cursor: pointer;
    inset: 0;
    background: color-mix(in srgb, var(--color-Primary-500) 30%, var(--color-Background-300));
    border-radius: 24px;
    transition: background 0.2s;
    border: 1px solid var(--color-Background-400);
  }

  .a11y-toggle__slider::before {
    content: '';
    position: absolute;
    height: 18px;
    width: 18px;
    left: 3px;
    bottom: 3px;
    background: var(--color-Background-50);
    border: 1px solid var(--color-Background-400);
    border-radius: 50%;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s;
  }

  .a11y-toggle input:checked + .a11y-toggle__slider {
    background: var(--color-Primary-500);
  }

  .a11y-toggle input:checked + .a11y-toggle__slider::before {
    transform: translateX(20px);
  }

  .a11y-toggle input:focus-visible + .a11y-toggle__slider {
    outline: 2px solid var(--color-Primary-500);
    outline-offset: 2px;
  }

  /* Slider */
  .a11y-slider {
    width: 100%;
    height: 6px;
    border-radius: 3px;
    background: color-mix(in srgb, var(--color-Primary-500) 40%, var(--color-Background-300));
    outline: none;
    -webkit-appearance: none;
    appearance: none;
  }

  .a11y-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--color-Primary-500);
    border: 2px solid var(--color-Background-50);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.2s;
  }

  .a11y-slider::-webkit-slider-thumb:hover {
    transform: scale(1.1);
  }

  .a11y-slider::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: var(--color-Primary-500);
    border: 2px solid var(--color-Background-50);
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .a11y-slider:focus-visible {
    outline: 2px solid var(--color-Primary-500);
    outline-offset: 2px;
  }

  .a11y-slider__labels {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    color: var(--color-Text-500);
    font-size: 11px;
  }

  /* Preset Buttons */
  .a11y-preset-btn {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 18px 20px;
    background: var(--color-Background-100);
    color: var(--color-Primary-500);
    border: 2px solid var(--color-Background-300);
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    width: 100%;
  }

  .a11y-preset-btn:hover {
    transform: translateX(3px);
    background: var(--color-Background-200);
    border-color: var(--color-Primary-300);
  }

  .a11y-preset-btn:focus-visible {
    outline: 2px solid var(--color-Primary-500);
    outline-offset: 2px;
  }

  .a11y-preset-btn:active,
  .a11y-preset-btn.active {
    border-color: var(--color-Primary-500);
    background: var(--color-Primary-100);
  }

  .a11y-preset-btn__icon {
    width: 40px;
    height: 40px;
    flex-shrink: 0;
  }

  .a11y-preset-btn__icon svg {
    fill: var(--color-Primary-500);
  }

  .a11y-preset-btn__text {
    display: flex;
    flex-direction: column;
    gap: 3px;
    min-width: 0;
    flex: 1;
  }

  .a11y-preset-btn__title {
    font-size: 16px;
    font-weight: 600;
    line-height: 1.2;
    letter-spacing: -0.01em;
    color: var(--color-Text-900);
  }

  .a11y-preset-btn__subtitle {
    font-size: 13px;
    line-height: 1.3;
    color: var(--color-Text-500);
  }

  /* Font Dropdown */
  .a11y-font-dropdown {
    position: relative;
    width: 100%;
  }

  .a11y-font-trigger {
    width: 100%;
    justify-content: space-between;
    padding: 10px 12px;
    background: var(--color-Background-50);
    border: 2px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
    border-radius: 6px;
    color: var(--color-Text-900);
    font-size: 13px;
    font-weight: 500;
  }

  .a11y-font-trigger:hover {
    border-color: var(--color-Primary-500);
  }

  .a11y-font-trigger[aria-expanded="true"] {
    border-color: var(--color-Primary-500);
  }

  .a11y-font-trigger[aria-expanded="true"] .a11y-font-chevron {
    transform: rotate(-90deg);
  }

  .a11y-font-chevron {
    transform: rotate(180deg);
    transition: transform 0.2s ease;
    flex-shrink: 0;
  }

  .a11y-font-dropdown .dropdown-menu {
    width: 100%;
    margin-top: 4px;
    background: var(--color-Background-50);
    backdrop-filter: none;
    -webkit-backdrop-filter: none;
    border: 2px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
  }

  /* Backdrop */
  .a11y-panel__backdrop {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.6);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    pointer-events: none;
  }

  .a11y-panel__backdrop[hidden] {
    display: block;
  }

  .a11y-panel__backdrop.is-visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* Responsive - Mobile */
  @media (max-width: 768px) {
    .a11y-panel {
      width: 100vw;
      height: 100vh;
      max-width: 100vw;
      max-height: 100vh;
      border-radius: 0;
      top: 0;
      left: 0;
      transform: translateY(100%);
    }

    .a11y-panel.is-open {
      transform: translateY(0);
    }

    .a11y-panel__header {
      flex-direction: column;
      align-items: flex-start;
      gap: 12px;
      padding: 16px;
    }

    .a11y-panel__header-actions {
      width: 100%;
      justify-content: space-between;
    }

    .a11y-panel__body {
      flex-direction: column;
    }

    .a11y-panel__sidebar {
      width: 100%;
      min-width: 100%;
      max-height: 200px;
      border-right: none;
      border-bottom: 1px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
      padding: 12px;
    }

    .a11y-sidebar__title {
      margin-bottom: 10px;
    }

    .a11y-theme-list {
      flex-direction: row;
      flex-wrap: wrap;
      gap: 6px;
    }

    .a11y-panel__sidebar-right {
      width: 100%;
      min-width: 100%;
      border-left: none;
      border-top: 1px solid color-mix(in srgb, var(--color-Primary-500) 35%, var(--color-Background-300));
      padding: 12px;
    }

    .a11y-panel__content {
      padding: 16px;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .a11y-preset-list {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .a11y-section {
      padding: 12px;
    }
  }

  /* Responsive - Tablet */
  @media (min-width: 769px) and (max-width: 1024px) {
    .a11y-panel__content {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
  }

  /* Responsive - Small Desktop */
  @media (min-width: 1025px) and (max-width: 1400px) {
    .a11y-panel {
      max-width: 1000px;
    }

    .a11y-panel__content {
      grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<script>
  import {
    type A11ySettings,
    defaultSettings,
    getSettings,
    saveSettings,
    announce,
    applySettings,
    presets,
    formatSliderValue,
    initKeyboardDetection
  } from '../../lib/ui/a11y-panel';

  // ===================================
  // INITIALIZE PANEL
  // ===================================
  function initPanel(): void {
    const panel = document.getElementById('a11y-panel');
    if (!panel) return;

    const header = panel.querySelector('.a11y-panel__header');
    const mode = header?.getAttribute('data-mode') || 'modal';
    const isPageMode = mode === 'page';

    // Get elements - some are only needed in modal mode
    const trigger = document.querySelector('.a11y-panel-trigger');
    const backdrop = document.querySelector('.a11y-panel__backdrop');
    const closeBtn = panel.querySelector('.a11y-panel__close');
    const themeList = panel.querySelector('.a11y-theme-list');

    // In modal mode, require backdrop
    if (!isPageMode && !backdrop) return;

    let settings = getSettings();

    // Apply saved settings on load
    applySettings(settings);
    updateUI(settings);

    // Modal-specific: Panel open/close functions and event listeners
    if (!isPageMode && backdrop) {
      function openPanel(): void {
        if (!panel) return;
        panel.classList.add('is-open');
        backdrop!.classList.add('is-visible');
        trigger?.setAttribute('aria-expanded', 'true');
        panel.removeAttribute('hidden');
        backdrop!.removeAttribute('hidden');

        const firstInput = panel.querySelector('input, button:not(.a11y-panel__close)') as HTMLElement;
        firstInput?.focus();

        if (settings.screenReaderMode) {
          announce('Accessibility panel opened');
        }
      }

      function closePanel(): void {
        if (!panel) return;
        panel.classList.remove('is-open');
        backdrop!.classList.remove('is-visible');
        trigger?.setAttribute('aria-expanded', 'false');

        setTimeout(() => {
          panel.setAttribute('hidden', '');
          backdrop!.setAttribute('hidden', '');
        }, 300);

        if (trigger) {
          (trigger as HTMLElement).focus();
        } else {
          const externalTrigger = document.querySelector('[data-action="accessibility"]') as HTMLElement;
          externalTrigger?.focus();
        }

        if (settings.screenReaderMode) {
          announce('Accessibility panel closed');
        }
      }

      // Event listeners for built-in trigger
      if (trigger) {
        trigger.addEventListener('click', () => {
          const isOpen = trigger.getAttribute('aria-expanded') === 'true';
          if (isOpen) {
            closePanel();
          } else {
            openPanel();
          }
        });
      }

      closeBtn?.addEventListener('click', closePanel);
      backdrop.addEventListener('click', closePanel);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel.classList.contains('is-open')) {
          closePanel();
        }
      });
    }

    // Toggle settings (both modes)
    const toggles = panel.querySelectorAll('input[type="checkbox"]');
    toggles.forEach(toggle => {
      const setting = (toggle as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        toggle.addEventListener('change', () => {
          (settings as any)[setting] = (toggle as HTMLInputElement).checked;
          saveSettings(settings);
          applySettings(settings);

          if (settings.screenReaderMode) {
            const label = toggle.closest('.a11y-setting')?.querySelector('.a11y-setting__label')?.textContent;
            announce(`${label} ${(toggle as HTMLInputElement).checked ? 'enabled' : 'disabled'}`);
          }
        });
      }
    });

    // Slider settings
    const sliders = panel.querySelectorAll('input[type="range"]');
    sliders.forEach(slider => {
      const setting = (slider as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        slider.addEventListener('input', () => {
          const value = parseInt((slider as HTMLInputElement).value, 10);
          (settings as any)[setting] = value;
          saveSettings(settings);
          applySettings(settings);
          updateSliderValue(setting, value);
        });
      }
    });

    // Font Family Dropdown
    const fontTrigger = document.getElementById('a11y-font-trigger');
    const fontDropdown = document.getElementById('a11y-font-dropdown');
    const fontCurrentLabel = document.getElementById('a11y-font-current');

    fontTrigger?.addEventListener('click', () => {
      const isOpen = fontDropdown?.classList.contains('show');
      fontDropdown?.classList.toggle('show');
      fontTrigger.setAttribute('aria-expanded', (!isOpen).toString());
    });

    fontDropdown?.addEventListener('click', (e) => {
      const item = (e.target as HTMLElement).closest('.dropdown-item') as HTMLButtonElement;
      if (!item) return;

      const value = item.dataset.value || 'default';
      const label = item.textContent || 'Default Font';

      fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
        btn.classList.remove('is-selected');
        btn.setAttribute('aria-selected', 'false');
      });
      item.classList.add('is-selected');
      item.setAttribute('aria-selected', 'true');

      if (fontCurrentLabel) fontCurrentLabel.textContent = label;

      fontDropdown.classList.remove('show');
      fontTrigger?.setAttribute('aria-expanded', 'false');

      settings.fontFamily = value;
      saveSettings(settings);
      applySettings(settings);

      if (settings.screenReaderMode) {
        announce(`Font changed to ${label}`);
      }
    });

    document.addEventListener('click', (e) => {
      if (!fontTrigger?.contains(e.target as Node) && !fontDropdown?.contains(e.target as Node)) {
        fontDropdown?.classList.remove('show');
        fontTrigger?.setAttribute('aria-expanded', 'false');
      }
    });

    // Theme buttons - use event delegation for dynamically generated cards
    themeList?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.a11y-theme-card') as HTMLButtonElement;
      if (!btn) return;

      const theme = btn.dataset.theme || 'default';
      settings.theme = theme;
      saveSettings(settings);
      applySettings(settings);

      themeList.querySelectorAll('.a11y-theme-card').forEach(b => b.setAttribute('aria-pressed', 'false'));
      btn.setAttribute('aria-pressed', 'true');

      if (settings.screenReaderMode) {
        announce(`Color theme changed to ${theme}`);
      }
    });

    // Reset Button
    const resetBtn = document.getElementById('a11y-reset');
    resetBtn?.addEventListener('click', () => {
      settings = { ...defaultSettings };
      saveSettings(settings);
      applySettings(settings);
      updateUI(settings);

      document.querySelectorAll('.a11y-preset-btn').forEach(btn => btn.classList.remove('active'));

      document.body.classList.remove('plain');
      localStorage.removeItem('a11y-plain-mode');

      if (settings.screenReaderMode) {
        announce('All accessibility settings reset to defaults');
      }

      setTimeout(() => location.reload(), 100);
    });

    // Preset Buttons
    const presetButtons = document.querySelectorAll('.a11y-preset-btn');

    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.getAttribute('data-preset') as string;

        if (preset === 'clear') {
          settings = { ...defaultSettings };
        } else if (preset === 'easyread') {
          const isActive = document.body.classList.toggle('plain');
          localStorage.setItem('a11y-plain-mode', isActive ? 'true' : 'false');
          if (isActive) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
          window.dispatchEvent(new CustomEvent('plainModeToggled', {
            detail: { enabled: isActive }
          }));
          if (settings.screenReaderMode) {
            announce(isActive ? 'Easy read mode enabled' : 'Easy read mode disabled');
          }
          setTimeout(() => location.reload(), 100);
          return;
        } else if (presets[preset]) {
          settings = {
            ...settings,
            ...presets[preset]
          };
        }

        presetButtons.forEach(b => b.classList.remove('active'));
        if (preset !== 'clear') {
          btn.classList.add('active');
        }

        saveSettings(settings);
        applySettings(settings);
        updateUI(settings);

        if (settings.screenReaderMode) {
          announce(`${btn.querySelector('.a11y-preset-btn__title')?.textContent} preset applied`);
        }
      });
    });

    // Restore plain mode state on page load
    const savedPlainMode = localStorage.getItem('a11y-plain-mode');
    if (savedPlainMode === 'true') {
      document.body.classList.add('plain');
      const easyReadBtn = document.querySelector('.a11y-preset-btn[data-preset="easyread"]');
      easyReadBtn?.classList.add('active');
    }

    // PDF Download
    const downloadBtn = document.getElementById('a11y-download-pdf');
    downloadBtn?.addEventListener('click', () => {
      if (!isPageMode) {
        const closePanel = (): void => {
          if (!panel) return;
          panel.classList.remove('is-open');
          if (backdrop) {
            backdrop.classList.remove('is-visible');
          }
          if (trigger) {
            trigger.setAttribute('aria-expanded', 'false');
          }
          setTimeout(() => {
            panel.setAttribute('hidden', '');
            if (backdrop) {
              backdrop.setAttribute('hidden', '');
            }
          }, 300);
        };
        closePanel();
        setTimeout(() => {
          window.print();
        }, 350);
      } else {
        window.print();
      }
    });

    // Update UI from settings
    function updateUI(s: A11ySettings): void {
      const toggleMap: Record<string, string> = {
        textOnly: 'a11y-text-only',
        highlightLinks: 'a11y-highlight-links',
        dyslexiaFont: 'a11y-dyslexia-font',
        reduceMotion: 'a11y-reduce-motion',
        enhancedFocus: 'a11y-enhanced-focus',
        screenReaderMode: 'a11y-screen-reader'
      };

      Object.entries(toggleMap).forEach(([key, id]) => {
        const toggle = document.getElementById(id) as HTMLInputElement;
        if (toggle) toggle.checked = (s as any)[key];
      });

      const fontDropdown = document.getElementById('a11y-font-dropdown');
      const fontCurrentLabel = document.getElementById('a11y-font-current');
      if (fontDropdown && s.fontFamily) {
        fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
          const isSelected = btn.getAttribute('data-value') === s.fontFamily;
          btn.classList.toggle('is-selected', isSelected);
          btn.setAttribute('aria-selected', isSelected.toString());
          if (isSelected && fontCurrentLabel) {
            fontCurrentLabel.textContent = btn.textContent || 'Default Font';
          }
        });
      }

      const sliderMap: Record<string, string> = {
        fontSize: 'a11y-font-size',
        letterSpacing: 'a11y-letter-spacing',
        wordSpacing: 'a11y-word-spacing',
        lineHeight: 'a11y-line-height'
      };

      Object.entries(sliderMap).forEach(([key, id]) => {
        const slider = document.getElementById(id) as HTMLInputElement;
        if (slider) slider.value = (s as any)[key].toString();
        updateSliderValue(key, (s as any)[key]);
      });

      const themeCards = document.querySelectorAll('.a11y-theme-card');
      themeCards.forEach(btn => {
        const theme = (btn as HTMLButtonElement).dataset.theme;
        btn.setAttribute('aria-pressed', theme === s.theme ? 'true' : 'false');
      });
    }

    function updateSliderValue(setting: string, value: number): void {
      const valueEl = document.getElementById(`${setting.replace(/([A-Z])/g, '-$1').toLowerCase()}-value`);
      if (valueEl) {
        valueEl.textContent = formatSliderValue(setting, value);
      }
    }
  }

  // ===================================
  // INITIALIZE
  // ===================================
  function init(): void {
    initPanel();
    initKeyboardDetection();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Astro page transitions
  document.addEventListener('astro:page-load', init);
</script>
