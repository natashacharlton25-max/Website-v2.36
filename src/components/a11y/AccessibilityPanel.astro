---
/**
 * AccessibilityPanel - Complete Accessibility Solution (All-in-One)
 *
 * A comprehensive accessibility panel with theme switching, typography controls,
 * and various accessibility presets.
 *
 * Sub-components in "A11y Panel" folder:
 * - Announcer: Screen reader live regions
 * - Toggle: Toggle switch component
 * - Slider: Range slider component
 * - PresetButton: Preset button component
 * - ThemeSidebar: Theme cards sidebar
 * - PresetsSidebar: Quick presets sidebar
 * - VisualSection: Visual settings section
 * - TypographySection: Typography settings section
 * - NavigationSection: Navigation & Motion section
 */

interface Props {
  /**
   * Display mode: 'modal' (overlay) or 'page' (standalone page)
   */
  mode?: 'modal' | 'page';
}

const { mode = 'modal' } = Astro.props;

// Import sub-components
import Announcer from '../A11y Panel/Announcer.astro';
import ThemeSidebar from '../A11y Panel/ThemeSidebar.astro';
import PresetsSidebar from '../A11y Panel/PresetsSidebar.astro';
import VisualSection from '../A11y Panel/VisualSection.astro';
import TypographySection from '../A11y Panel/TypographySection.astro';
import NavigationSection from '../A11y Panel/NavigationSection.astro';
import Icon from '../Icons/Icon.astro';
---

<!-- Screen Reader Announcer -->
<Announcer />

<!-- Accessibility Panel -->
<div
  class={mode === 'page' ? 'a11y-panel a11y-panel--page' : 'a11y-panel'}
  id="a11y-panel"
  role={mode === 'modal' ? 'dialog' : undefined}
  aria-label="Accessibility settings"
  aria-modal={mode === 'modal' ? 'true' : undefined}
  hidden={mode === 'modal' ? true : undefined}
>
  <div class="a11y-panel__header" data-mode={mode}>
    <h2 class="a11y-panel__title">
      Accessibility
    </h2>
    <div class="a11y-panel__header-actions">
      <button class="btn btn-sm btn-ghost" id="a11y-reset" aria-label="Reset all settings">
        <Icon name="a11y-panel/arrow-counter-clockwise-fill" size={18} />
        Reset All
      </button>
      {mode === 'modal' && (
        <button class="a11y-panel__close" type="button" aria-label="Close accessibility panel">
          <Icon name="x-square-fill" size={24} />
        </button>
      )}
    </div>
  </div>

  <div class="a11y-panel__body">
    <!-- Left Sidebar: Theme Cards -->
    <ThemeSidebar />

    <!-- Main Content Area -->
    <div class="a11y-panel__content">
      <VisualSection />
      <TypographySection />
      <NavigationSection />
    </div>

    <!-- Right Sidebar: Quick Presets -->
    <PresetsSidebar />
  </div>
</div>

{mode === 'modal' && (
  <!-- Backdrop -->
  <div class="a11y-panel__backdrop" hidden></div>
)}

<script>
  import {
    type A11ySettings,
    defaultSettings,
    getSettings,
    saveSettings,
    announce,
    applySettings,
    presets,
    formatSliderValue,
    initKeyboardDetection
  } from '../../lib/ui/a11y-panel';

  // ===================================
  // INITIALIZE PANEL
  // ===================================
  function initPanel(): void {
    const panel = document.getElementById('a11y-panel');
    if (!panel) return;

    const header = panel.querySelector('.a11y-panel__header');
    const mode = header?.getAttribute('data-mode') || 'modal';
    const isPageMode = mode === 'page';

    // Get elements - some are only needed in modal mode
    const trigger = document.querySelector('.a11y-panel-trigger');
    const backdrop = document.querySelector('.a11y-panel__backdrop');
    const closeBtn = panel.querySelector('.a11y-panel__close');
    const themeList = panel.querySelector('.a11y-theme-list');

    // In modal mode, require backdrop
    if (!isPageMode && !backdrop) return;

    let settings = getSettings();

    // Apply saved settings on load
    applySettings(settings);
    updateUI(settings);

    // Modal-specific: Panel open/close functions and event listeners
    if (!isPageMode && backdrop) {
      function openPanel(): void {
        if (!panel) return;
        panel.classList.add('is-open');
        backdrop!.classList.add('is-visible');
        trigger?.setAttribute('aria-expanded', 'true');
        panel.removeAttribute('hidden');
        backdrop!.removeAttribute('hidden');

        const firstInput = panel.querySelector('input, button:not(.a11y-panel__close)') as HTMLElement;
        firstInput?.focus();

        if (settings.screenReaderMode) {
          announce('Accessibility panel opened');
        }
      }

      function closePanel(): void {
        if (!panel) return;
        panel.classList.remove('is-open');
        backdrop!.classList.remove('is-visible');
        trigger?.setAttribute('aria-expanded', 'false');

        setTimeout(() => {
          panel.setAttribute('hidden', '');
          backdrop!.setAttribute('hidden', '');
        }, 300);

        if (trigger) {
          (trigger as HTMLElement).focus();
        } else {
          const externalTrigger = document.querySelector('[data-action="accessibility"]') as HTMLElement;
          externalTrigger?.focus();
        }

        if (settings.screenReaderMode) {
          announce('Accessibility panel closed');
        }
      }

      // Event listeners for built-in trigger
      if (trigger) {
        trigger.addEventListener('click', () => {
          const isOpen = trigger.getAttribute('aria-expanded') === 'true';
          if (isOpen) {
            closePanel();
          } else {
            openPanel();
          }
        });
      }

      closeBtn?.addEventListener('click', closePanel);
      backdrop.addEventListener('click', closePanel);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && panel.classList.contains('is-open')) {
          closePanel();
        }
      });
    }

    // Toggle settings (both modes)
    const toggles = panel.querySelectorAll('input[type="checkbox"]');
    toggles.forEach(toggle => {
      const setting = (toggle as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        toggle.addEventListener('change', () => {
          (settings as any)[setting] = (toggle as HTMLInputElement).checked;
          saveSettings(settings);
          applySettings(settings);

          if (settings.screenReaderMode) {
            const label = toggle.closest('.a11y-setting')?.querySelector('.a11y-setting__label')?.textContent;
            announce(`${label} ${(toggle as HTMLInputElement).checked ? 'enabled' : 'disabled'}`);
          }
        });
      }
    });

    // Slider settings
    const sliders = panel.querySelectorAll('input[type="range"]');
    sliders.forEach(slider => {
      const setting = (slider as HTMLInputElement).dataset.setting as keyof A11ySettings;
      if (setting) {
        slider.addEventListener('input', () => {
          const value = parseInt((slider as HTMLInputElement).value, 10);
          (settings as any)[setting] = value;
          saveSettings(settings);
          applySettings(settings);
          updateSliderValue(setting, value);
        });
      }
    });

    // Font Family Dropdown
    const fontTrigger = document.getElementById('a11y-font-trigger');
    const fontDropdown = document.getElementById('a11y-font-dropdown');
    const fontCurrentLabel = document.getElementById('a11y-font-current');

    fontTrigger?.addEventListener('click', () => {
      const isOpen = fontDropdown?.classList.contains('show');
      fontDropdown?.classList.toggle('show');
      fontTrigger.setAttribute('aria-expanded', (!isOpen).toString());
    });

    fontDropdown?.addEventListener('click', (e) => {
      const item = (e.target as HTMLElement).closest('.dropdown-item') as HTMLButtonElement;
      if (!item) return;

      const value = item.dataset.value || 'default';
      const label = item.textContent || 'Default Font';

      fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
        btn.classList.remove('is-selected');
        btn.setAttribute('aria-selected', 'false');
      });
      item.classList.add('is-selected');
      item.setAttribute('aria-selected', 'true');

      if (fontCurrentLabel) fontCurrentLabel.textContent = label;

      fontDropdown.classList.remove('show');
      fontTrigger?.setAttribute('aria-expanded', 'false');

      settings.fontFamily = value;
      saveSettings(settings);
      applySettings(settings);

      if (settings.screenReaderMode) {
        announce(`Font changed to ${label}`);
      }
    });

    document.addEventListener('click', (e) => {
      if (!fontTrigger?.contains(e.target as Node) && !fontDropdown?.contains(e.target as Node)) {
        fontDropdown?.classList.remove('show');
        fontTrigger?.setAttribute('aria-expanded', 'false');
      }
    });

    // Theme buttons - use event delegation for dynamically generated cards
    themeList?.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.a11y-theme-card') as HTMLButtonElement;
      if (!btn) return;

      const theme = btn.dataset.theme || 'default';
      settings.theme = theme;
      saveSettings(settings);
      applySettings(settings);

      themeList.querySelectorAll('.a11y-theme-card').forEach(b => b.setAttribute('aria-pressed', 'false'));
      btn.setAttribute('aria-pressed', 'true');

      if (settings.screenReaderMode) {
        announce(`Color theme changed to ${theme}`);
      }
    });

    // Reset Button
    const resetBtn = document.getElementById('a11y-reset');
    resetBtn?.addEventListener('click', () => {
      settings = { ...defaultSettings };
      saveSettings(settings);
      applySettings(settings);
      updateUI(settings);

      document.querySelectorAll('.a11y-preset-btn').forEach(btn => btn.classList.remove('active'));

      document.body.classList.remove('plain');
      localStorage.removeItem('a11y-plain-mode');

      if (settings.screenReaderMode) {
        announce('All accessibility settings reset to defaults');
      }

      setTimeout(() => location.reload(), 100);
    });

    // Preset Buttons
    const presetButtons = document.querySelectorAll('.a11y-preset-btn');

    presetButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const preset = btn.getAttribute('data-preset') as string;

        if (preset === 'clear') {
          settings = { ...defaultSettings };
        } else if (preset === 'easyread') {
          const isActive = document.body.classList.toggle('plain');
          localStorage.setItem('a11y-plain-mode', isActive ? 'true' : 'false');
          if (isActive) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
          window.dispatchEvent(new CustomEvent('plainModeToggled', {
            detail: { enabled: isActive }
          }));
          if (settings.screenReaderMode) {
            announce(isActive ? 'Easy read mode enabled' : 'Easy read mode disabled');
          }
          setTimeout(() => location.reload(), 100);
          return;
        } else if (presets[preset]) {
          settings = {
            ...settings,
            ...presets[preset]
          };
        }

        presetButtons.forEach(b => b.classList.remove('active'));
        if (preset !== 'clear') {
          btn.classList.add('active');
        }

        saveSettings(settings);
        applySettings(settings);
        updateUI(settings);

        if (settings.screenReaderMode) {
          announce(`${btn.querySelector('.a11y-preset-btn__title')?.textContent} preset applied`);
        }
      });
    });

    // Restore plain mode state on page load
    const savedPlainMode = localStorage.getItem('a11y-plain-mode');
    if (savedPlainMode === 'true') {
      document.body.classList.add('plain');
      const easyReadBtn = document.querySelector('.a11y-preset-btn[data-preset="easyread"]');
      easyReadBtn?.classList.add('active');
    }

    // PDF Download
    const downloadBtn = document.getElementById('a11y-download-pdf');
    downloadBtn?.addEventListener('click', () => {
      if (!isPageMode) {
        const closePanel = (): void => {
          if (!panel) return;
          panel.classList.remove('is-open');
          if (backdrop) {
            backdrop.classList.remove('is-visible');
          }
          if (trigger) {
            trigger.setAttribute('aria-expanded', 'false');
          }
          setTimeout(() => {
            panel.setAttribute('hidden', '');
            if (backdrop) {
              backdrop.setAttribute('hidden', '');
            }
          }, 300);
        };
        closePanel();
        setTimeout(() => {
          window.print();
        }, 350);
      } else {
        window.print();
      }
    });

    // Update UI from settings
    function updateUI(s: A11ySettings): void {
      const toggleMap: Record<string, string> = {
        textOnly: 'a11y-text-only',
        highlightLinks: 'a11y-highlight-links',
        dyslexiaFont: 'a11y-dyslexia-font',
        reduceMotion: 'a11y-reduce-motion',
        enhancedFocus: 'a11y-enhanced-focus',
        screenReaderMode: 'a11y-screen-reader'
      };

      Object.entries(toggleMap).forEach(([key, id]) => {
        const toggle = document.getElementById(id) as HTMLInputElement;
        if (toggle) toggle.checked = (s as any)[key];
      });

      const fontDropdown = document.getElementById('a11y-font-dropdown');
      const fontCurrentLabel = document.getElementById('a11y-font-current');
      if (fontDropdown && s.fontFamily) {
        fontDropdown.querySelectorAll('.dropdown-item').forEach(btn => {
          const isSelected = btn.getAttribute('data-value') === s.fontFamily;
          btn.classList.toggle('is-selected', isSelected);
          btn.setAttribute('aria-selected', isSelected.toString());
          if (isSelected && fontCurrentLabel) {
            fontCurrentLabel.textContent = btn.textContent || 'Default Font';
          }
        });
      }

      const sliderMap: Record<string, string> = {
        fontSize: 'a11y-font-size',
        letterSpacing: 'a11y-letter-spacing',
        wordSpacing: 'a11y-word-spacing',
        lineHeight: 'a11y-line-height'
      };

      Object.entries(sliderMap).forEach(([key, id]) => {
        const slider = document.getElementById(id) as HTMLInputElement;
        if (slider) slider.value = (s as any)[key].toString();
        updateSliderValue(key, (s as any)[key]);
      });

      const themeCards = document.querySelectorAll('.a11y-theme-card');
      themeCards.forEach(btn => {
        const theme = (btn as HTMLButtonElement).dataset.theme;
        btn.setAttribute('aria-pressed', theme === s.theme ? 'true' : 'false');
      });
    }

    function updateSliderValue(setting: string, value: number): void {
      const valueEl = document.getElementById(`${setting.replace(/([A-Z])/g, '-$1').toLowerCase()}-value`);
      if (valueEl) {
        valueEl.textContent = formatSliderValue(setting, value);
      }
    }
  }

  // ===================================
  // INITIALIZE
  // ===================================
  function init(): void {
    initPanel();
    initKeyboardDetection();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Astro page transitions
  document.addEventListener('astro:page-load', init);
</script>
