---
// ButtonDropdown - Dropdown menu for Button component
// Supports both navigation (links) and selection (buttons) modes
// Tokens loaded globally via tokens/index.css and buttons/dropdown-tokens.css

export interface DropdownItem {
  label: string;
  value?: string;  // For selection mode
  href?: string;   // For navigation mode
  fontFamily?: string; // Optional custom font for preview
}

export interface Props {
  /** Mode: 'navigation' for links, 'selection' for selectable options */
  mode?: 'navigation' | 'selection';
  colorTheme?: 'primary' | 'secondary' | 'accent1' | 'accent2' | 'accent3' | 'accent4' | 'accent5';
  dropdownItems?: DropdownItem[];
  isOpen?: boolean;
  /** Currently selected value (selection mode only) */
  selectedValue?: string;
  /** ID for the dropdown (used for JS event handling) */
  id?: string;
  /** Name attribute for form submission */
  name?: string;
  backgroundColor?: string; // CSS variable or color value
}

const {
  mode = 'navigation',
  colorTheme = 'primary',
  dropdownItems = [
    {label: 'Option 1', value: 'option1', href: '#'},
    {label: 'Option 2', value: 'option2', href: '#'},
    {label: 'Option 3', value: 'option3', href: '#'}
  ],
  isOpen = false,
  selectedValue = '',
  id,
  name,
  backgroundColor
} = Astro.props;

const themeClass = `dropdown-theme-${colorTheme}`;
const modeClass = `dropdown-mode-${mode}`;
---

<div
  class={`dropdown-menu themed-dropdown-menu ${themeClass} ${modeClass} ${isOpen ? 'show' : ''}`}
  id={id}
  data-name={name}
  data-mode={mode}
  data-selected={selectedValue}
  role={mode === 'selection' ? 'listbox' : 'menu'}
  style={backgroundColor ? `background: ${backgroundColor};` : undefined}
>
  {dropdownItems.map((item) => (
    mode === 'selection' ? (
      <button
        type="button"
        class={`dropdown-item ${item.value === selectedValue ? 'is-selected' : ''}`}
        data-value={item.value}
        role="option"
        aria-selected={item.value === selectedValue ? 'true' : 'false'}
        style={item.fontFamily ? `--a11y-font-preview: ${item.fontFamily}; font-family: ${item.fontFamily};` : undefined}
      >{item.label}</button>
    ) : (
      <a
        href={item.href}
        class="dropdown-item"
        role="menuitem"
      >{item.label}</a>
    )
  ))}
</div>

<style is:global>
  /* ===================================
   * DROPDOWN MENU
   * Uses global tokens from tokens/index.css
   * and buttons/dropdown-tokens.css
   * =================================== */
  .dropdown-menu {
    position: absolute;
    top: 100%;
    left: 0;
    background: var(--color-Background-50);
    backdrop-filter: var(--glass-blur);
    -webkit-backdrop-filter: var(--glass-blur);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-dropdown-md);
    z-index: var(--z-dropdown);
    min-width: var(--container-xs);
    margin-top: var(--space-sm);
    list-style: none;
    padding: 0;
    border: var(--border-width) solid var(--dropdown-border-color);

    /* Height-based visibility */
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    transition: var(--transition-base);
  }

  .dropdown-menu.show {
    max-height: var(--container-sm);
    opacity: 1;
    overflow-y: auto;
  }

  /* ===================================
   * DROPDOWN THEME BORDERS
   * =================================== */
  .dropdown-theme-primary { border-color: var(--dropdown-primary-border); }
  .dropdown-theme-secondary { border-color: var(--dropdown-secondary-border); }
  .dropdown-theme-accent1 { border-color: var(--dropdown-accent1-border); }
  .dropdown-theme-accent2 { border-color: var(--dropdown-accent2-border); }
  .dropdown-theme-accent3 { border-color: var(--dropdown-accent3-border); }
  .dropdown-theme-accent4 { border-color: var(--dropdown-accent4-border); }
  .dropdown-theme-accent5 { border-color: var(--dropdown-accent5-border); }

  /* ===================================
   * DROPDOWN ITEM
   * =================================== */
  .dropdown-item {
    display: block;
    width: 100%;
    padding: var(--space-md) var(--space-lg);
    color: var(--color-Text-700);
    text-decoration: none;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    text-align: left;
    cursor: pointer;
    transition: var(--transition-fast);
    margin: 0;
    border: none;
    background: transparent;
  }

  /* Navigation mode - uppercase labels */
  .dropdown-mode-navigation .dropdown-item {
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-wide);
  }

  /* Selection mode - normal case for readability */
  .dropdown-mode-selection .dropdown-item {
    text-transform: none;
    letter-spacing: var(--letter-spacing-normal);
  }

  /* ===================================
   * DROPDOWN STATES - HOVER BY THEME
   * =================================== */
  .dropdown-item:hover {
    text-decoration: none;
  }

  /* Primary theme hover */
  .dropdown-theme-primary .dropdown-item:hover {
    background-color: var(--dropdown-primary-hover-bg);
    color: var(--dropdown-primary-hover-text);
  }

  /* Secondary theme hover */
  .dropdown-theme-secondary .dropdown-item:hover {
    background-color: var(--dropdown-secondary-hover-bg);
    color: var(--dropdown-secondary-hover-text);
  }

  /* Accent theme hovers */
  .dropdown-theme-accent1 .dropdown-item:hover {
    background-color: var(--dropdown-accent1-hover-bg);
    color: var(--dropdown-accent1-hover-text);
  }

  .dropdown-theme-accent2 .dropdown-item:hover {
    background-color: var(--dropdown-accent2-hover-bg);
    color: var(--dropdown-accent2-hover-text);
  }

  .dropdown-theme-accent3 .dropdown-item:hover {
    background-color: var(--dropdown-accent3-hover-bg);
    color: var(--dropdown-accent3-hover-text);
  }

  .dropdown-theme-accent4 .dropdown-item:hover {
    background-color: var(--dropdown-accent4-hover-bg);
    color: var(--dropdown-accent4-hover-text);
  }

  .dropdown-theme-accent5 .dropdown-item:hover {
    background-color: var(--dropdown-accent5-hover-bg);
    color: var(--dropdown-accent5-hover-text);
  }

  .dropdown-item:focus-visible {
    outline: var(--border-width-2) solid var(--color-Primary-500);
    outline-offset: calc(-1 * var(--border-width-2));
  }

  /* Selected state for selection mode */
  .dropdown-item.is-selected {
    background-color: var(--dropdown-selected-bg);
    color: var(--dropdown-selected-text);
    font-weight: var(--font-semibold);
  }

  .dropdown-item.is-selected::before {
    content: 'âœ“ ';
    font-weight: var(--font-bold);
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  /* ===================================
   * RESPONSIVE
   * =================================== */
  @media (min-width: 768px) {
    .dropdown-menu {
      min-width: var(--container-md);
    }
  }

  @media (max-width: 767px) {
    .dropdown-menu {
      z-index: var(--z-modal);
      left: 0;
      right: auto;
      min-width: var(--container-sm);
    }

    .dropdown-menu.show {
      max-height: var(--container-md);
    }
  }
</style>
