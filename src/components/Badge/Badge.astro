---
/**
 * Badge - Reusable badge/tag component with consistent type-to-color mapping
 *
 * Used across product cards, insight cards, project cards, and anywhere else badges are needed
 * For unknown types (like dynamic insight categories), uses default primary color
 *
 * Props:
 * @param type - The badge type (worksheet, workbook, guide, toolkit, cards, poster, activity, etc.)
 * @param label - Optional custom label (defaults to capitalized type)
 * @param shape - Badge shape: 'rounded' (default), 'pill', 'square', 'tag'
 * @param size - Badge size: 'sm', 'md' (default), 'lg'
 * @param variant - Visual style: 'fill' (default), 'outline', 'soft', 'ghost'
 * @param shadow - Shadow style: 'none' (default), 'drop', 'inner', 'glow'
 * @param icon - Icon name (Phosphor icon) e.g., 'star-fill', 'shield-check-fill'
 * @param iconCollection - Icon collection folder: 'badges' (default), 'trust', or any phosphor subfolder
 * @param lottieIcon - Lottie animation path e.g., 'Mail/mail.json' (from /Icons/Animated Icons/)
 * @param lottieAutoplay - Auto-play Lottie on load (default false, plays on hover)
 * @param iconOnly - If true, only shows icon (label used for accessibility)
 * @param uppercase - If false, disable uppercase text transform (default true)
 */
import Icon from '../Icons/Icon.astro';

type BadgeShape = 'rounded' | 'pill' | 'square' | 'tag';
type BadgeSize = 'sm' | 'md' | 'lg';
type BadgeVariant = 'fill' | 'outline' | 'soft' | 'ghost';
type BadgeShadow = 'none' | 'drop' | 'inner' | 'glow';

interface Props {
  type: string;
  label?: string;
  shape?: BadgeShape;
  size?: BadgeSize;
  variant?: BadgeVariant;
  shadow?: BadgeShadow;
  icon?: string;
  iconCollection?: string;
  lottieIcon?: string;
  lottieAutoplay?: boolean;
  iconOnly?: boolean;
  uppercase?: boolean;
}

const {
  type,
  label,
  shape = 'rounded',
  size = 'md',
  variant = 'fill',
  shadow = 'none',
  icon,
  iconCollection = 'badges',
  lottieIcon,
  lottieAutoplay = false,
  iconOnly = false,
  uppercase = true
} = Astro.props;

// Determine if using Lottie or static icon
const hasIcon = icon || lottieIcon;
const lottieUrl = lottieIcon ? `/Icons/Animated Icons/${lottieIcon}` : null;

// Icon sizes based on badge size
const iconSizes: Record<BadgeSize, number> = {
  sm: 12,
  md: 14,
  lg: 18
};

// Global badge type to CSS class mapping
// This ensures consistent colors across all cards site-wide
// For unknown types (like dynamic insight categories), falls back to badge-default
const badgeClasses: Record<string, string> = {
  // Product types
  worksheet: 'badge--worksheet',
  workbook: 'badge--workbook',
  guide: 'badge--guide',
  toolkit: 'badge--toolkit',
  cards: 'badge--cards',
  poster: 'badge--poster',
  activity: 'badge--activity',
  // Status types
  hot: 'badge--hot',
  free: 'badge--free',
  // Trust/verification types
  trust: 'badge--trust',
  verified: 'badge--verified',
  // Add more predefined types as needed
};

const typeClass = badgeClasses[type.toLowerCase()] || 'badge--default';
const displayLabel = label || type.charAt(0).toUpperCase() + type.slice(1);

const classes = [
  'badge',
  typeClass,
  `badge--shape-${shape}`,
  `badge--size-${size}`,
  `badge--${variant}`,
  shadow !== 'none' && `badge--shadow-${shadow}`,
  hasIcon && 'badge--has-icon',
  lottieIcon && 'badge--has-lottie',
  iconOnly && 'badge--icon-only',
  !uppercase && 'badge--lowercase'
].filter(Boolean);
---

<span class:list={classes} title={iconOnly ? displayLabel : undefined}>
  {lottieIcon && (
    <lottie-player
      src={lottieUrl}
      background="transparent"
      speed="1"
      style={`width: ${iconSizes[size]}px; height: ${iconSizes[size]}px;`}
      class="badge__lottie"
      aria-hidden="true"
    ></lottie-player>
  )}
  {icon && !lottieIcon && (
    <Icon name={`${iconCollection}/${icon}`} size={iconSizes[size]} class="badge__icon" />
  )}
  {!iconOnly && <span class="badge__label">{displayLabel}</span>}
</span>

<style>
  /* ========== BASE BADGE STYLES ========== */
  /* Layout */
  .badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
  }

  /* Box model - default size (md) */
  .badge {
    padding: var(--space-xs) var(--space-sm);
  }

  /* Visual - defaults */
  .badge {
    border-radius: var(--radius-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    transition: all var(--transition-fast);
  }

  /* Elements */
  .badge__icon {
    width: 1em;
    height: 1em;
    flex-shrink: 0;
  }

  .badge__lottie {
    flex-shrink: 0;
    pointer-events: none;
  }

  .badge__label {
    /* Typography inherited */
  }

  /* ========== SIZE MODIFIERS ========== */
  .badge--size-sm {
    padding: calc(var(--space-xs) / 2) var(--space-xs);
  }

  .badge--size-lg {
    padding: var(--space-sm) var(--space-md);
  }

  .badge--size-sm .badge__icon { width: 0.75em; height: 0.75em; }
  .badge--size-lg .badge__icon { width: 1.25em; height: 1.25em; }

  /* ========== SHAPE MODIFIERS ========== */
  .badge--shape-rounded { border-radius: var(--radius-sm); }
  .badge--shape-pill { border-radius: var(--radius-full); }
  .badge--shape-square { border-radius: 0; }
  .badge--shape-tag {
    border-radius: 0 var(--radius-sm) var(--radius-sm) 0;
    position: relative;
    margin-left: 0.5em;
  }
  .badge--shape-tag::before {
    content: '';
    position: absolute;
    left: -0.5em;
    top: 0;
    border: 0.5em solid transparent;
    border-right-color: inherit;
    border-left: 0;
  }

  /* ========== VARIANT MODIFIERS ========== */
  /* Fill variant - solid background (default look) */
  .badge--fill {
    color: var(--color-White);
  }

  /* Outline variant - border only */
  .badge--outline {
    background: transparent;
    border: 2px solid currentColor;
  }

  /* Soft variant - subtle background */
  .badge--soft {
    background: color-mix(in oklch, var(--badge-color, var(--color-Primary-500)) 15%, transparent);
    color: var(--badge-color, var(--color-Primary-600));
  }

  /* Ghost variant - no background, text only */
  .badge--ghost {
    background: transparent;
    color: var(--badge-color, var(--color-Primary-600));
  }

  /* ========== SHADOW MODIFIERS ========== */
  .badge--shadow-drop {
    box-shadow: var(--shadow-sm);
  }

  .badge--shadow-inner {
    box-shadow: inset 0 2px 4px color-mix(in oklch, var(--color-Black) 20%, transparent);
  }

  .badge--shadow-glow {
    box-shadow: 0 0 8px color-mix(in oklch, var(--badge-color, var(--color-Primary-500)) 50%, transparent);
  }

  /* ========== ICON MODIFIERS ========== */
  .badge--icon-only {
    padding: var(--space-xs);
    aspect-ratio: 1;
    justify-content: center;
  }

  .badge--icon-only.badge--shape-pill {
    border-radius: var(--radius-full);
  }

  /* ========== TEXT MODIFIERS ========== */
  .badge--lowercase {
    text-transform: none;
    letter-spacing: normal;
  }

  /* ========== BADGE TYPE COLORS ========== */
  .badge--default {
    --badge-color: var(--color-Primary-500);
    background-color: var(--color-Primary-500);
  }

  .badge--worksheet {
    --badge-color: var(--color-Primary-600);
    background-color: var(--color-Primary-600);
  }

  .badge--workbook {
    --badge-color: var(--color-Secondary-600);
    background-color: var(--color-Secondary-600);
  }

  .badge--guide {
    --badge-color: var(--color-AccentOne-600);
    background-color: var(--color-AccentOne-600);
  }

  .badge--toolkit {
    --badge-color: var(--color-AccentTwo-600);
    background-color: var(--color-AccentTwo-600);
  }

  .badge--cards {
    --badge-color: var(--color-AccentThree-600);
    background-color: var(--color-AccentThree-600);
  }

  .badge--poster {
    --badge-color: var(--color-AccentFour-600);
    background-color: var(--color-AccentFour-600);
  }

  .badge--activity {
    --badge-color: var(--color-AccentFive-600);
    background-color: var(--color-AccentFive-600);
  }

  .badge--hot {
    --badge-color: var(--color-Error);
    background-color: var(--color-Error);
  }

  .badge--free {
    --badge-color: var(--color-Success);
    background-color: var(--color-Success);
  }

  .badge--trust {
    --badge-color: var(--color-Success);
    background-color: var(--color-Success);
  }

  .badge--verified {
    --badge-color: var(--color-Info, var(--color-Primary-500));
    background-color: var(--color-Info, var(--color-Primary-500));
  }

  /* Override background for non-fill variants */
  .badge--outline.badge--default,
  .badge--outline.badge--worksheet,
  .badge--outline.badge--workbook,
  .badge--outline.badge--guide,
  .badge--outline.badge--toolkit,
  .badge--outline.badge--cards,
  .badge--outline.badge--poster,
  .badge--outline.badge--activity,
  .badge--outline.badge--hot,
  .badge--outline.badge--free,
  .badge--outline.badge--trust,
  .badge--outline.badge--verified {
    background: transparent;
    border-color: var(--badge-color);
    color: var(--badge-color);
  }

  /* A11Y theme overrides in: src/styles/a11y/components/badge.css */
</style>

<script>
  // Lottie hover animation for badges
  document.addEventListener('astro:page-load', () => {
    const lottieBadges = document.querySelectorAll('.badge--has-lottie');

    lottieBadges.forEach(badge => {
      const lottiePlayer = badge.querySelector('lottie-player') as any;

      if (lottiePlayer) {
        let loopCount = 0;
        const maxLoops = 2;

        // Listen for loop complete
        lottiePlayer.addEventListener('loop', () => {
          loopCount++;
          if (loopCount >= maxLoops) {
            lottiePlayer.stop();
          }
        });

        // Play on hover
        badge.addEventListener('mouseenter', () => {
          loopCount = 0;
          lottiePlayer.setLooping(true);
          lottiePlayer.play();
        });

        badge.addEventListener('mouseleave', () => {
          lottiePlayer.stop();
        });
      }
    });
  });
</script>
