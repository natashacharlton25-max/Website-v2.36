---
/**
 * FooterWithMask - Interactive canvas footer with proximity mask effect
 * Reveals background image through interactive circular mask
 */

export interface Props {
  backgroundImage: string;
}

const {
  backgroundImage
} = Astro.props;
---

<footer class="footer-mask-section">
  <canvas id="footer-canvas"></canvas>

  <!-- Footer Content Overlay -->
  <div class="footer-content-overlay">
    <div class="footer-container container container-7xl">
      <!-- Footer Top -->
      <div class="footer-top">
        <!-- Column 1: Brand -->
        <div class="footer-column">
          <div class="footer-brand">
            <p class="footer-brand-text">Walking With A Smile</p>
          </div>
          <p class="footer-description">
            Supporting trauma recovery and healing. Resources to help you move from survival to living, at your own pace.
          </p>
        </div>
      </div>

      <!-- Footer Bottom -->
      <div class="footer-bottom">
        <div class="footer-bottom-links">
          <a href="/legal/terms" class="footer-link-btn">Legal</a>
          <a href="/contact" class="footer-link-btn">Contact Us</a>
          <a href="/legal/cookies" class="footer-link-btn">Cookie Settings</a>
        </div>
        <p class="footer-copyright">
          Â© {new Date().getFullYear()} <strong>Walking With A Smile</strong>. All rights reserved.
        </p>
      </div>
    </div>
  </div>
</footer>

<style>
  .footer-mask-section {
    position: relative;
    width: 100%;
    overflow: hidden;
    background-color: var(--color-Background-100);
    min-height: 400px; /* Flexible height for canvas effect */
    transition: min-height 0.3s ease-out; /* Smooth footer resize */
  }

  #footer-canvas {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: block;
    z-index: 1;
  }

  /* Footer Content Overlay */
  .footer-content-overlay {
    position: relative;
    z-index: 10;
    padding: var(--space-3xl) 0 var(--space-xl);
    color: var(--color-Text-700);
  }

  .footer-container {
    max-width: 1280px;
    margin: 0 auto;
    padding: 0 var(--space-xl);
  }

  .footer-top {
    display: flex;
    justify-content: center;
    margin-bottom: var(--space-3xl);
  }

  .footer-column {
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    max-width: 600px;
  }

  .footer-brand {
    margin-bottom: var(--space-lg);
  }

  .footer-brand-text {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    font-family: var(--font-heading);
    font-style: italic;
    color: var(--color-Text-700);
    margin: 0;
    text-shadow: 2px 2px 8px var(--color-Background-50);
  }

  .footer-description {
    color: var(--color-Text-600);
    line-height: var(--leading-relaxed);
    margin-bottom: 0;
    font-size: var(--text-base);
    text-shadow: 1px 1px 6px var(--color-Background-50);
  }

  .footer-bottom {
    padding-top: var(--space-xl);
    border-top: 1px solid var(--color-Neutral-200);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
    text-align: center;
  }

  .footer-copyright {
    color: var(--color-Text-600);
    font-size: var(--text-sm);
    text-shadow: 1px 1px 4px var(--color-Background-50);
    margin: 0;
  }

  .footer-copyright strong {
    color: var(--color-Text-700);
  }

  .footer-bottom-links {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-sm);
    justify-content: center;
    margin-bottom: var(--space-lg);
  }

  .footer-link-btn {
    background: var(--color-Primary-500);
    backdrop-filter: blur(10px);
    border: 2px solid var(--color-Primary-600);
    color: var(--color-Background-50);
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    cursor: pointer;
    padding: var(--space-sm) var(--space-xl);
    border-radius: var(--border-radius-lg);
    transition: all var(--transition-fast);
    text-shadow: none;
    text-decoration: none;
    display: inline-block;
  }

  .footer-link-btn:hover {
    background: var(--color-Primary-600);
    color: var(--color-Background-50);
    border-color: var(--color-Primary-700);
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .footer-content-overlay {
      padding: var(--space-2xl) 0 var(--space-lg);
    }
  }

  @media (max-width: 250px) {
    .footer-content-overlay {
      padding: var(--space-lg) 0.25rem;
    }

    .footer-brand-text {
      font-size: var(--text-lg);
    }

    .footer-description {
      font-size: var(--text-sm);
    }

    .footer-copyright {
      font-size: var(--text-xs);
    }

    .footer-link-btn {
      font-size: var(--text-xs);
      padding: var(--space-xs) var(--space-md);
    }
  }

  /* Extra small screens - under 210px */
  @media (max-width: 210px) {
    .footer-content-overlay {
      padding: var(--space-md) 0.125rem;
    }

    .footer-brand-text {
      font-size: var(--text-base);
    }

    .footer-description {
      font-size: var(--text-xs);
    }
  }
</style>

<script is:inline define:vars={{ backgroundImage }}>
  // Proximity mask parameters
  const parameters = {
    size: 30,
    radius: 0.1,
    proximity: 125,
    growth: 60,
    ease: 0.075,
  };

  class Point {
    constructor(x, y) {
      this.x = x;
      this.y = y;
    }
  }

  class Circle {
    constructor(radius, x, y) {
      this._radius = radius;
      this.radius = radius;
      this.growthValue = 0;
      this.position = new Point(x, y);
    }

    draw(context, ease) {
      this.radius += ((this._radius + this.growthValue) - (this.radius)) * ease;
      context.moveTo(this.position.x, this.position.y);
      context.arc(this.position.x, this.position.y, this.radius, 0, 2 * Math.PI);
    }

    addRadius(value) {
      this.growthValue = value;
    }

    get x() {
      return this.position.x;
    }

    set x(value) {
      this.position.x = value;
    }

    get y() {
      return this.position.y;
    }

    set y(value) {
      this.position.y = value;
    }
  }

  function normalize(value, min, max) {
    return (value - min) / (max - min);
  }

  function interpolate(value, min, max) {
    return min + (max - min) * value;
  }

  function map(value, min1, max1, min2, max2) {
    return interpolate(normalize(value, min1, max1), min2, max2);
  }

  function resizeCanvas(canvas) {
    const section = canvas.parentElement;
    canvas.width = section.clientWidth;
    canvas.height = section.clientHeight;
  }

  // Initialize footer canvas effect
  document.addEventListener('DOMContentLoaded', () => {
    let imageLoaded = false;
    const canvas = document.getElementById("footer-canvas");
    if (!canvas) return;

    const image = new Image();
    let circles = [];
    const context = canvas.getContext("2d");

    function build() {
      circles = [];
      const { size, radius } = parameters;
      const section = canvas.parentElement;
      const columns = Math.ceil(section.clientWidth / size) + 1;
      const rows = Math.ceil(section.clientHeight / size) + 1;
      const amount = Math.ceil(columns * rows);

      for (let i = 0; i < amount; i++) {
        const column = i % columns;
        const row = ~~(i / columns);
        circles.push(new Circle(radius, size * column, size * row));
      }
    }

    function mouseMoveHandler(event) {
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      proximityHandler(x, y);
    }

    function touchMoveHandler(event) {
      const rect = canvas.getBoundingClientRect();
      const touch = event.touches[0];
      const x = touch.clientX - rect.left;
      const y = touch.clientY - rect.top;
      proximityHandler(x, y);
    }

    function proximityHandler(x, y) {
      const { proximity, growth } = parameters;
      for (let c of circles) {
        let distance = Math.sqrt(Math.pow(c.x - x, 2) + Math.pow(c.y - y, 2));
        let d = map(distance, c._radius, c._radius + proximity, growth, 0);
        if (d < 0) d = 0;
        c.addRadius(d);
      }
    }

    function animate() {
      context.clearRect(0, 0, canvas.width, canvas.height);
      context.save();
      context.beginPath();
      context.fillStyle = "#000000";

      for (let circle of circles) {
        circle.draw(context, parameters.ease);
      }

      if (imageLoaded) {
        drawImage();
      } else {
        context.fill();
      }

      context.restore();
      requestAnimationFrame(animate);
    }

    function drawImage() {
      context.clip();
      const { naturalHeight, naturalWidth } = image;

      // Scale to fill width, adjust canvas height to maintain aspect ratio
      const scale = canvas.width / naturalWidth;
      const w = canvas.width;
      const h = naturalHeight * scale;
      const x = 0;
      const y = (canvas.height - h) / 2;

      context.drawImage(image, 0, 0, naturalWidth, naturalHeight, x, y, w, h);
    }

    function resizeHandler() {
      resizeCanvas(canvas);
      build();
    }

    function loadImage() {
      image.onload = function () {
        imageLoaded = true;
      };
      image.src = backgroundImage;
    }

    // Get footer section element
    const footerSection = document.querySelector('.footer-mask-section');

    // Event listeners - attach to footer section so it works everywhere
    window.addEventListener("resize", resizeHandler);
    if (footerSection) {
      footerSection.addEventListener("mousemove", mouseMoveHandler);
      footerSection.addEventListener("touchmove", touchMoveHandler);
    }

    // Initialize
    resizeHandler();
    loadImage();
    build();
    animate();
  });
</script>
