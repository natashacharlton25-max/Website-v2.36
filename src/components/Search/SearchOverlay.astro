---
/**
 * SearchOverlay - Full-screen search overlay
 *
 * A beautiful overlay search interface that appears when triggered.
 * Includes search input, quick links, and recent searches.
 */
import Icon from '../Icons/Icon.astro';
---

<!-- Search Overlay (hidden by default) -->
<div id="searchOverlay" class="search-overlay">
  <div class="search-container">
    <!-- Close Button -->
    <button id="closeSearch" class="close-btn" aria-label="Close search">
      <Icon name="x-fill" size={24} />
    </button>

    <!-- Search Header -->
    <div class="search-header">
      <h2 class="search-title">What are you looking for?</h2>
      <p class="search-subtitle">Search our resources, insights, and tools</p>
    </div>

    <!-- Search Input -->
    <div class="search-input-wrapper">
      <Icon name="magnifying-glass-fill" size={24} class="search-icon" />
      <input
        type="text"
        id="searchInput"
        class="search-input"
        placeholder="Type to search..."
        autocomplete="off"
        autofocus
      />
      <button id="clearSearch" class="clear-btn" aria-label="Clear search" style="display: none;">
        <Icon name="x-circle-fill" size={18} />
      </button>
    </div>

    <!-- Quick Links -->
    <div class="quick-links" id="quickLinks">
      <h3 class="quick-links-title">Quick Links</h3>
      <div class="quick-links-grid">
        <a href="/assets" class="quick-link">
          <Icon name="package-fill" size={20} />
          <span>Tools & Resources</span>
        </a>
        <a href="/insights" class="quick-link">
          <Icon name="book-open-fill" size={20} />
          <span>Insights & Articles</span>
        </a>
        <a href="/services" class="quick-link">
          <Icon name="users-fill" size={20} />
          <span>For Professionals</span>
        </a>
        <a href="/about" class="quick-link">
          <Icon name="info-fill" size={20} />
          <span>About Us</span>
        </a>
        <a href="/contact" class="quick-link">
          <Icon name="envelope-fill" size={20} />
          <span>Contact</span>
        </a>
        <a href="/projects" class="quick-link">
          <Icon name="stack-fill" size={20} />
          <span>Projects</span>
        </a>
      </div>
    </div>

    <!-- Search Results -->
    <div class="search-results" id="searchResults" style="display: none;">
      <h3 class="results-title">Results</h3>
      <div class="results-list" id="resultsList">
        <!-- Results will be populated by JavaScript -->
      </div>
      <div class="no-results" id="noResults" style="display: none;">
        <Icon name="magnifying-glass-fill" size={48} class="no-results-icon" />
        <p>No results found</p>
        <span>Try a different search term</span>
      </div>
    </div>

    <!-- Keyboard Hint -->
    <div class="keyboard-hint">
      Press <kbd>ESC</kbd> to close
    </div>
  </div>
</div>

<style>
  /* Search Overlay */
  .search-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: color-mix(in oklch, var(--color-Background-50) 95%, transparent);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    display: flex;
    align-items: flex-start;
    justify-content: center;
    z-index: 10000;
    padding: var(--space-4xl) var(--space-lg);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    overflow-y: auto;
  }

  .search-overlay.show {
    opacity: 1;
    visibility: visible;
  }

  /* Search Container */
  .search-container {
    background: var(--color-Background-50);
    border-radius: var(--border-radius-2xl);
    max-width: 900px;
    width: 100%;
    padding: var(--space-3xl);
    box-shadow: var(--shadow-2xl);
    transform: translateY(-20px) scale(0.98);
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .search-overlay.show .search-container {
    transform: translateY(0) scale(1);
  }

  /* Close Button */
  .close-btn {
    position: absolute;
    top: var(--space-lg);
    right: var(--space-lg);
    background: transparent;
    border: none;
    color: var(--color-Text-500);
    cursor: pointer;
    padding: var(--space-sm);
    border-radius: var(--border-radius-full);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .close-btn:hover {
    background: var(--color-Neutral-200);
    color: var(--color-Text-700);
    transform: scale(1.1);
  }

  /* Search Header */
  .search-header {
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  .search-title {
    font-family: var(--font-heading);
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--color-Primary-600);
    margin: 0 0 var(--space-sm) 0;
  }

  .search-subtitle {
    font-family: var(--font-body);
    font-size: var(--text-base);
    color: var(--color-Text-500);
    margin: 0;
  }

  /* Search Input */
  .search-input-wrapper {
    position: relative;
    margin-bottom: var(--space-2xl);
  }

  .search-icon {
    position: absolute;
    left: var(--space-lg);
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-Primary-500);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: var(--space-lg) var(--space-3xl);
    padding-left: calc(var(--space-lg) + 24px + var(--space-md));
    font-family: var(--font-body);
    font-size: var(--text-lg);
    border: 2px solid var(--color-Neutral-300);
    border-radius: var(--border-radius-xl);
    background: var(--color-Background-50);
    color: var(--color-Text-700);
    transition: all 0.2s ease;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.04);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-Primary-500);
    box-shadow: 0 0 0 4px color-mix(in oklch, var(--color-Primary-500) 15%, transparent);
  }

  .search-input::placeholder {
    color: var(--color-Text-400);
  }

  .clear-btn {
    position: absolute;
    right: var(--space-md);
    top: 50%;
    transform: translateY(-50%);
    background: transparent;
    border: none;
    color: var(--color-Text-400);
    cursor: pointer;
    padding: var(--space-xs);
    border-radius: var(--border-radius-full);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .clear-btn:hover {
    background: var(--color-Neutral-200);
    color: var(--color-Text-600);
  }

  /* Quick Links */
  .quick-links {
    margin-bottom: var(--space-xl);
  }

  .quick-links-title,
  .results-title {
    font-family: var(--font-heading);
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    color: var(--color-Text-500);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 var(--space-md) 0;
  }

  .quick-links-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-sm);
  }

  .quick-link {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-md) var(--space-lg);
    background: var(--color-Neutral-100);
    border-radius: var(--border-radius-lg);
    color: var(--color-Text-600);
    text-decoration: none;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    transition: all 0.2s ease;
  }

  .quick-link:hover {
    background: var(--color-Primary-100);
    color: var(--color-Primary-700);
    transform: translateX(4px);
  }

  .quick-link svg {
    flex-shrink: 0;
    color: var(--color-Primary-500);
  }

  /* Search Results */
  .search-results {
    margin-bottom: var(--space-xl);
  }

  .results-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .result-item {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
    padding: var(--space-md) var(--space-lg);
    background: var(--color-Neutral-100);
    border-radius: var(--border-radius-lg);
    color: var(--color-Text-600);
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .result-item:hover {
    background: var(--color-Primary-100);
    color: var(--color-Primary-700);
  }

  .result-icon {
    flex-shrink: 0;
    width: 40px;
    height: 40px;
    border-radius: var(--border-radius-md);
    background: var(--color-Primary-500);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .result-category-icon {
    filter: brightness(0) invert(1);
  }

  .result-content {
    flex: 1;
    min-width: 0;
  }

  .result-title {
    font-family: var(--font-heading);
    font-size: var(--text-base);
    font-weight: var(--font-semibold);
    color: var(--color-Text-700);
    margin: 0 0 2px 0;
  }

  .result-description {
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-Text-500);
    margin: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .result-category {
    font-family: var(--font-body);
    font-size: var(--text-xs);
    color: var(--color-Primary-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: var(--space-2xl);
    color: var(--color-Text-500);
  }

  .no-results .no-results-icon {
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }

  .no-results p {
    font-family: var(--font-heading);
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
    margin: 0 0 var(--space-xs) 0;
  }

  .no-results span {
    font-size: var(--text-sm);
  }

  /* Keyboard Hint */
  .keyboard-hint {
    text-align: center;
    font-family: var(--font-body);
    font-size: var(--text-sm);
    color: var(--color-Text-400);
  }

  .keyboard-hint kbd {
    display: inline-block;
    padding: 2px 8px;
    font-family: var(--font-body);
    font-size: var(--text-xs);
    background: var(--color-Neutral-200);
    border: 1px solid var(--color-Neutral-300);
    border-radius: var(--border-radius-sm);
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .search-overlay {
      padding: var(--space-md);
      align-items: flex-start;
      padding-top: var(--space-2xl);
    }

    .search-container {
      padding: var(--space-xl);
      border-radius: var(--border-radius-xl);
    }

    .search-title {
      font-size: var(--text-2xl);
    }

    .quick-links-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .search-input {
      font-size: var(--text-base);
      padding: var(--space-md) var(--space-2xl);
      padding-left: calc(var(--space-md) + 24px + var(--space-sm));
    }

    .search-icon {
      left: var(--space-md);
    }
  }

  @media (max-width: 480px) {
    .search-container {
      padding: var(--space-lg);
    }

    .search-title {
      font-size: var(--text-xl);
    }

    .quick-links-grid {
      grid-template-columns: 1fr;
    }

    .keyboard-hint {
      display: none;
    }
  }
</style>

<script>
  // Search Overlay JavaScript
  class SearchOverlay {
    private overlay: HTMLElement | null;
    private closeBtn: HTMLElement | null;
    private searchInput: HTMLInputElement | null;
    private clearBtn: HTMLElement | null;
    private quickLinks: HTMLElement | null;
    private searchResults: HTMLElement | null;
    private resultsList: HTMLElement | null;
    private noResults: HTMLElement | null;

    // Searchable content - this would ideally come from an API or be generated at build time
    private searchableContent = [
      { title: '7-Day Self-Directed Living Starter Kit', url: '/assets/product-1', category: 'Resource', description: 'A gentle and practical way to move towards intentional choices in everyday life.' },
      { title: 'Boundaries Guide', url: '/assets/product-2', category: 'Resource', description: 'Simple strategies for setting and maintaining healthy boundaries.' },
      { title: 'Self-Direction Toolkit', url: '/assets/product-3', category: 'Resource', description: 'Resources to help you make decisions that align with who you are.' },
      { title: 'Finding Your Voice', url: '/insights/finding-your-voice', category: 'Insight', description: 'Exploring the journey of self-expression after trauma.' },
      { title: 'Setting Healthy Boundaries', url: '/insights/setting-healthy-boundaries', category: 'Insight', description: 'Understanding and implementing boundaries in your life.' },
      { title: 'Practicing Self-Compassion', url: '/insights/practicing-self-compassion', category: 'Insight', description: 'Learning to be kind to yourself during difficult times.' },
      { title: 'About Us', url: '/about', category: 'Page', description: 'Learn about Walking With A Smile and our mission.' },
      { title: 'Services for Professionals', url: '/services', category: 'Page', description: 'Resources and support for therapists, coaches, and facilitators.' },
      { title: 'Contact', url: '/contact', category: 'Page', description: 'Get in touch with our team.' },
      { title: 'Projects', url: '/projects', category: 'Page', description: 'View our ongoing and completed projects.' },
    ];

    constructor() {
      this.overlay = document.getElementById('searchOverlay');
      this.closeBtn = document.getElementById('closeSearch');
      this.searchInput = document.getElementById('searchInput') as HTMLInputElement;
      this.clearBtn = document.getElementById('clearSearch');
      this.quickLinks = document.getElementById('quickLinks');
      this.searchResults = document.getElementById('searchResults');
      this.resultsList = document.getElementById('resultsList');
      this.noResults = document.getElementById('noResults');

      this.init();
    }

    init(): void {
      // Close button
      this.closeBtn?.addEventListener('click', () => this.close());

      // Backdrop click to close
      this.overlay?.addEventListener('click', (e: Event) => {
        if (e.target === this.overlay) {
          this.close();
        }
      });

      // Search input
      this.searchInput?.addEventListener('input', (e: Event) => {
        const target = e.target as HTMLInputElement;
        this.handleSearch(target.value);
      });

      // Clear button
      this.clearBtn?.addEventListener('click', () => {
        if (this.searchInput) {
          this.searchInput.value = '';
          this.searchInput.focus();
          this.handleSearch('');
        }
      });

      // Escape key to close
      document.addEventListener('keydown', (e: KeyboardEvent) => {
        if (e.key === 'Escape' && this.isOpen()) {
          this.close();
        }
      });

      // CMD/CTRL + K to open search
      document.addEventListener('keydown', (e: KeyboardEvent) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          if (this.isOpen()) {
            this.close();
          } else {
            this.open();
          }
        }
      });

      // Expose global functions
      (window as any).openSearchOverlay = () => this.open();
      (window as any).closeSearchOverlay = () => this.close();
    }

    open(): void {
      this.overlay?.classList.add('show');
      document.body.style.overflow = 'hidden';

      // Focus search input after animation
      setTimeout(() => {
        this.searchInput?.focus();
      }, 100);
    }

    close(): void {
      this.overlay?.classList.remove('show');
      document.body.style.overflow = '';

      // Clear search on close
      if (this.searchInput) {
        this.searchInput.value = '';
      }
      this.handleSearch('');
    }

    isOpen(): boolean {
      return this.overlay?.classList.contains('show') ?? false;
    }

    handleSearch(query: string): void {
      const trimmedQuery = query.trim().toLowerCase();

      // Show/hide clear button
      if (this.clearBtn) {
        this.clearBtn.style.display = trimmedQuery ? 'flex' : 'none';
      }

      if (!trimmedQuery) {
        // Show quick links, hide results
        if (this.quickLinks) this.quickLinks.style.display = 'block';
        if (this.searchResults) this.searchResults.style.display = 'none';
        return;
      }

      // Hide quick links, show results
      if (this.quickLinks) this.quickLinks.style.display = 'none';
      if (this.searchResults) this.searchResults.style.display = 'block';

      // Filter content
      const results = this.searchableContent.filter(item =>
        item.title.toLowerCase().includes(trimmedQuery) ||
        item.description.toLowerCase().includes(trimmedQuery) ||
        item.category.toLowerCase().includes(trimmedQuery)
      );

      this.renderResults(results);
    }

    renderResults(results: typeof this.searchableContent): void {
      if (!this.resultsList || !this.noResults) return;

      if (results.length === 0) {
        this.resultsList.innerHTML = '';
        this.noResults.style.display = 'block';
        return;
      }

      this.noResults.style.display = 'none';

      const html = results.map(item => `
        <a href="${item.url}" class="result-item">
          <div class="result-icon">
            ${this.getIconForCategory(item.category)}
          </div>
          <div class="result-content">
            <span class="result-category">${item.category}</span>
            <h4 class="result-title">${item.title}</h4>
            <p class="result-description">${item.description}</p>
          </div>
        </a>
      `).join('');

      this.resultsList.innerHTML = html;
    }

    getIconForCategory(category: string): string {
      const iconPath = '/Icons/phosphor/interface/';
      switch (category) {
        case 'Resource':
          return `<img src="${iconPath}package-fill.svg" width="20" height="20" alt="" class="result-category-icon" />`;
        case 'Insight':
          return `<img src="${iconPath}book-open-fill.svg" width="20" height="20" alt="" class="result-category-icon" />`;
        default:
          return `<img src="${iconPath}file-fill.svg" width="20" height="20" alt="" class="result-category-icon" />`;
      }
    }
  }

  // Initialize when DOM is ready
  document.addEventListener('DOMContentLoaded', () => {
    new SearchOverlay();
  });

  // Also initialize on Astro page transitions
  document.addEventListener('astro:page-load', () => {
    new SearchOverlay();
  });
</script>
