---
/**
 * Filter Switcher Component with Isotope Animations
 *
 * A modern filter navigation with sliding indicator and Isotope-powered filtering
 * Uses Isotope.js for reliable, battle-tested grid animations
 *
 * Props:
 * - tabs: Array of { id: string, label: string, icon?: string }
 * - defaultActive?: string (id of default active tab)
 * - gridSelector: CSS selector for the grid container (e.g., '.products-grid')
 * - itemSelector: CSS selector for grid items (e.g., '.product-card')
 */

export interface FilterTab {
  id: string;
  label: string;
  icon?: string; // SVG icon as string
}

interface Props {
  tabs: FilterTab[];
  defaultActive?: string;
  gridSelector: string;
  itemSelector: string;
}

const { tabs, defaultActive, gridSelector, itemSelector } = Astro.props;
const activeTab = defaultActive || tabs[0]?.id;
---

<div class="filter-switcher-container">
  <div
    class="filter-switcher-nav"
    data-grid-selector={gridSelector}
    data-item-selector={itemSelector}
  >
    {tabs.map((tab) => (
      <button
        class={`filter-switcher-btn ${tab.id === activeTab ? 'active' : ''}`}
        data-filter={tab.id === 'all' ? '*' : `.${tab.id}`}
      >
        {tab.icon && <span set:html={tab.icon} />}
        <span>{tab.label}</span>
      </button>
    ))}
  </div>
</div>

<script>
  import Isotope from 'isotope-layout';
  import imagesLoaded from 'imagesloaded';

  function initIsotopeFilter() {
    const filterNav = document.querySelector('.filter-switcher-nav[data-grid-selector]') as HTMLElement | null;
    if (!filterNav) return;

    const filterButtons = filterNav.querySelectorAll('.filter-switcher-btn');
    const gridSelector = filterNav.getAttribute('data-grid-selector');
    const itemSelector = filterNav.getAttribute('data-item-selector') || '.product-card';
    if (!gridSelector) return;

    const gridElement = document.querySelector(gridSelector) as HTMLElement | null;
    if (!gridElement) return;

    // Initialize Isotope
    let iso: Isotope | null = null;
    gridElement.classList.add('grid--loading');

    try {
      iso = new Isotope(gridElement, {
        itemSelector: itemSelector,
        percentPosition: true,
        masonry: { columnWidth: '.grid__sizer' },
        transitionDuration: '0.6s'
      });

      // @ts-ignore
      imagesLoaded(gridElement, () => {
        if (iso) iso.layout();
        gridElement.classList.remove('grid--loading');
      });
    } catch (error) {
      gridElement.classList.remove('grid--loading');
      return;
    }

    // Update sliding selector position
    function updateSelector(btn: Element) {
      const el = btn as HTMLElement;
      filterNav.style.setProperty('--selector-width', `${el.offsetWidth}px`);
      filterNav.style.setProperty('--selector-left', `${el.offsetLeft}px`);
    }

    // Initialize selector position
    const activeButton = filterNav.querySelector('.filter-switcher-btn.active');
    if (activeButton) {
      const initSelector = () => updateSelector(activeButton);
      if (document.fonts?.ready) {
        document.fonts.ready.then(() => requestAnimationFrame(initSelector));
      } else {
        requestAnimationFrame(initSelector);
      }
      window.addEventListener('load', () => requestAnimationFrame(initSelector));
    }

    // Handle filter clicks
    filterButtons.forEach(button => {
      button.addEventListener('click', (e) => {
        e.preventDefault();
        const filterValue = button.getAttribute('data-filter');

        // Update active state
        filterButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        updateSelector(button);

        // Emit event
        button.dispatchEvent(new CustomEvent('tabchange', {
          detail: { filter: filterValue },
          bubbles: true
        }));

        // Filter with Isotope
        if (iso && filterValue) {
          document.body.style.overflowX = 'hidden';
          document.documentElement.style.overflowX = 'hidden';

          const allItems = gridElement.querySelectorAll(itemSelector);
          const currentlyVisible = Array.from(allItems).filter(
            item => getComputedStyle(item as HTMLElement).display !== 'none'
          ).length;

          let willBeVisible = filterValue === '*' ? allItems.length :
            Array.from(allItems).filter(item =>
              item.classList.contains(filterValue.replace('.', ''))
            ).length;

          const multiplier = willBeVisible > currentlyVisible ? 4.0 : 2.5;
          const lockedHeight = Math.ceil(gridElement.offsetHeight * multiplier);
          const originalOverflow = gridElement.style.overflow;

          gridElement.style.height = `${lockedHeight}px`;
          gridElement.style.minHeight = `${lockedHeight}px`;
          gridElement.style.maxHeight = `${lockedHeight}px`;
          gridElement.style.overflow = 'hidden';

          iso.arrange({ filter: filterValue });
          requestAnimationFrame(() => iso?.layout());

          iso.once('arrangeComplete', () => {
            requestAnimationFrame(() => {
              const items = iso!.getFilteredItemElements();
              let maxBottom = 0;
              const gridRect = gridElement.getBoundingClientRect();

              items.forEach(item => {
                const bottom = item.getBoundingClientRect().bottom - gridRect.top;
                if (bottom > maxBottom) maxBottom = bottom;
              });

              const finalHeight = Math.ceil(maxBottom + 100) || gridElement.offsetHeight;
              gridElement.style.transition = 'height 0.3s ease-out';
              gridElement.style.height = `${finalHeight}px`;

              setTimeout(() => {
                gridElement.style.minHeight = '';
                gridElement.style.maxHeight = '';
                gridElement.style.overflow = originalOverflow;
                gridElement.style.transition = '';
              }, 350);
            });
          });
        }
      });
    });

    // Handle resize
    let resizeRAF = 0;
    window.addEventListener('resize', () => {
      const activeBtn = filterNav.querySelector('.filter-switcher-btn.active');
      if (activeBtn) updateSelector(activeBtn);
      cancelAnimationFrame(resizeRAF);
      resizeRAF = requestAnimationFrame(() => iso?.layout());
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initIsotopeFilter);
  } else {
    initIsotopeFilter();
  }
</script>

<style>
  /* Filter Switcher Navigation */
  .filter-switcher-container {
    display: flex;
    justify-content: center;
    margin-bottom: var(--space-3xl);
  }

  .filter-switcher-nav {
    font-size: var(--text-sm);
    padding: var(--space-xs) var(--space-md);
    list-style: none;
    background: var(--color-AccentOne-100);
    box-shadow: var(--shadow-lg);
    display: inline-flex;
    border-radius: 50px;
    position: relative;
    overflow-x: auto;
    scrollbar-width: none; /* Firefox */
  }

  .filter-switcher-nav::-webkit-scrollbar {
    display: none; /* Chrome, Safari */
  }

  .filter-switcher-btn {
    text-decoration: none;
    color: var(--color-Text-600);
    text-transform: uppercase;
    padding: var(--space-md) var(--space-lg);
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    position: relative;
    z-index: 2;
    transition: color 0.6s;
    background: transparent;
    border: none;
    cursor: pointer;
    white-space: nowrap;
    font-weight: var(--font-semibold);
    font-size: var(--text-sm);
  }

  .filter-switcher-btn :global(svg) {
    flex-shrink: 0;
    width: 20px;
    height: 20px;
  }

  .filter-switcher-btn.active {
    color: var(--color-Background-50);
  }

  .filter-switcher-btn:hover:not(.active) {
    color: var(--color-Primary-600);
  }

  /* Sliding Selector Background */
  .filter-switcher-nav::before {
    content: '';
    height: 75%;
    display: inline-block;
    position: absolute;
    left: var(--selector-left, 0);
    top: 50%;
    transform: translateY(-50%);
    z-index: 1;
    border-radius: 50px;
    width: var(--selector-width, 0);
    transition: left 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55),
                width 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    background: var(--color-AccentOne-500);
    box-shadow: var(--shadow-md);
  }

  /* Responsive: Mobile */
  @media (max-width: 768px) {
    .filter-switcher-container {
      padding: 0 !important;
    }

    .filter-switcher-nav {
      flex-direction: column !important;
      align-items: stretch !important;
      padding: var(--space-sm) !important;
      overflow-x: visible !important;
      gap: var(--space-xs) !important;
      display: flex !important;
      border-radius: var(--border-radius-md) !important;
    }

    .filter-switcher-btn {
      width: 100% !important;
      justify-content: flex-start !important;
      padding: var(--space-md) var(--space-lg) !important;
      text-align: left !important;
      display: inline-flex !important;
    }

    .filter-switcher-btn span {
      display: inline !important; /* Show text labels */
    }

    .filter-switcher-nav::before {
      display: none !important; /* Hide horizontal sliding selector */
    }

    .filter-switcher-btn.active {
      background: var(--color-AccentOne-500) !important;
      border-radius: var(--border-radius-md) !important;
    }
  }

  @media (max-width: 480px) {
    .filter-switcher-btn {
      padding: var(--space-xs) var(--space-sm);
    }
  }

  @media (max-width: 300px) {
    .filter-switcher-nav {
      padding: var(--space-xs) !important;
      gap: var(--space-xs) !important;
      border-radius: var(--border-radius-md) !important;
    }

    .filter-switcher-btn {
      padding: var(--space-xs) var(--space-sm) !important;
      font-size: var(--text-xs) !important;
      gap: var(--space-xs) !important;
    }

    .filter-switcher-btn :global(svg) {
      width: 16px !important;
      height: 16px !important;
    }

    .filter-switcher-btn.active {
      border-radius: var(--border-radius-sm) !important;
    }
  }

  @media (max-width: 200px) {
    .filter-switcher-nav {
      padding: var(--space-xs) !important;
      align-items: center !important;
      border-radius: var(--border-radius-md) !important;
    }

    .filter-switcher-btn {
      padding: var(--space-xs) !important;
      justify-content: center !important;
    }

    .filter-switcher-btn span {
      display: none !important; /* Hide text, show only icons */
    }

    .filter-switcher-btn :global(svg) {
      width: 16px !important;
      height: 16px !important;
    }

    .filter-switcher-btn.active {
      border-radius: var(--border-radius-sm) !important;
    }
  }

  /* ============================================
     ACCESSIBILITY THEMES - Filter Switcher
     ============================================ */

  /* Dark mode & High Contrast: Transparent background with accent border */
  :global(body.a11y-theme-dark) .filter-switcher-nav,
  :global(body.a11y-theme-high-contrast) .filter-switcher-nav {
    background: transparent !important;
    border: 2px solid var(--a11y-hc-accent, var(--a11y-dark-accent, var(--color-Primary-500))) !important;
  }

  :global(body.a11y-theme-dark) .filter-switcher-btn,
  :global(body.a11y-theme-high-contrast) .filter-switcher-btn {
    color: #ffffff !important;
    border: none !important;
    background: transparent !important;
  }

  /* Active button uses highlight accent color */
  :global(body.a11y-theme-dark) .filter-switcher-btn.active,
  :global(body.a11y-theme-high-contrast) .filter-switcher-btn.active {
    color: #000000 !important;
    border: none !important;
    background: transparent !important;
  }

  :global(body.a11y-theme-dark) .filter-switcher-nav::before,
  :global(body.a11y-theme-high-contrast) .filter-switcher-nav::before {
    background: var(--a11y-hc-accent, var(--a11y-dark-accent, var(--color-Primary-500))) !important;
  }

  /* Cream theme */
  :global(body.a11y-theme-cream) .filter-switcher-nav {
    background: var(--a11y-cream-bg) !important;
    border: 2px solid var(--a11y-cream-accent) !important;
  }

  :global(body.a11y-theme-cream) .filter-switcher-btn {
    color: var(--a11y-cream-text) !important;
  }

  :global(body.a11y-theme-cream) .filter-switcher-btn.active {
    color: var(--color-Background-50) !important;
  }

  :global(body.a11y-theme-cream) .filter-switcher-nav::before {
    background: var(--a11y-cream-accent) !important;
  }

  /* Monochrome theme */
  :global(body.a11y-theme-monochrome) .filter-switcher-nav,
  :global(body.a11y-cvd-monochrome) .filter-switcher-nav {
    background: transparent !important;
    border: 2px solid #333333 !important;
  }

  :global(body.a11y-theme-monochrome) .filter-switcher-btn,
  :global(body.a11y-cvd-monochrome) .filter-switcher-btn {
    color: #333333 !important;
  }

  :global(body.a11y-theme-monochrome) .filter-switcher-btn.active,
  :global(body.a11y-cvd-monochrome) .filter-switcher-btn.active {
    color: #ffffff !important;
  }

  :global(body.a11y-theme-monochrome) .filter-switcher-nav::before,
  :global(body.a11y-cvd-monochrome) .filter-switcher-nav::before {
    background: #333333 !important;
  }

  /* CVD Color Blind modes (Protanopia, Deuteranopia, Tritanopia) */
  :global(body.a11y-theme-protanopia) .filter-switcher-nav,
  :global(body.a11y-theme-deuteranopia) .filter-switcher-nav,
  :global(body.a11y-theme-tritanopia) .filter-switcher-nav,
  :global(body.a11y-cvd-protanopia) .filter-switcher-nav,
  :global(body.a11y-cvd-deuteranopia) .filter-switcher-nav,
  :global(body.a11y-cvd-tritanopia) .filter-switcher-nav {
    background: transparent !important;
    border: 2px solid var(--color-Primary-600) !important;
  }

  :global(body.a11y-theme-protanopia) .filter-switcher-btn,
  :global(body.a11y-theme-deuteranopia) .filter-switcher-btn,
  :global(body.a11y-theme-tritanopia) .filter-switcher-btn,
  :global(body.a11y-cvd-protanopia) .filter-switcher-btn,
  :global(body.a11y-cvd-deuteranopia) .filter-switcher-btn,
  :global(body.a11y-cvd-tritanopia) .filter-switcher-btn {
    color: var(--color-Primary-600) !important;
    border: none !important;
    background: transparent !important;
  }

  :global(body.a11y-theme-protanopia) .filter-switcher-btn.active,
  :global(body.a11y-theme-deuteranopia) .filter-switcher-btn.active,
  :global(body.a11y-theme-tritanopia) .filter-switcher-btn.active,
  :global(body.a11y-cvd-protanopia) .filter-switcher-btn.active,
  :global(body.a11y-cvd-deuteranopia) .filter-switcher-btn.active,
  :global(body.a11y-cvd-tritanopia) .filter-switcher-btn.active {
    color: #ffffff !important;
    border: none !important;
    background: transparent !important;
  }

  :global(body.a11y-theme-protanopia) .filter-switcher-nav::before,
  :global(body.a11y-theme-deuteranopia) .filter-switcher-nav::before,
  :global(body.a11y-theme-tritanopia) .filter-switcher-nav::before,
  :global(body.a11y-cvd-protanopia) .filter-switcher-nav::before,
  :global(body.a11y-cvd-deuteranopia) .filter-switcher-nav::before,
  :global(body.a11y-cvd-tritanopia) .filter-switcher-nav::before {
    background: var(--color-Primary-600) !important;
  }

  /* Mobile: Active button background */
  @media (max-width: 768px) {
    :global(body.a11y-theme-dark) .filter-switcher-btn.active,
    :global(body.a11y-theme-high-contrast) .filter-switcher-btn.active {
      background: var(--a11y-hc-accent, var(--a11y-dark-accent, var(--color-Primary-500))) !important;
    }

    :global(body.a11y-theme-cream) .filter-switcher-btn.active {
      background: var(--a11y-cream-accent) !important;
    }

    :global(body.a11y-theme-monochrome) .filter-switcher-btn.active,
    :global(body.a11y-cvd-monochrome) .filter-switcher-btn.active {
      background: #333333 !important;
    }

    :global(body.a11y-theme-protanopia) .filter-switcher-btn.active,
    :global(body.a11y-theme-deuteranopia) .filter-switcher-btn.active,
    :global(body.a11y-theme-tritanopia) .filter-switcher-btn.active,
    :global(body.a11y-cvd-protanopia) .filter-switcher-btn.active,
    :global(body.a11y-cvd-deuteranopia) .filter-switcher-btn.active,
    :global(body.a11y-cvd-tritanopia) .filter-switcher-btn.active {
      background: var(--color-Primary-600) !important;
    }
  }
</style>
