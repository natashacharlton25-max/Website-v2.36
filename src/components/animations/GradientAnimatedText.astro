---
/**
 * GradientAnimatedText - Flowing gradient text animations
 *
 * Features:
 * - Flowing gradient animation on text
 * - 3 variants: fast (always), slow (always), solid (hover-triggered)
 * - Smooth fade-out transition for solid variant
 * - Touch support
 * - Reduced motion support
 *
 * Usage:
 * ```astro
 * <GradientAnimatedText variant="fast">
 *   Flowing Gradient
 * </GradientAnimatedText>
 *
 * <GradientAnimatedText variant="solid" size="lg">
 *   Hover Me
 * </GradientAnimatedText>
 * ```
 */

interface Props {
  /**
   * Animation variant
   * - fast: Always animating (2s loop)
   * - slow: Always animating (8s loop)
   * - solid: Solid color â†’ gradient on hover
   */
  variant?: 'fast' | 'slow' | 'solid';

  /**
   * Text size
   * - sm: 48px (mobile-friendly)
   * - md: 72px (default)
   * - lg: 96px (hero)
   * - xl: 120px (extra large)
   */
  size?: 'sm' | 'md' | 'lg' | 'xl';

  /**
   * Gradient colors (array of hex colors)
   */
  colors?: string[];

  /**
   * Solid color for 'solid' variant (shown before hover)
   */
  solidColor?: string;

  /**
   * Animation duration for fast variant (seconds)
   */
  fastDuration?: number;

  /**
   * Animation duration for slow variant (seconds)
   */
  slowDuration?: number;

  /**
   * Font weight
   */
  fontWeight?: number | string;

  /**
   * HTML tag to render (default: span)
   */
  as?: 'span' | 'h1' | 'h2' | 'h3' | 'h4' | 'p' | 'div';

  /**
   * Additional CSS class
   */
  class?: string;
}

const {
  variant = 'fast',
  size = 'md',
  colors = ['#818cf8', '#ec4899', '#4f46e5', '#db2777', '#818cf8'],
  solidColor = '#4f46e5',
  fastDuration = 2,
  slowDuration = 8,
  fontWeight = 700,
  as: Tag = 'span',
  class: className = ''
} = Astro.props;

const textId = `gradient-text-${Math.random().toString(36).substring(2, 9)}`;
const gradientColors = colors.join(', ');

// Size mapping
const sizeMap = {
  sm: '48px',
  md: '72px',
  lg: '96px',
  xl: '120px'
};
---

<Tag
  class={`gradient-animated-text gradient-animated-text--${variant} gradient-animated-text--${size} ${className}`}
  id={textId}
  data-variant={variant}
  style={`
    --gat-gradient: linear-gradient(90deg, ${gradientColors});
    --gat-solid-color: ${solidColor};
    --gat-fast-duration: ${fastDuration}s;
    --gat-slow-duration: ${slowDuration}s;
    --gat-font-size: ${sizeMap[size]};
    --gat-font-weight: ${fontWeight};
  `}
>
  <slot />
</Tag>

<style>
  /* === Keyframe Animations === */
  @keyframes gradient-flow-fast {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  @keyframes gradient-flow-slow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* === Base Styles === */
  .gradient-animated-text {
    font-size: var(--gat-font-size);
    font-weight: var(--gat-font-weight);
    line-height: 1.2;
    display: inline-block;
  }

  /* === Size Variants === */
  .gradient-animated-text--sm { font-size: 48px; }
  .gradient-animated-text--md { font-size: 72px; }
  .gradient-animated-text--lg { font-size: 96px; }
  .gradient-animated-text--xl { font-size: 120px; }

  /* === Fast Variant (Always Animating) === */
  .gradient-animated-text--fast {
    background: var(--gat-gradient);
    background-size: 300% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-flow-fast var(--gat-fast-duration) ease-in-out infinite;
  }

  /* === Slow Variant (Always Animating) === */
  .gradient-animated-text--slow {
    background: var(--gat-gradient);
    background-size: 300% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-flow-slow var(--gat-slow-duration) ease-in-out infinite;
  }

  /* === Solid Variant (Hover Triggered) === */
  .gradient-animated-text--solid {
    color: var(--gat-solid-color);
    cursor: pointer;
    transition: color 0.3s ease-out;
  }

  .gradient-animated-text--solid.is-animating {
    background: var(--gat-gradient);
    background-size: 300% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-flow-fast var(--gat-fast-duration) ease-in-out infinite;
  }

  .gradient-animated-text--solid.is-fading {
    background: var(--gat-gradient);
    background-size: 300% 100%;
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: gradient-flow-fast var(--gat-fast-duration) ease-in-out infinite;
    opacity: var(--fade-opacity, 1);
    transition: opacity 0.3s ease-out;
  }

  /* === Responsive === */
  @media (max-width: 768px) {
    .gradient-animated-text--sm { font-size: 32px; }
    .gradient-animated-text--md { font-size: 48px; }
    .gradient-animated-text--lg { font-size: 64px; }
    .gradient-animated-text--xl { font-size: 80px; }
  }

  @media (max-width: 480px) {
    .gradient-animated-text--sm { font-size: 24px; }
    .gradient-animated-text--md { font-size: 36px; }
    .gradient-animated-text--lg { font-size: 48px; }
    .gradient-animated-text--xl { font-size: 60px; }
  }

  /* === Accessibility === */
  @media (prefers-reduced-motion: reduce) {
    .gradient-animated-text--fast,
    .gradient-animated-text--slow,
    .gradient-animated-text--solid.is-animating,
    .gradient-animated-text--solid.is-fading {
      animation: none;
      background-position: 50% 50%;
    }
  }
</style>

<script>
  function initGradientText(textElement: HTMLElement) {
    const variant = textElement.dataset.variant;

    // Only add interactivity for solid variant
    if (variant !== 'solid') return;

    let animating = false;
    let fadeFrame: number;

    function startAnimation() {
      if (animating) return;
      animating = true;
      textElement.classList.add('is-animating');
      textElement.classList.remove('is-fading');
    }

    function fadeOut() {
      textElement.classList.remove('is-animating');
      textElement.classList.add('is-fading');
      textElement.style.setProperty('--fade-opacity', '1');

      let fadeOpacity = 1;
      const fadeStep = 0.05;

      function fade() {
        fadeOpacity -= fadeStep;
        if (fadeOpacity > 0) {
          textElement.style.setProperty('--fade-opacity', fadeOpacity.toString());
          fadeFrame = requestAnimationFrame(fade);
        } else {
          textElement.classList.remove('is-fading', 'is-animating');
          textElement.style.removeProperty('--fade-opacity');
          animating = false;
        }
      }
      fade();
    }

    // Desktop hover events
    textElement.addEventListener('mouseenter', startAnimation);
    textElement.addEventListener('mouseleave', fadeOut);

    // Touch support
    textElement.addEventListener('touchstart', () => {
      startAnimation();
      setTimeout(fadeOut, 2000);
    }, { passive: true });
  }

  // Initialize all gradient text elements
  function init() {
    document.querySelectorAll('.gradient-animated-text').forEach(el => {
      initGradientText(el as HTMLElement);
    });
  }

  // Initialize on DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }

  // Re-initialize on Astro page transitions
  document.addEventListener('astro:page-load', init);
</script>
