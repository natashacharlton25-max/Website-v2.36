---
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

interface Props {
  mainImage: ImageMetadata;
  galleryImages?: ImageMetadata[];
  productName: string;
  badge?: string;
  badgeType?: string;
}

const { mainImage, galleryImages = [], productName, badge, badgeType = 'default' } = Astro.props;

// Combine into single array - use galleryImages if available, otherwise use mainImage
const allImages = galleryImages && galleryImages.length > 0
  ? galleryImages
  : [mainImage];

const galleryId = `gallery-${Math.random().toString(36).slice(2, 9)}`;
---

<div class="isotope-gallery-wrapper">
  <div class="isotope-gallery" id={galleryId}>
    {allImages.map((img, index) => (
      <div class={`gallery-item ${index === 0 ? 'is-expanded' : ''}`} data-index={index}>
        <Image src={img} alt={`${productName} image ${index + 1}`} />
        {badge && (
          <div class={`product-badge badge-${badgeType}`} style={index === 0 ? '' : 'display: none;'}>{badge}</div>
        )}
      </div>
    ))}
  </div>
</div>

<script>
  import gsap from 'gsap';
  import { Flip } from 'gsap/Flip';
  // @ts-ignore
  import imagesLoaded from 'imagesloaded';

  gsap.registerPlugin(Flip);

  function initIsotopeGallery() {
    const galleries = document.querySelectorAll('.isotope-gallery');

    galleries.forEach(galleryElement => {
      const gallery = galleryElement as HTMLElement;
      gallery.classList.add('grid--loading');

      // Wait for images to load
      // @ts-ignore
      imagesLoaded(gallery, () => {
        gallery.classList.remove('grid--loading');
      });

      // Handle item clicks using event delegation (survives DOM manipulation)
      gallery.addEventListener('click', (e) => {
        const clickedItem = (e.target as HTMLElement).closest('.gallery-item');
        if (!clickedItem) return;

        const wasExpanded = clickedItem.classList.contains('is-expanded');

        // Don't do anything if clicking already expanded item
        if (wasExpanded) return;

        // Get current items and find clicked index
        const items = gallery.querySelectorAll('.gallery-item');
        const itemsArray = Array.from(items);
        const clickedIndex = itemsArray.indexOf(clickedItem);

        if (clickedIndex === -1) return;

        // Capture state before any changes
        const state = Flip.getState(items);

        // Circular carousel rotation pattern:
        // When clicking position 2: 2→1, 1→2, 2→3 shifts down, 3→4 shifts down
        // When clicking position 3: 3→1, 1→2, 2→3, 3→4 shifts down
        // When clicking position 4: 4→1, 1→2, 2→3, 3→4 (full rotation)

        const newOrder = new Array(itemsArray.length);

        if (clickedIndex === 1) {
          // Click position 2 (top right thumbnail)
          // Pattern: 2→1, 3→2, 4→3, 1→4
          newOrder[0] = itemsArray[1]; // pos 2 → pos 1 (main)
          newOrder[1] = itemsArray[2]; // pos 3 → pos 2 (top right)
          newOrder[2] = itemsArray[3]; // pos 4 → pos 3 (middle right)
          newOrder[3] = itemsArray[0]; // pos 1 → pos 4 (bottom right)
        } else if (clickedIndex === 2) {
          // Click position 3 (middle right thumbnail)
          // Pattern: 3→1, 4→2, 1→3, 2→4
          newOrder[0] = itemsArray[2]; // pos 3 → pos 1 (main)
          newOrder[1] = itemsArray[3]; // pos 4 → pos 2 (top right)
          newOrder[2] = itemsArray[0]; // pos 1 → pos 3 (middle right)
          newOrder[3] = itemsArray[1]; // pos 2 → pos 4 (bottom right)
        } else if (clickedIndex === 3) {
          // Click position 4 (bottom right thumbnail)
          // Pattern: 4→1, 1→2, 2→3, 3→4 (full rotation)
          newOrder[0] = itemsArray[3]; // pos 4 → pos 1 (main)
          newOrder[1] = itemsArray[0]; // pos 1 → pos 2 (top right)
          newOrder[2] = itemsArray[1]; // pos 2 → pos 3 (middle right)
          newOrder[3] = itemsArray[2]; // pos 3 → pos 4 (bottom right)
        } else {
          // Clicking position 1 (already expanded) - do nothing
          return;
        }

        // Clear and rebuild DOM in new order
        gallery.innerHTML = '';
        newOrder.forEach(el => gallery.appendChild(el));

        // Re-query items after DOM manipulation
        const updatedItems = gallery.querySelectorAll('.gallery-item');

        // Set first item as expanded
        updatedItems.forEach((i, idx) => {
          i.classList.remove('is-expanded');
          if (idx === 0) {
            i.classList.add('is-expanded');
          }
        });

        // Handle badge visibility
        updatedItems.forEach((i) => {
          const badge = i.querySelector('.product-badge') as HTMLElement;
          if (badge) {
            badge.style.display = i.classList.contains('is-expanded') ? 'block' : 'none';
          }
        });

        // Animate all items smoothly between their old and new positions
        Flip.from(state, {
          duration: 0.6,
          ease: 'power2.inOut',
          absolute: true,
          scale: true,
          simple: true
        });
      });
    });
  }

  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initIsotopeGallery);
  } else {
    initIsotopeGallery();
  }
</script>

<style>
  .isotope-gallery-wrapper {
    width: 100%;
  }

  .isotope-gallery {
    position: relative;
    width: 100%;
    opacity: 1;
    transition: opacity 0.3s ease-in-out;
    display: grid;
    grid-template-columns: 3fr 1fr;
    grid-auto-rows: minmax(150px, auto);
    gap: var(--space-md);
    align-items: start;
  }

  .isotope-gallery.grid--loading {
    opacity: 0;
  }

  .gallery-item {
    cursor: pointer;
    border-radius: var(--border-radius-lg);
    overflow: hidden;
    background-color: var(--color-Background-100);
    border: 2px solid var(--color-Neutral-200);
    position: relative;
  }

  /* Expanded item - left side, spans multiple rows */
  .gallery-item.is-expanded {
    grid-column: 1;
    grid-row: 1 / span 3;
    border-color: var(--color-Primary-600);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    min-height: 500px;
  }

  .gallery-item.is-expanded img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    display: block;
  }

  /* Thumbnails - right side, stacked vertically, smaller height */
  .gallery-item:not(.is-expanded) {
    grid-column: 2;
    max-height: 200px;
  }

  .gallery-item:not(.is-expanded) img {
    width: 100%;
    height: auto;
    max-height: 200px;
    object-fit: contain;
    display: block;
  }

  .gallery-item:hover {
    border-color: var(--color-Primary-400);
  }

  .product-badge {
    position: absolute;
    top: var(--space-md);
    right: var(--space-md);
    padding: var(--space-xs) var(--space-md);
    background-color: var(--color-Primary-600);
    color: white;
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--border-radius-md);
    pointer-events: none;
    z-index: 1;
  }

  .badge-worksheet {
    background-color: var(--color-Primary-600);
  }

  .badge-guide {
    background-color: var(--color-Secondary-600);
  }

  .badge-toolkit {
    background-color: var(--color-Accent-600);
  }

  /* Responsive: Switch to stacked layout on tablet */
  @media (max-width: 1023px) {
    .isotope-gallery {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
    }

    .gallery-item.is-expanded {
      grid-column: 1;
      grid-row: auto;
    }

    .gallery-item:not(.is-expanded) {
      grid-column: 1;
    }
  }

  /* Responsive: 1 column on mobile */
  @media (max-width: 767px) {
    .isotope-gallery {
      grid-template-columns: 1fr;
      grid-template-rows: auto;
    }

    .gallery-item.is-expanded {
      grid-column: 1;
      grid-row: auto;
    }

    .gallery-item:not(.is-expanded) {
      grid-column: 1;
    }
  }
</style>
