---
/**
 * Mini Cart Dropdown - Clean Order Summary Style
 */
---

<div class="mini-cart" id="mini-cart">
  <div class="mini-cart__header">
    <span class="mini-cart__title">ORDER</span>
    <a href="/cart" class="mini-cart__edit">EDIT CART</a>
  </div>

  <div class="mini-cart__items" id="mini-cart-items">
    <!-- Items rendered by JS -->
  </div>

  <div class="mini-cart__summary" id="mini-cart-summary">
    <div class="mini-cart__row">
      <span>Subtotal</span>
      <span id="mini-cart-subtotal">Free</span>
    </div>
    <div class="mini-cart__row">
      <span>Shipping</span>
      <span id="mini-cart-shipping">Instant</span>
    </div>
    <div class="mini-cart__row mini-cart__row--total">
      <span>Total</span>
      <span id="mini-cart-total">Free</span>
    </div>
  </div>

  <a href="/cart" class="mini-cart__checkout">PROCEED TO CHECKOUT</a>
</div>

<style is:global>
  .mini-cart {
    position: fixed;
    top: 80px;
    right: var(--space-lg);
    width: 320px;
    background: var(--color-Background-50);
    border-radius: var(--border-radius-lg);
    box-shadow: var(--shadow-2xl);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all var(--transition-base);
    z-index: 99999;
    overflow: hidden;
  }

  .mini-cart.visible {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .mini-cart__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg) var(--space-lg);
    border-bottom: 1px solid var(--color-Background-200);
  }

  .mini-cart__title {
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    font-family: var(--font-heading);
    color: var(--color-Text-800);
    letter-spacing: 0.5px;
  }

  .mini-cart__edit {
    font-size: var(--text-xs);
    color: var(--color-Text-400);
    text-decoration: none;
    letter-spacing: 0.3px;
    transition: color var(--transition-fast);
  }

  .mini-cart__edit:hover {
    color: var(--color-Primary-500);
  }

  .mini-cart__items {
    max-height: 280px;
    overflow-y: auto;
  }

  .mini-cart__item {
    display: flex;
    align-items: center;
    padding: var(--space-md) var(--space-lg);
    border-bottom: 1px solid var(--color-Background-100);
    gap: var(--space-md);
  }

  .mini-cart__item:last-child {
    border-bottom: none;
  }

  .mini-cart__item-image {
    width: 50px;
    height: 50px;
    border-radius: var(--border-radius);
    overflow: hidden;
    flex-shrink: 0;
    background: var(--color-Background-100);
  }

  .mini-cart__item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .mini-cart__item-info {
    flex: 1;
    min-width: 0;
  }

  .mini-cart__item-name {
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    font-family: var(--font-body);
    color: var(--color-Text-800);
    margin: 0 0 2px 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .mini-cart__item-meta {
    font-size: var(--text-xs);
    color: var(--color-Text-400);
  }

  .mini-cart__remove {
    width: 28px;
    height: 28px;
    border: none;
    background: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--color-Text-400);
    border-radius: var(--border-radius-sm);
    transition: all var(--transition-fast);
    flex-shrink: 0;
  }

  .mini-cart__remove:hover {
    background: var(--color-Secondary-50);
    color: var(--color-Secondary-500);
  }

  .mini-cart__remove svg {
    width: 16px;
    height: 16px;
  }

  .mini-cart__summary {
    padding: var(--space-lg);
    background: var(--color-Background-100);
    border-top: 1px solid var(--color-Background-200);
  }

  .mini-cart__row {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    font-family: var(--font-body);
    color: var(--color-Text-500);
    padding: var(--space-xs) 0;
  }

  .mini-cart__row--total {
    font-weight: var(--font-bold);
    color: var(--color-Text-800);
    font-size: var(--text-base);
    padding-top: var(--space-sm);
    margin-top: var(--space-xs);
    border-top: 1px solid var(--color-Background-200);
  }

  .mini-cart__checkout {
    display: block;
    width: 100%;
    padding: var(--space-md);
    background: var(--color-Primary-500);
    color: white;
    text-align: center;
    text-decoration: none;
    font-size: var(--text-sm);
    font-weight: var(--font-bold);
    font-family: var(--font-body);
    letter-spacing: 0.5px;
    transition: background var(--transition-fast);
  }

  .mini-cart__checkout:hover {
    background: var(--color-Primary-600);
  }

  .mini-cart__empty {
    padding: var(--space-4xl) var(--space-lg);
    text-align: center;
    color: var(--color-Text-400);
  }

  .mini-cart__empty svg {
    width: 48px;
    height: 48px;
    margin-bottom: var(--space-md);
    opacity: 0.5;
  }

  .mini-cart__empty p {
    margin: 0;
    font-size: var(--text-sm);
    font-family: var(--font-body);
  }

  @media (max-width: 400px) {
    .mini-cart {
      right: var(--space-md);
      left: var(--space-md);
      width: auto;
    }
  }
</style>

<script>
  interface CartItem {
    id: string;
    name: string;
    price: number;
    image?: string;
    quantity?: number;
  }

  let cartItems: CartItem[] = [];
  const SHIPPING = 0;

  const mcItems = document.getElementById('mini-cart-items');
  const mcSubtotal = document.getElementById('mini-cart-subtotal');
  const mcShipping = document.getElementById('mini-cart-shipping');
  const mcTotal = document.getElementById('mini-cart-total');
  const mcSummary = document.getElementById('mini-cart-summary');

  function loadFromStorage() {
    const saved = localStorage.getItem('cartItems');
    if (saved) {
      cartItems = JSON.parse(saved);
    }
  }

  function saveToStorage() {
    localStorage.setItem('cartItems', JSON.stringify(cartItems));
    document.dispatchEvent(new CustomEvent('cart:updated', {
      detail: { count: cartItems.length }
    }));
  }

  function render() {
    if (!mcItems) return;

    if (cartItems.length === 0) {
      mcItems.innerHTML = `
        <div class="mini-cart__empty">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
            <path d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/>
          </svg>
          <p>Your cart is empty</p>
        </div>
      `;
      if (mcSummary) mcSummary.style.display = 'none';
      return;
    }

    if (mcSummary) mcSummary.style.display = 'block';

    mcItems.innerHTML = cartItems.map((item, idx) => `
      <div class="mini-cart__item">
        <div class="mini-cart__item-image">
          <img src="${item.image || ''}" alt="${item.name}" onerror="if(!this.dataset.fallback){this.dataset.fallback='1';this.src='/MiniKart/MiniKart-Fallback-'+Math.ceil(Math.random()*10)+'.png';}">
        </div>
        <div class="mini-cart__item-info">
          <div class="mini-cart__item-name">${item.name}</div>
          <div class="mini-cart__item-meta">${item.price === 0 ? 'Free' : `$${item.price.toFixed(2)}`}</div>
        </div>
        <button class="mini-cart__remove" data-idx="${idx}" title="Remove from cart">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    `).join('');

    // Update totals
    const subtotal = cartItems.reduce((sum, i) => sum + ((i.quantity || 1) * i.price), 0);
    const total = subtotal + SHIPPING;

    if (mcSubtotal) mcSubtotal.textContent = subtotal === 0 ? 'Free' : `$${subtotal.toFixed(2)}`;
    if (mcShipping) mcShipping.textContent = 'Instant';
    if (mcTotal) mcTotal.textContent = total === 0 ? 'Free' : `$${total.toFixed(2)}`;

    // Attach remove events
    mcItems.querySelectorAll('.mini-cart__remove').forEach(btn => {
      btn.addEventListener('click', (e) => {
        const el = e.currentTarget as HTMLElement;
        const idx = parseInt(el.dataset.idx || '0');
        cartItems.splice(idx, 1);
        saveToStorage();
        render();
      });
    });
  }

  function addToCart(item: CartItem) {
    const existing = cartItems.findIndex(i => i.id === item.id);
    if (existing >= 0) {
      // Item already in cart, show toast
      if (typeof (window as any).showToast === 'function') {
        (window as any).showToast({
          message: `${item.name} is already in your cart!`,
          theme: 'professional',
          animation: 'flip',
          lottieUrl: '/Icons/Animated Icons/Basket Icons/lottie-basket-loop-cycle.json'
        });
      }
      return;
    } else {
      cartItems.push({ ...item, quantity: 1 });
    }
    saveToStorage();
    render();

    if (typeof (window as any).showToast === 'function') {
      (window as any).showToast({
        message: `${item.name} added to cart!`,
        theme: 'professional',
        animation: 'flip',
        lottieUrl: '/Icons/Animated Icons/Basket Icons/lottie-basket-morph-fill.json'
      });
    }
  }

  // Make global
  (window as any).addToCart = addToCart;
  (window as any).cartItems = cartItems;

  // Close on outside click
  document.addEventListener('click', (e) => {
    const miniCart = document.getElementById('mini-cart');
    const cartIcon = document.getElementById('cart-icon');
    if (!miniCart || !cartIcon) return;

    if (!miniCart.contains(e.target as Node) && !cartIcon.contains(e.target as Node)) {
      miniCart.classList.remove('visible');
    }
  });

  // Init
  loadFromStorage();
  render();

  // Sync cart count on initial load
  if (cartItems.length > 0) {
    document.dispatchEvent(new CustomEvent('cart:updated', {
      detail: { count: cartItems.length }
    }));
  }
</script>
