---
// Shopping Cart Component for E-commerce
// Manages cart state, displays items, calculates totals
import Button from '../Button/Button.astro';
---

<div class="shopping-cart__overlay" id="cartOverlay">
  <div class="shopping-cart__panel" id="cartPanel">
    <!-- Cart Header -->
    <div class="shopping-cart__header">
      <h2 class="shopping-cart__title">Shopping Cart</h2>
      <button class="shopping-cart__close" id="cartClose" aria-label="Close cart">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>

    <!-- Cart Items -->
    <div class="shopping-cart__items" id="cartItems">
      <!-- Cart items will be dynamically inserted here -->
      <div class="shopping-cart__empty" id="cartEmpty">
        <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="9" cy="21" r="1"/>
          <circle cx="20" cy="21" r="1"/>
          <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
        </svg>
        <p>Your cart is empty</p>
        <a href="/assets" class="btn btn-primary">Browse Products</a>
      </div>
    </div>

    <!-- Cart Footer -->
    <div class="shopping-cart__footer" id="cartFooter" style="display: none;">
      <!-- Subtotal -->
      <div class="shopping-cart__subtotal">
        <span>Subtotal:</span>
        <strong id="cartSubtotal">$0.00</strong>
      </div>

      <!-- Checkout Button -->
      <a href="/checkout" class="btn btn-primary w-full">
        Proceed to Checkout
      </a>

      <!-- Continue Shopping -->
      <div class="w-full" style="margin: 0;">
        <Button variant="ghost" size="md" className="w-full" id="continueShopping">
          Continue Shopping
        </Button>
      </div>
    </div>
  </div>
</div>

<!-- Cart Toggle Button (Fixed) -->
<button class="shopping-cart__toggle" id="cartToggle" aria-label="Open shopping cart">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <circle cx="9" cy="21" r="1"/>
    <circle cx="20" cy="21" r="1"/>
    <path d="M1 1h4l2.68 13.39a2 2 0 002 1.61h9.72a2 2 0 002-1.61L23 6H6"/>
  </svg>
  <span class="shopping-cart__count" id="cartCount">0</span>
</button>

<style>
  /* Toggle Button */
  .shopping-cart__toggle {
    position: fixed;
    bottom: var(--space-lg);
    right: var(--space-lg);
    width: 56px;
    height: 56px;
    background: var(--color-Primary-500);
    color: white;
    border: none;
    border-radius: var(--border-radius-full);
    box-shadow: var(--shadow-xl);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: var(--z-fixed);
    transition: all var(--transition-base);
  }

  .shopping-cart__toggle:hover {
    transform: scale(1.05);
    box-shadow: var(--shadow-2xl);
  }

  .shopping-cart__count {
    position: absolute;
    top: -4px;
    right: -4px;
    background: var(--color-Danger);
    color: white;
    font-size: var(--text-xs);
    font-weight: var(--font-bold);
    font-family: var(--font-body);
    min-width: 20px;
    height: 20px;
    border-radius: var(--border-radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0 var(--space-xs);
  }

  .shopping-cart__count:empty {
    display: none;
  }

  /* Overlay */
  .shopping-cart__overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: var(--z-modal);
    opacity: 0;
    visibility: hidden;
    transition: all var(--transition-base);
  }

  .shopping-cart__overlay.active {
    opacity: 1;
    visibility: visible;
  }

  /* Panel */
  .shopping-cart__panel {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    max-width: 400px;
    height: 100vh;
    background: var(--color-Background-50);
    box-shadow: var(--shadow-2xl);
    display: flex;
    flex-direction: column;
    transform: translateX(100%);
    transition: transform var(--transition-base);
  }

  .shopping-cart__overlay.active .shopping-cart__panel {
    transform: translateX(0);
  }

  /* Header */
  .shopping-cart__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-lg);
    border-bottom: 1px solid var(--color-Neutral-200);
  }

  .shopping-cart__title {
    font-size: var(--text-xl);
    font-weight: var(--font-bold);
    font-family: var(--font-heading);
    color: var(--color-Text-700);
    margin: 0;
  }

  .shopping-cart__close {
    background: transparent;
    border: none;
    color: var(--color-Text-500);
    cursor: pointer;
    padding: var(--space-xs);
    transition: color var(--transition-fast);
  }

  .shopping-cart__close:hover {
    color: var(--color-Text-700);
  }

  /* Items */
  .shopping-cart__items {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-lg);
  }

  .shopping-cart__empty {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: var(--space-4xl) var(--space-lg);
    color: var(--color-Text-500);
  }

  .shopping-cart__empty svg {
    margin-bottom: var(--space-lg);
    opacity: 0.5;
  }

  .shopping-cart__empty p {
    margin-bottom: var(--space-lg);
    font-size: var(--text-lg);
    font-family: var(--font-body);
  }

  .shopping-cart__item {
    display: flex;
    gap: var(--space-md);
    padding: var(--space-md);
    border: 1px solid var(--color-Neutral-200);
    border-radius: var(--border-radius);
    margin-bottom: var(--space-md);
  }

  .shopping-cart__item-image {
    width: 80px;
    height: 80px;
    border-radius: var(--border-radius);
    overflow: hidden;
    flex-shrink: 0;
    background: var(--color-Neutral-100);
  }

  .shopping-cart__item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .shopping-cart__item-details {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .shopping-cart__item-name {
    font-weight: var(--font-semibold);
    font-size: var(--text-base);
    font-family: var(--font-body);
    color: var(--color-Text-700);
    margin: 0;
  }

  .shopping-cart__item-price {
    color: var(--color-Primary-500);
    font-weight: var(--font-bold);
  }

  .shopping-cart__item-quantity {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-top: auto;
  }

  .shopping-cart__quantity-btn {
    width: 24px;
    height: 24px;
    background: var(--color-Neutral-200);
    border: none;
    border-radius: var(--border-radius-sm);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background var(--transition-fast);
  }

  .shopping-cart__quantity-btn:hover {
    background: var(--color-Neutral-300);
  }

  .shopping-cart__quantity-value {
    font-weight: var(--font-medium);
    min-width: 30px;
    text-align: center;
  }

  .shopping-cart__item-remove {
    background: transparent;
    border: none;
    color: var(--color-Danger);
    cursor: pointer;
    padding: var(--space-xs);
    margin-left: auto;
    align-self: flex-start;
    transition: color var(--transition-fast);
  }

  .shopping-cart__item-remove:hover {
    color: var(--color-Danger);
    opacity: 0.8;
  }

  /* Footer */
  .shopping-cart__footer {
    border-top: 1px solid var(--color-Neutral-200);
    padding: var(--space-lg);
    display: flex;
    flex-direction: column;
    gap: var(--space-md);
  }

  .shopping-cart__subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: var(--text-lg);
    font-family: var(--font-body);
    padding: var(--space-md) 0;
  }

  .shopping-cart__subtotal strong {
    color: var(--color-Primary-500);
    font-size: var(--text-2xl);
  }

  @media (max-width: 767px) {
    .shopping-cart__panel {
      max-width: 100%;
    }
  }
</style>

<script>
  // Cart State Management
  interface CartItem {
    id: string;
    name: string;
    price: number;
    image: string;
    quantity: number;
  }

  class ShoppingCart {
    private items: CartItem[] = [];
    private readonly STORAGE_KEY = 'shopping_cart';

    constructor() {
      this.loadFromStorage();
      this.initializeEventListeners();
      this.renderCart();
    }

    private loadFromStorage() {
      const stored = localStorage.getItem(this.STORAGE_KEY);
      if (stored) {
        try {
          this.items = JSON.parse(stored);
        } catch (e) {
          this.items = [];
        }
      }
    }

    private saveToStorage() {
      localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.items));
    }

    private initializeEventListeners() {
      // Open cart
      document.getElementById('cartToggle')?.addEventListener('click', () => {
        this.openCart();
      });

      // Close cart
      document.getElementById('cartClose')?.addEventListener('click', () => {
        this.closeCart();
      });

      // Continue shopping
      document.getElementById('continueShopping')?.addEventListener('click', () => {
        this.closeCart();
      });

      // Close on overlay click
      document.getElementById('cartOverlay')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) {
          this.closeCart();
        }
      });
    }

    openCart() {
      document.getElementById('cartOverlay')?.classList.add('active');
      document.body.style.overflow = 'hidden';
    }

    closeCart() {
      document.getElementById('cartOverlay')?.classList.remove('active');
      document.body.style.overflow = '';
    }

    addItem(item: Omit<CartItem, 'quantity'>) {
      const existingItem = this.items.find(i => i.id === item.id);

      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        this.items.push({ ...item, quantity: 1 });
      }

      this.saveToStorage();
      this.renderCart();
      this.openCart();

      // Show toast notification
      (window as any).showToast?.({
        message: `${item.name} added to cart`,
        type: 'success'
      });
    }

    removeItem(id: string) {
      this.items = this.items.filter(item => item.id !== id);
      this.saveToStorage();
      this.renderCart();

      (window as any).showToast?.({
        message: 'Item removed from cart',
        type: 'info'
      });
    }

    updateQuantity(id: string, quantity: number) {
      const item = this.items.find(i => i.id === id);
      if (item) {
        item.quantity = Math.max(1, quantity);
        this.saveToStorage();
        this.renderCart();
      }
    }

    getTotal(): number {
      return this.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    }

    getItemCount(): number {
      return this.items.reduce((sum, item) => sum + item.quantity, 0);
    }

    renderCart() {
      const cartItemsContainer = document.getElementById('cartItems');
      const cartEmpty = document.getElementById('cartEmpty');
      const cartFooter = document.getElementById('cartFooter');
      const cartCount = document.getElementById('cartCount');
      const cartSubtotal = document.getElementById('cartSubtotal');

      if (!cartItemsContainer) return;

      // Update cart count badge
      const count = this.getItemCount();
      if (cartCount) {
        cartCount.textContent = count > 0 ? count.toString() : '';
      }

      if (this.items.length === 0) {
        cartEmpty?.style.setProperty('display', 'flex');
        cartFooter?.style.setProperty('display', 'none');
        return;
      }

      cartEmpty?.style.setProperty('display', 'none');
      cartFooter?.style.setProperty('display', 'flex');

      // Render cart items
      const itemsHTML = this.items.map(item => `
        <div class="shopping-cart__item">
          <div class="shopping-cart__item-image">
            <img src="${item.image}" alt="${item.name}" />
          </div>
          <div class="shopping-cart__item-details">
            <h3 class="shopping-cart__item-name">${item.name}</h3>
            <div class="shopping-cart__item-price">$${item.price.toFixed(2)}</div>
            <div class="shopping-cart__item-quantity">
              <button class="shopping-cart__quantity-btn" onclick="cart.updateQuantity('${item.id}', ${item.quantity - 1})">
                âˆ’
              </button>
              <span class="shopping-cart__quantity-value">${item.quantity}</span>
              <button class="shopping-cart__quantity-btn" onclick="cart.updateQuantity('${item.id}', ${item.quantity + 1})">
                +
              </button>
            </div>
          </div>
          <button class="shopping-cart__item-remove" onclick="cart.removeItem('${item.id}')" aria-label="Remove item">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"/>
              <line x1="6" y1="6" x2="18" y2="18"/>
            </svg>
          </button>
        </div>
      `).join('');

      // Find or create items wrapper
      let itemsWrapper = cartItemsContainer.querySelector('.shopping-cart__items-wrapper') as HTMLElement;
      if (!itemsWrapper) {
        itemsWrapper = document.createElement('div');
        itemsWrapper.className = 'shopping-cart__items-wrapper';
        cartItemsContainer.appendChild(itemsWrapper);
      }

      itemsWrapper.innerHTML = itemsHTML;

      // Update subtotal
      if (cartSubtotal) {
        cartSubtotal.textContent = `$${this.getTotal().toFixed(2)}`;
      }
    }

    getItems(): CartItem[] {
      return this.items;
    }

    clearCart() {
      this.items = [];
      this.saveToStorage();
      this.renderCart();
    }
  }

  // Initialize cart and make it globally accessible
  const cart = new ShoppingCart();
  (window as any).cart = cart;
</script>
