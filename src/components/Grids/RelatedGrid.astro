---
/**
 * RelatedGrid - Unified component for displaying related content
 *
 * Consolidates SuggestedPostsGrid, RelatedProductsGrid, and LinkedAssetsGrid
 * into a single flexible component with content-type-specific card rendering
 *
 * Props:
 * @param items - Array of content items to display
 * @param contentType - Type of content: 'posts', 'products', 'resources'
 * @param title - Section title
 * @param basePath - Base URL path for links (used with slug)
 * @param columns - Grid columns: 'auto' (default), '2', '3', '4'
 * @param cardStyle - Card style: 'vertical' (default), 'horizontal', 'minimal'
 * @param background - Background: 'default', 'light', 'none'
 * @param containerSize - Container width: '6xl' (default), '7xl', '4xl'
 */
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import Badge from '../Badge/Badge.astro';

// Unified item interface - maps different content types
interface RelatedItem {
  // Common fields
  slug?: string;
  url?: string;
  title: string;
  description?: string;
  // For posts
  category?: string;
  publishDate?: string;
  cardImage?: ImageMetadata;
  // For products
  name?: string;
  // For resources
  type?: string;
}

type ContentType = 'posts' | 'products' | 'resources';
type ColumnOption = 'auto' | '2' | '3' | '4';
type CardStyle = 'vertical' | 'horizontal' | 'minimal';
type BackgroundOption = 'default' | 'light' | 'none';
type ContainerSize = '4xl' | '6xl' | '7xl';

interface Props {
  items: RelatedItem[];
  contentType?: ContentType;
  title?: string;
  basePath?: string;
  columns?: ColumnOption;
  cardStyle?: CardStyle;
  background?: BackgroundOption;
  containerSize?: ContainerSize;
  class?: string;
}

const {
  items,
  contentType = 'posts',
  title = 'Related Content',
  basePath = '',
  columns = 'auto',
  cardStyle = 'vertical',
  background = 'default',
  containerSize = '6xl',
  class: className
} = Astro.props;

if (!items || items.length === 0) return null;

// Get item URL
const getItemUrl = (item: RelatedItem): string => {
  if (item.url) return item.url;
  if (item.slug && basePath) return `${basePath}/${item.slug}`;
  return '#';
};

// Get item title (handles name vs title)
const getItemTitle = (item: RelatedItem): string => {
  return item.name || item.title;
};

// Get badge/category text
const getItemCategory = (item: RelatedItem): string => {
  return item.category || item.type || '';
};

// Classes
const sectionClasses = [
  'related-grid-section',
  `related-grid-section--bg-${background}`,
  className
].filter(Boolean);

const gridClasses = [
  'related-grid',
  `related-grid--cols-${columns}`,
  `related-grid--${cardStyle}`
];
---

<section class:list={sectionClasses}>
  <div class={`container container-${containerSize}`}>
    <h2 class="related-grid__title">{title}</h2>
    <div class:list={gridClasses}>
      {items.map(item => (
        <a href={getItemUrl(item)} class={`related-card related-card--${cardStyle}`}>
          {/* Image - for posts and products with cardImage */}
          {item.cardImage && cardStyle !== 'minimal' && (
            <div class="related-card__image">
              <Image
                src={item.cardImage}
                alt={getItemTitle(item)}
                width={cardStyle === 'horizontal' ? 120 : 400}
                height={cardStyle === 'horizontal' ? 120 : 225}
              />
            </div>
          )}

          <div class="related-card__content">
            {/* Category/Type badge */}
            {getItemCategory(item) && (
              <Badge
                type="default"
                label={getItemCategory(item)}
                size="sm"
                variant={cardStyle === 'minimal' ? 'ghost' : 'soft'}
                shape="pill"
              />
            )}

            {/* Title */}
            <h3 class="related-card__title">{getItemTitle(item)}</h3>

            {/* Description */}
            {item.description && (
              <p class="related-card__description">{item.description}</p>
            )}

            {/* Date - for posts */}
            {item.publishDate && contentType === 'posts' && (
              <span class="related-card__date">{item.publishDate}</span>
            )}

            {/* Arrow indicator for horizontal/minimal */}
            {(cardStyle === 'horizontal' || cardStyle === 'minimal') && (
              <span class="related-card__arrow" aria-hidden="true">â†’</span>
            )}
          </div>
        </a>
      ))}
    </div>
  </div>
</section>

<style>
  /* ========== SECTION STYLES ========== */
  /* Box model */
  .related-grid-section {
    padding: var(--space-4xl) 0;
  }

  /* Visual - Background modifiers */
  .related-grid-section--bg-default {
    background: var(--color-Background-50);
  }

  .related-grid-section--bg-light {
    background: var(--color-Background-100);
  }

  .related-grid-section--bg-none {
    background: transparent;
  }

  /* ========== TITLE ========== */
  .related-grid__title {
    margin-bottom: var(--space-2xl);
    text-align: center;
  }

  /* ========== GRID LAYOUT ========== */
  .related-grid {
    display: grid;
    gap: var(--space-xl);
  }

  /* Column modifiers */
  .related-grid--cols-auto {
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }

  .related-grid--cols-2 {
    grid-template-columns: repeat(2, 1fr);
  }

  .related-grid--cols-3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .related-grid--cols-4 {
    grid-template-columns: repeat(4, 1fr);
  }

  /* ========== CARD BASE ========== */
  .related-card {
    display: flex;
    overflow: hidden;
    text-decoration: none;
    border-radius: var(--radius-lg);
    background: var(--color-Neutral-50);
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-base), box-shadow var(--transition-base);
  }

  .related-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
  }

  .related-card:focus-visible {
    outline: 2px solid var(--color-Primary-600);
    outline-offset: 2px;
  }

  /* ========== CARD STYLE: VERTICAL ========== */
  .related-card--vertical {
    flex-direction: column;
  }

  .related-card--vertical .related-card__image {
    aspect-ratio: 16/9;
    overflow: hidden;
  }

  .related-card--vertical .related-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--transition-base);
  }

  .related-card--vertical:hover .related-card__image img {
    transform: scale(1.05);
  }

  .related-card--vertical .related-card__content {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: var(--space-xl);
  }

  /* ========== CARD STYLE: HORIZONTAL ========== */
  .related-card--horizontal {
    flex-direction: row;
    gap: var(--space-md);
    padding: var(--space-lg);
  }

  .related-card--horizontal .related-card__image {
    width: 100px;
    height: 100px;
    flex-shrink: 0;
    border-radius: var(--radius-md);
    overflow: hidden;
  }

  .related-card--horizontal .related-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .related-card--horizontal .related-card__content {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    min-width: 0;
  }

  .related-card--horizontal .related-card__description {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  /* ========== CARD STYLE: MINIMAL ========== */
  .related-card--minimal {
    flex-direction: column;
    padding: var(--space-xl);
    box-shadow: var(--shadow);
  }

  .related-card--minimal:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
  }

  .related-card--minimal .related-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  /* ========== CARD ELEMENTS ========== */
  .related-card__title {
    margin: var(--space-sm) 0;
    line-height: 1.3;
  }

  .related-card__description {
    flex: 1;
    margin: 0;
    color: var(--color-Text-600);
  }

  .related-card__date {
    margin-top: auto;
    color: var(--color-Text-500);
  }

  .related-card__arrow {
    margin-top: auto;
    align-self: flex-end;
    color: var(--color-Primary-600);
    transition: transform var(--transition-base);
  }

  .related-card:hover .related-card__arrow {
    transform: translateX(4px);
  }

  /* ========== RESPONSIVE ========== */
  @media (max-width: 768px) {
    .related-grid--cols-2,
    .related-grid--cols-3,
    .related-grid--cols-4 {
      grid-template-columns: 1fr;
    }

    .related-card--horizontal {
      flex-direction: column;
    }

    .related-card--horizontal .related-card__image {
      width: 100%;
      height: 120px;
    }
  }

  @media (min-width: 769px) and (max-width: 1024px) {
    .related-grid--cols-3,
    .related-grid--cols-4 {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>
